<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão v11.1 - Papelaria & 3D (Online)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-primary: #ffffff; --bg-secondary: #f3f4f6; --bg-tertiary: #f9fafb;
            --text-primary: #1f2937; --text-secondary: #4b5563; --text-tertiary: #6b7280;
            --border-color: #e5e7eb;
            --primary-500: #6366f1; --primary-600: #4f46e5; --primary-700: #4338ca;
            --secondary-500: #10b981; --secondary-600: #059669; --secondary-700: #047857;
            --danger-500: #ef4444; --danger-600: #dc2626;
        }
        [data-theme="dark"] {
            --bg-primary: #1f2937; --bg-secondary: #111827; --bg-tertiary: #374151;
            --text-primary: #f9fafb; --text-secondary: #d1d5db; --text-tertiary: #9ca3af;
            --border-color: #374151;
        }
        [data-theme="ocean"] {
            --bg-primary: #eff6ff; --bg-secondary: #dbeafe; --bg-tertiary: #bfdbfe;
            --text-primary: #1e3a8a; --text-secondary: #1d4ed8; --text-tertiary: #1e40af;
            --border-color: #93c5fd;
            --primary-500: #3b82f6; --primary-600: #2563eb; --primary-700: #1d4ed8;
            --secondary-500: #2dd4bf; --secondary-600: #14b8a6; --secondary-700: #0d9488;
        }
        [data-theme="forest"] {
            --bg-primary: #f0fdf4; --bg-secondary: #dcfce7; --bg-tertiary: #bbf7d0;
            --text-primary: #14532d; --text-secondary: #166534; --text-tertiary: #15803d;
            --border-color: #86efac;
            --primary-500: #84cc16; --primary-600: #65a30d; --primary-700: #4d7c0f;
            --secondary-500: #22c55e; --secondary-600: #16a34a; --secondary-700: #15803d;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-secondary); color: var(--text-primary); }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); z-index: 50; }
        .modal { transition: opacity 0.3s ease, transform 0.3s ease; z-index: 100; background-color: var(--bg-primary); }
        .product-card { background-color: var(--bg-primary); transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
        .tab-button.active, .category-filter-btn.active { border-color: var(--primary-500); color: var(--primary-500); background-color: var(--bg-tertiary); }
        .period-button.active { background-color: var(--primary-500); color: white; }
        .theme-button.active { box-shadow: 0 0 0 3px var(--primary-500); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-600); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .payment-badge { padding: 2px 8px; border-radius: 9999px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; margin-left: 8px; display: inline-block; vertical-align: middle; }
        .badge-dinheiro { background-color: #d1fae5; color: #065f46; }
        .badge-pix { background-color: #cffafe; color: #0e7490; }
        .badge-credito { background-color: #dbeafe; color: #1e40af; }
        #modal-edit-produto, #modal-edit-materiaprima, #modal-edit-cliente, #modal-venda-antiga, #modal-importar-vendas, #modal-edit-categoria { z-index: 110; }
        #modal-venda-detalhes, #modal-cliente-detalhes, #modal-edit-venda, #modal-desconto { z-index: 115; }
        #modal-confirm, #modal-contas-receber { z-index: 120; }
        #modal-receber-pagamento { z-index: 125; }
        #loading-overlay { z-index: 9999; }
        .toggle-checkbox:checked { right: 0; border-color: var(--secondary-500); background-color: white; }
        .toggle-checkbox:checked + .toggle-label { background-color: var(--secondary-500); }
        .toggle-checkbox { transition: all 0.2s ease-in-out; }
        .sidebar-item.active { background-color: var(--primary-600); color: white; }
        @media print {
            body * { visibility: hidden; }
            #receipt-modal, #receipt-modal *, #modal-venda-detalhes, #modal-venda-detalhes * { visibility: visible; }
            #receipt-modal, #modal-venda-detalhes { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none; }
        }
    </style>
</head>
<body class="antialiased">

    <!-- Overlay de Carregamento -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center hidden">
        <div class="loader"></div>
    </div>

    <div class="flex min-h-screen">
        <!-- Barra de Navegação Lateral -->
        <nav id="sidebar" class="w-64 bg-[var(--bg-primary)] shadow-lg p-4 flex flex-col">
            <div class="text-center mb-10">
                <h2 class="text-2xl font-bold text-[var(--primary-600)]">Gestão PDV</h2>
                <p class="text-sm text-[var(--text-secondary)]">Papelaria & 3D</p>
            </div>
            <ul class="space-y-2">
                <li><button data-view="dashboard-view" class="sidebar-item w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-[var(--primary-600)] hover:text-white transition-colors duration-200"><i class="fas fa-tachometer-alt w-5"></i> Dashboard</button></li>
                <li><button data-view="pos-view" class="sidebar-item w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-[var(--primary-600)] hover:text-white transition-colors duration-200"><i class="fas fa-cash-register w-5"></i> Ponto de Venda</button></li>
            </ul>
            <div class="mt-auto">
                <button id="open-settings-modal-btn" class="w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg text-[var(--text-secondary)] hover:bg-gray-200 transition-colors duration-200"><i class="fas fa-cog w-5"></i> Configurações</button>
            </div>
        </nav>

        <!-- Conteúdo Principal -->
        <main class="flex-1 p-4 sm:p-6 lg:p-8 bg-[var(--bg-secondary)] overflow-y-auto">
            
            <!-- Vista do Dashboard (Visível por defeito) -->
            <div id="dashboard-view" class="">
                <header class="mb-8">
                    <h1 class="text-3xl font-bold">Dashboard</h1>
                    <p class="text-[var(--text-secondary)]">Resumo do seu negócio em tempo real.</p>
                </header>

                <!-- Cartões de KPI -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-[var(--bg-primary)] p-6 rounded-lg shadow-md flex items-center gap-4">
                        <div class="bg-green-100 p-3 rounded-full"><i class="fas fa-dollar-sign fa-2x text-green-600"></i></div>
                        <div>
                            <p class="text-sm text-[var(--text-secondary)]">Vendas Hoje</p>
                            <p id="kpi-sales-today" class="text-2xl font-bold">R$ 0,00</p>
                        </div>
                    </div>
                    <div class="bg-[var(--bg-primary)] p-6 rounded-lg shadow-md flex items-center gap-4">
                        <div class="bg-blue-100 p-3 rounded-full"><i class="fas fa-chart-line fa-2x text-blue-600"></i></div>
                        <div>
                            <p class="text-sm text-[var(--text-secondary)]">Lucro Hoje</p>
                            <p id="kpi-profit-today" class="text-2xl font-bold">R$ 0,00</p>
                        </div>
                    </div>
                    <div class="bg-[var(--bg-primary)] p-6 rounded-lg shadow-md flex items-center gap-4">
                        <div class="bg-yellow-100 p-3 rounded-full"><i class="fas fa-exclamation-triangle fa-2x text-yellow-600"></i></div>
                        <div>
                            <p class="text-sm text-[var(--text-secondary)]">Baixo Estoque</p>
                            <p id="kpi-low-stock" class="text-2xl font-bold">0 Produtos</p>
                        </div>
                    </div>
                    <div id="kpi-card-unpaid" class="bg-[var(--bg-primary)] p-6 rounded-lg shadow-md flex items-center gap-4 cursor-pointer hover:shadow-xl transition-shadow">
                        <div class="bg-red-100 p-3 rounded-full"><i class="fas fa-file-invoice-dollar fa-2x text-red-600"></i></div>
                        <div>
                            <p class="text-sm text-[var(--text-secondary)]">Contas a Receber</p>
                            <p id="kpi-unpaid" class="text-2xl font-bold">R$ 0,00</p>
                        </div>
                    </div>
                </div>

                <!-- Ações Rápidas e Atividade Recente -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 bg-[var(--bg-primary)] p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-bold mb-4">Ações Rápidas</h3>
                        <div class="space-y-3">
                            <button data-view="pos-view" class="quick-action-btn w-full text-left bg-[var(--primary-600)] text-white px-4 py-3 rounded-lg shadow hover:bg-[var(--primary-700)] transition flex items-center gap-3"><i class="fas fa-cash-register w-5"></i> Nova Venda</button>
                            <button data-modal-id="modal-produto" class="quick-action-btn open-modal-btn w-full text-left bg-[var(--secondary-600)] text-white px-4 py-3 rounded-lg shadow hover:bg-[var(--secondary-700)] transition flex items-center gap-3"><i class="fas fa-plus-circle w-5"></i> Adicionar Produto</button>
                            <button data-modal-id="modal-contas-receber" class="open-modal-btn w-full text-left bg-orange-500 text-white px-4 py-3 rounded-lg shadow hover:bg-orange-600 transition flex items-center gap-3"><i class="fas fa-file-invoice-dollar w-5"></i> Contas a Receber</button>
                            <button data-modal-id="modal-relatorios" class="quick-action-btn open-modal-btn w-full text-left bg-gray-700 text-white px-4 py-3 rounded-lg shadow hover:bg-gray-800 transition flex items-center gap-3"><i class="fas fa-chart-bar w-5"></i> Ver Relatórios</button>
                        </div>
                    </div>
                    <div class="lg:col-span-2 bg-[var(--bg-primary)] p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-bold mb-4">Atividade Recente</h3>
                        <div id="recent-transactions-list" class="space-y-2">
                            <p class="text-center text-gray-500 mt-4">Nenhuma atividade recente.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vista do Ponto de Venda (Oculta por defeito) -->
            <div id="pos-view" class="hidden h-full">
                 <div class="flex flex-col lg:flex-row h-full">
                    <!-- Coluna Esquerda: Produtos -->
                    <div class="w-full lg:w-3/5 pr-0 lg:pr-4 overflow-y-auto flex flex-col">
                        <header class="mb-4 flex justify-between items-start">
                            <div>
                                <h1 class="text-2xl lg:text-3xl font-bold">Ponto de Venda</h1>
                                <p class="text-[var(--text-secondary)]">Selecione produtos para adicionar ao caixa.</p>
                            </div>
                        </header>
                        <div class="flex flex-wrap gap-2 sm:gap-3 mb-4">
                            <button data-modal-id="modal-produto" class="open-modal-btn bg-[var(--primary-600)] text-white px-3 py-2 text-sm sm:px-4 rounded-lg shadow hover:bg-[var(--primary-700)] transition flex items-center gap-2"><i class="fas fa-plus-circle"></i> Novo Produto</button>
                            <button data-modal-id="modal-categorias" class="open-modal-btn bg-teal-600 text-white px-3 py-2 text-sm sm:px-4 rounded-lg shadow hover:bg-teal-700 transition flex items-center gap-2"><i class="fas fa-tags"></i> Gerir Categorias</button>
                            <button data-modal-id="modal-materiaprima" class="open-modal-btn bg-[var(--secondary-600)] text-white px-3 py-2 text-sm sm:px-4 rounded-lg shadow hover:bg-[var(--secondary-700)] transition flex items-center gap-2"><i class="fas fa-boxes-stacked"></i> Estoque</button>
                            <button data-modal-id="modal-clientes" class="open-modal-btn bg-purple-600 text-white px-3 py-2 text-sm sm:px-4 rounded-lg shadow hover:bg-purple-700 transition flex items-center gap-2"><i class="fas fa-users"></i> Clientes</button>
                            <button data-modal-id="modal-contas-receber" class="open-modal-btn bg-orange-500 text-white px-3 py-2 text-sm sm:px-4 rounded-lg shadow hover:bg-orange-600 transition flex items-center gap-2"><i class="fas fa-file-invoice-dollar"></i> A Receber</button>
                        </div>
                        <div class="mb-4 relative">
                            <input type="text" id="search-product" placeholder="Procurar produto..." class="w-full p-2 pl-10 border rounded-lg bg-[var(--bg-primary)] border-[var(--border-color)]">
                            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-[var(--text-tertiary)]"></i>
                        </div>
                        <div id="category-filters" class="mb-4 flex flex-wrap gap-2"></div>
                        <div id="product-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-3 xl:grid-cols-4 gap-4 flex-grow overflow-y-auto"></div>
                    </div>

                    <!-- Coluna Direita: Caixa -->
                    <div class="w-full lg:w-2/5 bg-[var(--bg-primary)] shadow-lg flex flex-col p-4 sm:p-6 mt-4 lg:mt-0">
                        <div class="flex-grow overflow-y-auto">
                            <h2 class="text-xl lg:text-2xl font-bold mb-4 border-b pb-2 border-[var(--border-color)]">Caixa</h2>
                            <div class="mb-4">
                                <label for="customer-select" class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Associar Cliente (Obrigatório)</label>
                                <select id="customer-select" class="w-full border-[var(--border-color)] rounded-lg shadow-sm focus:ring-[var(--primary-500)] focus:border-[var(--primary-500)] bg-[var(--bg-primary)]"></select>
                            </div>
                            <div id="cart-items" class="space-y-3"></div>
                        </div>
                        <div class="border-t border-[var(--border-color)] pt-4 mt-4 space-y-3">
                            <div class="flex justify-between font-medium text-lg"><span>Subtotal</span><span id="subtotal">R$ 0,00</span></div>
                            <div class="flex justify-between font-medium text-lg text-red-500"><span>Descontos</span><span id="discounts-total">R$ 0,00</span></div>
                            <div class="flex justify-between font-bold text-xl lg:text-2xl text-[var(--primary-600)]"><span>TOTAL</span><span id="total">R$ 0,00</span></div>
                            <button id="apply-general-discount-btn" class="w-full text-[var(--primary-600)] border-2 border-[var(--primary-600)] py-2 rounded-lg hover:bg-[var(--primary-600)] hover:text-white transition-colors duration-200"><i class="fas fa-tags"></i> Aplicar Desconto Geral</button>
                            <button id="checkout-button" class="w-full bg-[var(--primary-600)] text-white py-3 rounded-lg text-lg font-bold hover:bg-[var(--primary-700)]" disabled><i class="fas fa-check-circle"></i> Finalizar Venda</button>
                            <button id="clear-cart-button" class="w-full bg-[var(--danger-500)] text-white py-2 rounded-lg hover:bg-[var(--danger-600)]"><i class="fas fa-times-circle"></i> Cancelar Venda</button>
                        </div>
                    </div>
                 </div>
            </div>
        </main>
    </div>

    <!-- ========= Modais ========= -->

    <!-- Modal: Adicionar/Editar Produto -->
    <div id="modal-produto" class="fixed inset-0 hidden items-center justify-center modal-backdrop"><div class="rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-md mx-4 modal"><h3 class="text-2xl font-bold mb-6">Adicionar Novo Produto</h3><form id="add-product-form" class="space-y-4"><input type="text" name="productName" placeholder="Nome do Produto" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]" required><div class="grid grid-cols-2 gap-4"><input type="number" name="productPrice" placeholder="Preço (R$)" step="0.01" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]" required><input type="number" name="productCost" placeholder="Custo (R$)" step="0.01" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]" required></div><div class="grid grid-cols-2 gap-4"><input type="number" name="productStock" placeholder="Estoque" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]" required><div><label for="productCategory" class="sr-only">Categoria</label><select name="productCategory" id="add-product-category" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]" required></select></div></div></form><div class="flex justify-end gap-4 mt-6"><button type="button" class="close-modal-btn px-4 py-2 bg-[var(--bg-secondary)] rounded-lg">Cancelar</button><button type="submit" form="add-product-form" class="px-4 py-2 bg-[var(--primary-600)] text-white rounded-lg">Adicionar</button></div></div></div>
    <div id="modal-edit-produto" class="fixed inset-0 hidden items-center justify-center modal-backdrop"><div class="rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-md mx-4 modal"><h3 class="text-2xl font-bold mb-6">Editar Produto</h3><form id="edit-product-form" class="space-y-4"><input type="hidden" name="productId"><input type="text" name="productName" placeholder="Nome do Produto" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]" required><div class="grid grid-cols-2 gap-4"><input type="number" name="productPrice" placeholder="Preço (R$)" step="0.01" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]" required><input type="number" name="productCost" placeholder="Custo (R$)" step="0.01" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]" required></div><div class="grid grid-cols-2 gap-4"><input type="number" name="productStock" placeholder="Estoque" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]" required><div><label for="editProductCategory" class="sr-only">Categoria</label><select name="editProductCategory" id="edit-product-category" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]" required></select></div></div></form><div class="flex justify-between items-center mt-6"><button type="button" id="delete-product-btn" class="px-4 py-2 bg-[var(--danger-600)] text-white rounded-lg">Excluir Produto</button><div class="flex gap-4"><button type="button" class="close-modal-btn px-4 py-2 bg-[var(--bg-secondary)] rounded-lg">Cancelar</button><button type="submit" form="edit-product-form" class="px-4 py-2 bg-[var(--primary-600)] text-white rounded-lg">Guardar Alterações</button></div></div></div></div>

    <!-- Modal: Adicionar/Editar Categoria -->
    <div id="modal-categorias" class="fixed inset-0 hidden items-center justify-center modal-backdrop"><div class="rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-lg mx-4 modal"><h3 class="text-2xl font-bold mb-6">Gerir Categorias</h3><form id="add-category-form" class="mb-6 pb-6 border-b border-[var(--border-color)] flex items-center gap-4"><input type="text" name="categoryName" placeholder="Nome da Nova Categoria" class="flex-grow p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]" required><button type="submit" class="px-4 py-2 bg-teal-600 text-white rounded-lg">Adicionar</button></form><div id="categories-list" class="max-h-64 overflow-y-auto"></div></div></div>
    <div id="modal-edit-categoria" class="fixed inset-0 hidden items-center justify-center modal-backdrop"><div class="rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-lg mx-4 modal"><h3 class="text-2xl font-bold mb-6">Editar Categoria</h3><form id="edit-category-form"><input type="hidden" name="categoryId"><input type="text" name="categoryName" placeholder="Nome da Categoria" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]" required></form><div class="flex justify-end gap-4 mt-6"><button type="button" class="close-modal-btn px-4 py-2 bg-[var(--bg-secondary)] rounded-lg">Cancelar</button><button type="submit" form="edit-category-form" class="px-4 py-2 bg-[var(--primary-600)] text-white rounded-lg">Guardar Alterações</button></div></div></div>

    <!-- Modal: Adicionar/Editar Matéria-Prima -->
    <div id="modal-materiaprima" class="fixed inset-0 hidden items-center justify-center modal-backdrop">
        <div class="rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-3xl mx-4 modal">
            <h3 class="text-2xl font-bold mb-6">Gerir Estoque</h3>
            <form id="add-raw-material-form" class="mb-6 pb-6 border-b border-[var(--border-color)] grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 items-end">
                <input type="text" name="rawMaterialName" placeholder="Nome do Item" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]" required>
                <input type="text" name="rawMaterialSupplier" placeholder="Fornecedor" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]">
                <input type="number" name="rawMaterialStock" placeholder="Quantidade" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]" required>
                <input type="text" name="rawMaterialUnit" placeholder="Unidade (ex: g, ml)" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]" required>
                <input type="number" name="rawMaterialTotalCost" placeholder="Custo Total (R$)" step="0.01" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]" required>
                <input type="date" name="rawMaterialReceiptDate" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]" required>
                <button type="submit" class="sm:col-span-2 md:col-span-3 px-4 py-2 bg-[var(--secondary-600)] text-white rounded-lg">Adicionar Item</button>
            </form>
            <div id="raw-materials-list" class="max-h-64 overflow-y-auto"></div>
        </div>
    </div>
    <div id="modal-edit-materiaprima" class="fixed inset-0 hidden items-center justify-center modal-backdrop">
        <div class="rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-3xl mx-4 modal">
            <h3 class="text-2xl font-bold mb-6">Editar Item de Estoque</h3>
            <form id="edit-raw-material-form" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 items-end">
                <input type="hidden" name="rawMaterialId">
                <input type="text" name="rawMaterialName" placeholder="Nome do Item" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]" required>
                <input type="text" name="rawMaterialSupplier" placeholder="Fornecedor" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]">
                <input type="number" name="rawMaterialStock" placeholder="Quantidade" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]" required>
                <input type="text" name="rawMaterialUnit" placeholder="Unidade (ex: g, ml)" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]" required>
                <input type="number" name="rawMaterialTotalCost" placeholder="Custo Total (R$)" step="0.01" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]" required>
                <input type="date" name="rawMaterialReceiptDate" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]" required>
            </form>
            <div class="flex justify-end gap-4 mt-6">
                <button type="button" class="close-modal-btn px-4 py-2 bg-[var(--bg-secondary)] rounded-lg">Cancelar</button>
                <button type="submit" form="edit-raw-material-form" class="px-4 py-2 bg-[var(--primary-600)] text-white rounded-lg">Guardar Alterações</button>
            </div>
        </div>
    </div>

    <!-- Modal: Relatórios -->
    <div id="modal-relatorios" class="fixed inset-0 hidden items-center justify-center modal-backdrop"><div class="rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-5xl mx-4 modal flex flex-col max-h-[90vh]"><h3 class="text-2xl font-bold mb-4 flex-shrink-0">Relatórios</h3><div class="border-b border-[var(--border-color)] flex-shrink-0"><nav id="report-tabs" class="-mb-px flex flex-nowrap space-x-4 sm:space-x-8 overflow-x-auto pb-2" aria-label="Tabs"><button data-tab="vendas" class="tab-button active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Vendas</button><button data-tab="vendas-cliente" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:border-gray-300">Vendas por Cliente</button><button data-tab="desempenho-produtos" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:border-gray-300">Desempenho de Produtos</button><button data-tab="estoque-produtos" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:border-gray-300">Estoque de Produtos</button><button data-tab="estoque-materias" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:border-gray-300">Estoque</button></nav></div><div class="flex-grow overflow-y-auto"><div id="tab-vendas" class="tab-content py-4"><div class="mb-4 flex justify-center gap-2" id="report-period-buttons"><button data-period="daily" class="period-button px-3 py-1 text-sm border rounded-full border-[var(--border-color)]">Hoje</button><button data-period="weekly" class="period-button active px-3 py-1 text-sm border rounded-full border-[var(--border-color)]">7 Dias</button><button data-period="monthly" class="period-button px-3 py-1 text-sm border rounded-full border-[var(--border-color)]">Este Mês</button><button data-period="annual" class="period-button px-3 py-1 text-sm border rounded-full border-[var(--border-color)]">Anual</button></div><div id="month-year-selector" class="hidden my-4 flex justify-center gap-4 items-center"><select id="report-month-select" class="p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-primary)]"></select><select id="report-year-select" class="p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-primary)]"></select></div><div id="sales-summary" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center mb-4"></div><canvas id="salesChart"></canvas><div id="transactions-list" class="mt-4"></div><div id="annual-summary-table" class="mt-4 hidden"></div></div><div id="tab-vendas-cliente" class="tab-content hidden py-4"></div><div id="tab-desempenho-produtos" class="tab-content hidden py-4"></div><div id="tab-estoque-produtos" class="tab-content hidden py-4"></div><div id="tab-estoque-materias" class="tab-content hidden py-4"></div></div></div></div>

    <!-- Modal: Adicionar/Editar Clientes -->
    <div id="modal-clientes" class="fixed inset-0 hidden items-center justify-center modal-backdrop"><div class="rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-lg mx-4 modal"><h3 class="text-2xl font-bold mb-6">Gerir Clientes</h3><form id="add-customer-form" class="mb-6 pb-6 border-b border-[var(--border-color)]"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="text" name="customerName" placeholder="Nome do Cliente" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]" required><input type="text" name="customerContact" placeholder="Contacto (Telefone/Email)" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]"></div><button type="submit" class="mt-4 w-full md:w-auto px-4 py-2 bg-purple-600 text-white rounded-lg">Adicionar Cliente</button></form><div id="customers-list" class="max-h-64 overflow-y-auto"></div></div></div>
    <div id="modal-edit-cliente" class="fixed inset-0 hidden items-center justify-center modal-backdrop"><div class="rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-lg mx-4 modal"><h3 class="text-2xl font-bold mb-6">Editar Cliente</h3><form id="edit-customer-form"><input type="hidden" name="customerId"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="text" name="customerName" placeholder="Nome do Cliente" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]" required><input type="text" name="customerContact" placeholder="Contacto (Telefone/Email)" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]"></div></form><div class="flex justify-end gap-4 mt-6"><button type="button" class="close-modal-btn px-4 py-2 bg-[var(--bg-secondary)] rounded-lg">Cancelar</button><button type="submit" form="edit-customer-form" class="px-4 py-2 bg-[var(--primary-600)] text-white rounded-lg">Guardar Alterações</button></div></div></div>
    
    <!-- Modal: Movimentar Caixa -->
    <div id="modal-caixa" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop"><div class="rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-md mx-4 modal"><h3 class="text-2xl font-bold mb-6">Movimentar Caixa</h3><form id="cash-flow-form"><div class="mb-4"><label class="block text-sm font-medium">Tipo</label><select name="cashFlowType" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]"><option value="entrada">Entrada (Suprimento)</option><option value="saida">Saída (Despesa)</option></select></div><div class="mb-4"><label class="block text-sm font-medium">Valor (R$)</label><input type="number" name="cashFlowAmount" step="0.01" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]" required></div><div class="mb-6"><label class="block text-sm font-medium">Descrição</label><input type="text" name="cashFlowDescription" placeholder="Ex: Troco inicial" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]" required></div><div class="flex justify-end gap-4"><button type="button" class="close-modal-btn px-4 py-2 bg-[var(--bg-secondary)] rounded-lg">Cancelar</button><button type="submit" form="cash-flow-form" class="px-4 py-2 bg-orange-500 text-white rounded-lg">Confirmar</button></div></form></div></div>
    
    <!-- Modal: Configurações -->
    <div id="modal-settings" class="fixed inset-0 hidden items-center justify-center modal-backdrop">
        <div class="rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-md mx-4 modal">
            <h3 class="text-2xl font-bold mb-6">Configurações</h3>
            <div>
                <h4 class="font-semibold mb-3">Tema da Interface</h4>
                <div class="grid grid-cols-2 gap-4" id="theme-selector">
                    <button data-theme="light" class="theme-button p-4 border border-[var(--border-color)] rounded-lg text-left"><span class="block w-6 h-6 rounded-full bg-white border mb-2"></span>Claro</button>
                    <button data-theme="dark" class="theme-button p-4 border border-[var(--border-color)] rounded-lg text-left"><span class="block w-6 h-6 rounded-full bg-gray-800 border mb-2"></span>Escuro</button>
                    <button data-theme="ocean" class="theme-button p-4 border border-[var(--border-color)] rounded-lg text-left"><span class="block w-6 h-6 rounded-full bg-blue-800 border mb-2"></span>Oceano</button>
                    <button data-theme="forest" class="theme-button p-4 border border-[var(--border-color)] rounded-lg text-left"><span class="block w-6 h-6 rounded-full bg-green-800 border mb-2"></span>Floresta</button>
                </div>
            </div>

            <div class="mt-6 pt-6 border-t border-[var(--border-color)]">
                <h4 class="font-semibold mb-3">Backup & Restauração</h4>
                <p class="text-xs text-[var(--text-secondary)] mb-3">Guarde todos os dados do sistema num ficheiro ou restaure a partir de um backup anterior.</p>
                <div class="flex gap-4">
                    <button id="export-data-btn" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg"><i class="fas fa-download"></i> Exportar Tudo</button>
                    <label for="import-file-input" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg cursor-pointer text-center"><i class="fas fa-upload"></i> Importar Backup</label>
                    <input type="file" id="import-file-input" class="hidden" accept=".json">
                </div>
                <button id="load-from-google-sheets-btn" class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg mt-2"><i class="fas fa-cloud-download-alt"></i> Carregar da Nuvem</button>
                <button id="save-to-google-sheets-btn" class="w-full px-4 py-2 bg-emerald-700 text-white rounded-lg mt-2"><i class="fas fa-cloud-upload-alt"></i> Guardar na Nuvem (Manual)</button>
                <div class="flex items-center justify-between mt-4 p-3 bg-[var(--bg-secondary)] rounded-lg">
                    <label for="autosave-toggle" class="flex flex-col cursor-pointer">
                        <span class="font-medium">Guardar Automaticamente na Nuvem</span>
                        <span class="text-xs text-[var(--text-tertiary)]">Guarda a cada 5 minutos e ao fechar.</span>
                    </label>
                    <div class="relative inline-block w-10 mr-2 align-middle select-none">
                        <input type="checkbox" name="autosave-toggle" id="autosave-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                        <label for="autosave-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                    </div>
                </div>
            </div>

            <div class="mt-6 pt-6 border-t border-[var(--border-color)]">
                <h4 class="font-semibold mb-3 text-[var(--danger-500)]">Zona de Perigo</h4>
                <button id="reset-system-btn" class="w-full px-4 py-2 bg-[var(--danger-600)] text-white rounded-lg">Zerar Todo o Sistema</button>
                <p class="text-xs text-[var(--text-secondary)] mt-2">Atenção: Esta ação é irreversível e apagará todos os dados.</p>
            </div>

            <div class="flex justify-end mt-8"><button type="button" class="close-modal-btn px-4 py-2 bg-[var(--bg-secondary)] rounded-lg">Fechar</button></div>
        </div>
    </div>
    
    <!-- Modal: Confirmação -->
    <div id="modal-confirm" class="fixed inset-0 hidden items-center justify-center modal-backdrop"><div class="rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-md mx-4 modal"><h3 id="confirm-title" class="text-2xl font-bold mb-4">Confirmar Ação</h3><p id="confirm-message" class="text-[var(--text-secondary)] mb-6">Tem a certeza?</p><div class="flex justify-end gap-4"><button id="confirm-cancel-btn" class="px-4 py-2 bg-[var(--bg-secondary)] rounded-lg">Cancelar</button><button id="confirm-confirm-btn" class="px-4 py-2 bg-[var(--danger-600)] text-white rounded-lg">Confirmar</button></div></div></div>
    
    <!-- Modal: Recibo e Pagamento -->
    <div id="receipt-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop"><div class="rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-sm mx-4 modal"><div id="receipt-content" class="text-center"><h2 class="text-2xl font-bold mb-2">Recibo</h2><p class="text-sm text-[var(--text-secondary)] mb-4">A Sua Papelaria & 3D</p><div id="receipt-details" class="text-left space-y-2 border-t border-b border-[var(--border-color)] py-4 my-4"></div><p id="receipt-total" class="font-bold text-lg"></p><p id="receipt-date" class="text-xs text-[var(--text-secondary)] mt-4"></p></div><div class="flex justify-center gap-4 mt-6 no-print"><button class="close-modal-btn px-4 py-2 bg-[var(--bg-secondary)] rounded-lg">Fechar</button><button id="print-receipt-btn" class="px-4 py-2 bg-[var(--primary-600)] text-white rounded-lg"><i class="fas fa-print"></i> Imprimir</button></div></div></div>
    <div id="modal-payment" class="fixed inset-0 hidden items-center justify-center modal-backdrop"><div class="rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-md mx-4 modal"><h3 class="text-2xl font-bold mb-6">Finalizar Venda</h3><form id="payment-form" class="space-y-4"><div><label class="block text-sm font-medium">Total a Pagar</label><p id="payment-total" class="text-3xl font-bold text-[var(--primary-600)]"></p></div><div><label for="payment-method" class="block text-sm font-medium">Forma de Pagamento</label><select id="payment-method" name="paymentMethod" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]"><option value="Dinheiro">Dinheiro</option><option value="Pix">Pix</option><option value="Cartão de Crédito">Cartão de Crédito</option></select></div><div id="installments-group" class="hidden"><label for="payment-installments" class="block text-sm font-medium">Número de Parcelas</label><input type="number" id="payment-installments" name="paymentInstallments" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]" min="1" value="1"></div><div id="amount-paid-group"><label for="payment-amount-paid" class="block text-sm font-medium">Valor Pago (R$)</label><input type="number" id="payment-amount-paid" name="paymentAmountPaid" step="0.01" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]"></div><div><label class="block text-sm font-medium">Troco</label><p id="payment-change" class="text-xl font-bold text-[var(--secondary-600)]">R$ 0,00</p></div><div class="flex items-center justify-between mt-4"><label for="retroactive-sale-toggle" class="text-sm font-medium">Venda Retroativa?</label><input type="checkbox" id="retroactive-sale-toggle" name="retroactiveSale" class="h-4 w-4 text-[var(--primary-600)] focus:ring-[var(--primary-500)] border-gray-300 rounded"></div><div id="retroactive-date-group" class="hidden"><label for="payment-retroactive-date" class="block text-sm font-medium">Data e Hora da Venda</label><input type="datetime-local" id="payment-retroactive-date" name="retroactiveDate" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]"></div></form><div class="flex justify-between gap-4 mt-6"><button type="button" id="process-unpaid-sale-btn" class="px-4 py-2 bg-yellow-500 text-white rounded-lg">Guardar como Não Pago</button><div class="flex gap-4"><button type="button" class="close-modal-btn px-4 py-2 bg-[var(--bg-secondary)] rounded-lg">Cancelar</button><button type="submit" form="payment-form" class="px-4 py-2 bg-[var(--primary-600)] text-white rounded-lg">Confirmar Pagamento</button></div></div></div></div>
    
    <!-- Modal: Fechamento de Caixa -->
    <div id="modal-fechamento" class="fixed inset-0 hidden items-center justify-center modal-backdrop"><div class="rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-md mx-4 modal"><h3 class="text-2xl font-bold mb-6">Fechamento de Caixa do Dia</h3><div id="cash-closing-summary" class="space-y-3"></div><div class="flex justify-end mt-8"><button type="button" class="close-modal-btn px-4 py-2 bg-[var(--bg-secondary)] rounded-lg">Fechar</button></div></div></div>
    
    <!-- Modal: Contas a Receber -->
    <div id="modal-contas-receber" class="fixed inset-0 hidden items-center justify-center modal-backdrop">
        <div class="rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-3xl mx-4 modal flex flex-col max-h-[90vh]">
            <h3 class="text-2xl font-bold mb-6 flex-shrink-0">Contas a Receber (Vendas Não Pagas)</h3>
            <div id="unpaid-sales-list" class="flex-grow overflow-y-auto"></div>
            <div class="flex justify-end mt-8 flex-shrink-0"><button type="button" class="close-modal-btn px-4 py-2 bg-[var(--bg-secondary)] rounded-lg">Fechar</button></div>
        </div>
    </div>
    <div id="modal-receber-pagamento" class="fixed inset-0 hidden items-center justify-center modal-backdrop">
        <div class="rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-md mx-4 modal">
            <h3 class="text-2xl font-bold mb-6">Registar Pagamento</h3>
            <form id="receive-payment-form" class="space-y-4">
                <input type="hidden" name="transactionId">
                <div><label class="block text-sm font-medium">Total a Pagar</label><p id="receive-payment-total" class="text-3xl font-bold text-[var(--primary-600)]"></p></div>
                <div><label for="receive-payment-method" class="block text-sm font-medium">Forma de Pagamento</label><select id="receive-payment-method" name="paymentMethod" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]"><option value="Dinheiro">Dinheiro</option><option value="Pix">Pix</option><option value="Cartão de Crédito">Cartão de Crédito</option></select></div>
                <div id="receive-installments-group" class="hidden"><label for="receive-payment-installments" class="block text-sm font-medium">Número de Parcelas</label><input type="number" id="receive-payment-installments" name="paymentInstallments" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]" min="1" value="1"></div>
            </form>
            <div class="flex justify-end gap-4 mt-6"><button type="button" class="close-modal-btn px-4 py-2 bg-[var(--bg-secondary)] rounded-lg">Cancelar</button><button type="submit" form="receive-payment-form" class="px-4 py-2 bg-[var(--primary-600)] text-white rounded-lg">Confirmar Recebimento</button></div>
        </div>
    </div>
    
    <!-- Modal: Importação -->
    <div id="modal-importar-vendas" class="fixed inset-0 hidden items-center justify-center modal-backdrop">
        <div class="rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-2xl mx-4 modal flex flex-col max-h-[90vh]">
            <h3 class="text-2xl font-bold mb-4">Importar Vendas de Planilha (.csv)</h3>
            <div class="p-4 bg-blue-100 text-blue-800 rounded-lg text-sm mb-4"><p class="font-bold">Instruções:</p><p>1. Crie um ficheiro .csv com as colunas na seguinte ordem, sem cabeçalho:</p><p class="font-mono bg-blue-200 p-1 rounded my-1 text-xs">data_hora,id_produto,quantidade,id_cliente,metodo_pagamento,status_pagamento</p><p>2. A data deve estar no formato `AAAA-MM-DDTHH:MM` (ex: `2023-10-27T14:30`).</p><p>3. Os IDs de produto e cliente devem corresponder aos IDs existentes no sistema.</p><p>4. `metodo_pagamento` pode ser `Dinheiro`, `Pix`, `Cartão de Crédito` ou `A Prazo`.</p><p>5. `status_pagamento` deve ser `Pago` ou `Não Pago`.</p></div>
            <form id="import-sales-form"><input type="file" id="csv-file-input" accept=".csv" class="w-full border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)] p-2" required><button type="submit" class="w-full mt-4 px-4 py-2 bg-indigo-500 text-white rounded-lg">Processar Planilha</button></form>
            <div id="import-log" class="mt-4 p-2 border border-[var(--border-color)] rounded-lg h-48 overflow-y-auto text-xs bg-[var(--bg-tertiary)]">A aguardar ficheiro...</div>
             <div class="flex justify-end gap-4 mt-6 flex-shrink-0"><button type="button" class="close-modal-btn px-4 py-2 bg-[var(--bg-secondary)] rounded-lg">Fechar</button></div>
        </div>
    </div>
    
    <!-- Modal: Detalhes da Venda -->
    <div id="modal-venda-detalhes" class="fixed inset-0 hidden items-center justify-center modal-backdrop">
        <div class="rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-lg mx-4 modal flex flex-col max-h-[90vh]">
            <div id="sale-details-content" class="flex-grow overflow-y-auto"><h3 class="text-2xl font-bold mb-2">Detalhes da Venda</h3><div class="text-sm text-[var(--text-secondary)] mb-4"><p><strong>ID da Transação:</strong> <span id="details-id"></span></p><p><strong>Data:</strong> <span id="details-date"></span></p><p><strong>Cliente:</strong> <span id="details-customer"></span></p></div><table class="w-full text-left text-sm"><thead><tr class="border-b border-[var(--border-color)]"><th class="p-2">Produto</th><th class="p-2 text-center">Qtd.</th><th class="p-2 text-right">Preço Unit.</th><th class="p-2 text-right">Total</th></tr></thead><tbody id="details-items-table"></tbody></table><div class="mt-4 pt-4 border-t border-[var(--border-color)] space-y-1 text-sm"><div class="flex justify-between"><span>Subtotal:</span> <span id="details-subtotal"></span></div><div class="flex justify-between"><span>Custo Total:</span> <span id="details-cost" class="text-red-600"></span></div><div class="flex justify-between font-bold"><span>Lucro Líquido:</span> <span id="details-profit" class="text-green-600"></span></div><div class="flex justify-between font-bold"><span>Margem de Lucro:</span> <span id="details-margin" class="text-green-600"></span></div></div></div>
            <div class="flex justify-end gap-4 mt-6 flex-shrink-0 no-print"><button type="button" id="print-details-btn" class="px-4 py-2 bg-gray-600 text-white rounded-lg"><i class="fas fa-print"></i> Imprimir</button><button type="button" class="close-modal-btn px-4 py-2 bg-[var(--bg-secondary)] rounded-lg">Fechar</button></div>
        </div>
    </div>
    
    <!-- NOVO Modal: Detalhes de Vendas do Cliente -->
    <div id="modal-cliente-detalhes" class="fixed inset-0 hidden items-center justify-center modal-backdrop">
        <div class="rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-3xl mx-4 modal flex flex-col max-h-[90vh]">
            <h3 class="text-2xl font-bold mb-2 flex-shrink-0">Detalhes de Vendas do Cliente</h3>
            <h4 id="details-customer-name" class="text-lg font-semibold text-[var(--primary-600)] mb-4"></h4>
            <div id="details-customer-sales-list" class="flex-grow overflow-y-auto"></div>
            <div class="flex justify-end mt-8 flex-shrink-0">
                <button type="button" class="close-modal-btn px-4 py-2 bg-[var(--bg-secondary)] rounded-lg">Fechar</button>
            </div>
        </div>
    </div>

    <!-- NOVO Modal: Editar Venda -->
    <div id="modal-edit-venda" class="fixed inset-0 hidden items-center justify-center modal-backdrop">
        <div class="rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-md mx-4 modal">
            <h3 class="text-2xl font-bold mb-6">Editar Pagamento da Venda</h3>
            <form id="edit-sale-form" class="space-y-4">
                <input type="hidden" name="transactionId">
                <div><label class="block text-sm font-medium">Total da Venda</label><p id="edit-sale-total" class="text-3xl font-bold text-[var(--primary-600)]"></p></div>
                <div>
                    <label for="edit-sale-status" class="block text-sm font-medium">Status do Pagamento</label>
                    <select id="edit-sale-status" name="saleStatus" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]">
                        <option value="Pago">Pago</option>
                        <option value="Não Pago">Não Pago</option>
                    </select>
                </div>
                <div>
                    <label for="edit-sale-method" class="block text-sm font-medium">Forma de Pagamento</label>
                    <select id="edit-sale-method" name="paymentMethod" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]">
                        <option value="Dinheiro">Dinheiro</option>
                        <option value="Pix">Pix</option>
                        <option value="Cartão de Crédito">Cartão de Crédito</option>
                        <option value="A Prazo">A Prazo</option>
                    </select>
                </div>
                <div id="edit-installments-group" class="hidden"><label for="edit-sale-installments" class="block text-sm font-medium">Número de Parcelas</label><input type="number" id="edit-sale-installments" name="paymentInstallments" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]" min="1" value="1"></div>
            </form>
            <div class="flex justify-end gap-4 mt-6">
                <button type="button" class="close-modal-btn px-4 py-2 bg-[var(--bg-secondary)] rounded-lg">Cancelar</button>
                <button type="submit" form="edit-sale-form" class="px-4 py-2 bg-[var(--primary-600)] text-white rounded-lg">Guardar Alterações</button>
            </div>
        </div>
    </div>
    
    <!-- NOVO Modal: Desconto -->
    <div id="modal-desconto" class="fixed inset-0 hidden items-center justify-center modal-backdrop">
        <div class="rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-sm mx-4 modal">
            <h3 id="discount-modal-title" class="text-2xl font-bold mb-6">Aplicar Desconto</h3>
            <form id="discount-form">
                <input type="hidden" name="itemIndex">
                <div class="mb-4">
                    <label for="discount-type" class="block text-sm font-medium">Tipo de Desconto</label>
                    <select id="discount-type" name="discountType" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]">
                        <option value="percentage">% (Percentagem)</option>
                        <option value="fixed">R$ (Valor Fixo)</option>
                    </select>
                </div>
                <div>
                    <label for="discount-value" class="block text-sm font-medium">Valor do Desconto</label>
                    <input type="number" id="discount-value" name="discountValue" step="0.01" class="w-full p-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)]" required>
                </div>
            </form>
            <div class="flex justify-end gap-4 mt-6">
                <button type="button" class="close-modal-btn px-4 py-2 bg-[var(--bg-secondary)] rounded-lg">Cancelar</button>
                <button type="submit" form="discount-form" class="px-4 py-2 bg-[var(--primary-600)] text-white rounded-lg">Aplicar</button>
            </div>
        </div>
    </div>

    <!-- Toast de Notificação -->
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 translate-y-10 transition-all duration-300 z-[200]"><span id="toast-message"></span></div>

<script>
    // ===================================================================================
    // CONFIGURAÇÃO OPCIONAL: BACKUP NA NUVEM
    // Cole a URL do seu App da Web do Google Apps Script aqui.
    // ===================================================================================
    const GOOGLE_SCRIPT_URL = 'COLE_A_URL_DO_SEU_APP_DA_WEB_AQUI';

    // --- DADOS EM MEMÓRIA ---
    let products = [];
    let customers = [];
    let transactions = [];
    let cashBalance = 0.00;
    let rawMaterials = [];
    let categories = [];
    let cart = {
        items: [],
        generalDiscount: { type: 'fixed', value: 0 }
    };
    let salesChart;
    let currentReportPeriod = 'weekly';
    let confirmCallback = null;
    let autoSaveInterval = null;
    let isAutoSaveEnabled = false;

    // --- DADOS INICIAIS (VAZIOS) ---
    const sampleProducts = [];
    const sampleRawMaterials = [];

    // --- FUNÇÕES DE PERSISTÊNCIA E INICIALIZAÇÃO ---
    function saveData() {
        try {
            localStorage.setItem('products', JSON.stringify(products));
            localStorage.setItem('customers', JSON.stringify(customers));
            localStorage.setItem('transactions', JSON.stringify(transactions));
            localStorage.setItem('cashBalance', JSON.stringify(cashBalance));
            localStorage.setItem('rawMaterials', JSON.stringify(rawMaterials));
            localStorage.setItem('categories', JSON.stringify(categories));
            localStorage.setItem('theme', document.documentElement.getAttribute('data-theme'));
        } catch (error) {
            console.error("Erro ao guardar dados:", error);
            showToast("Não foi possível guardar os dados. O armazenamento pode estar cheio.", "error");
        }
    }

    function loadData() {
        toggleLoading(true);
        try {
            categories = JSON.parse(localStorage.getItem('categories')) || [{ id: 1, name: 'Sem Categoria' }];
            const productsData = JSON.parse(localStorage.getItem('products'));
            products = (productsData) ? productsData : sampleProducts;
            // Retrocompatibilidade: garante que todos os produtos têm uma categoria
            products.forEach(p => { if (!p.categoryId) p.categoryId = 1; });
            
            const rawMaterialsData = JSON.parse(localStorage.getItem('rawMaterials'));
            rawMaterials = (rawMaterialsData) ? rawMaterialsData : sampleRawMaterials;
            customers = JSON.parse(localStorage.getItem('customers')) || [{ id: 1, name: 'Cliente Balcão', contact: '' }];
            transactions = JSON.parse(localStorage.getItem('transactions')) || [];
            cashBalance = JSON.parse(localStorage.getItem('cashBalance')) || 0.00;
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);
        } catch (error) {
            console.error("Erro ao carregar dados locais:", error);
            showToast("Erro ao carregar dados. A utilizar valores padrão.", "error");
        } finally {
            initializeApp();
            toggleLoading(false);
        }
    }
    
    function initializeApp() {
        switchView('dashboard-view');
        renderProducts();
        renderCart();
        updateCashBalance();
        renderCustomers();
        renderCategoryFilters();
        initializeAutoSave();
        addEventListeners();
    }
    
    window.onload = loadData;

    // --- FUNÇÕES DE RENDERIZAÇÃO E UI ---
    function formatCurrency(value) { return (value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
    
    function toggleLoading(isLoading) { document.getElementById('loading-overlay').classList.toggle('hidden', !isLoading); }
    
    function renderProducts(filter = '', categoryId = 'all') {
        const productGrid = document.getElementById('product-grid');
        productGrid.innerHTML = '';
        
        let filteredProducts = products;
        if (categoryId !== 'all') {
            filteredProducts = filteredProducts.filter(p => p.categoryId == categoryId);
        }
        if (filter) {
            filteredProducts = filteredProducts.filter(p => p.name.toLowerCase().includes(filter.toLowerCase()));
        }

        if (filteredProducts.length === 0) { productGrid.innerHTML = `<p class="col-span-full text-center text-gray-500 mt-8">Nenhum produto encontrado.</p>`; return; }
        
        filteredProducts.forEach(product => {
            const disabled = product.stock <= 0;
            const card = document.createElement('div');
            card.className = `product-card p-4 rounded-lg shadow cursor-pointer ${disabled ? 'opacity-50 cursor-not-allowed' : 'hover:bg-[var(--bg-secondary)]'}`;
            card.innerHTML = `<h3 class="font-bold truncate">${product.name}</h3><p class="text-[var(--primary-600)] font-semibold">${formatCurrency(product.price)}</p><p class="text-sm text-[var(--text-secondary)]">Estoque: ${product.stock}</p>`;
            if (!disabled) { card.onclick = () => addToCart(product.id); }
            productGrid.appendChild(card);
        });
    }

    function renderCart() {
        const cartItems = document.getElementById('cart-items');
        if (cart.items.length === 0) { cartItems.innerHTML = '<p class="text-center text-[var(--text-secondary)] mt-8">O caixa está vazio.</p>'; } 
        else {
            cartItems.innerHTML = '';
            cart.items.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                let discountText = '';
                if (item.discount.value > 0) {
                    const discountValue = item.discount.type === 'percentage' ? (itemTotal * item.discount.value / 100) : item.discount.value;
                    discountText = `<span class="text-xs text-red-500">(-${formatCurrency(discountValue)})</span>`;
                }
                cartItems.innerHTML += `<div class="flex justify-between items-center bg-[var(--bg-tertiary)] p-3 rounded-lg"><div><p class="font-semibold">${item.name} ${discountText}</p><p class="text-sm text-[var(--text-secondary)]">${item.quantity} x ${formatCurrency(item.price)}</p></div><div class="flex items-center gap-3"><button data-index="${index}" class="apply-item-discount-btn text-blue-500 hover:text-blue-700"><i class="fas fa-tag"></i></button><button data-index="${index}" class="decrease-qty-btn w-6 h-6 bg-gray-200 rounded-full font-bold">-</button><span>${item.quantity}</span><button data-index="${index}" class="increase-qty-btn w-6 h-6 bg-gray-200 rounded-full font-bold">+</button><button data-index="${index}" class="remove-from-cart-btn text-[var(--danger-500)] hover:text-[var(--danger-600)] ml-2"><i class="fas fa-trash-alt"></i></button></div></div>`;
            });
        }
        document.getElementById('checkout-button').disabled = cart.items.length === 0;
        updateTotals();
    }
    
    function renderRawMaterials() {
        const list = document.getElementById('raw-materials-list');
        list.innerHTML = '';
        if (rawMaterials.length === 0) { list.innerHTML = `<p class="text-center text-gray-500 mt-4">Nenhum item de estoque registado.</p>`; return; }
        list.innerHTML = `<div class="grid grid-cols-7 items-center p-2 border-b font-bold text-sm text-[var(--text-secondary)]"><p class="col-span-2">Nome</p><p>Fornecedor</p><p>Data</p><p>Qtd.</p><p>Custo Unit.</p><p class="text-right">Ações</p></div>`;
        rawMaterials.forEach(rm => {
            const lowStock = rm.stock <= 10;
            const unitCost = (rm.totalCost && rm.stock > 0) ? rm.totalCost / rm.stock : 0;
            list.innerHTML += `<div class="grid grid-cols-7 items-center p-2 border-b border-[var(--border-color)] text-sm ${lowStock ? 'bg-yellow-100 text-yellow-800' : ''}"><p class="col-span-2 font-medium">${rm.name}</p><p>${rm.supplier || 'N/A'}</p><p>${rm.receiptDate ? new Date(rm.receiptDate + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A'}</p><p>${rm.stock} ${rm.unit}</p><p class="font-semibold">${formatCurrency(unitCost)}</p><div class="justify-self-end"><button data-id="${rm.id}" class="edit-raw-material-btn text-blue-500 hover:text-blue-700 p-1"><i class="fas fa-edit"></i></button><button data-id="${rm.id}" class="delete-raw-material-btn text-red-500 hover:text-red-700 p-1"><i class="fas fa-trash"></i></button></div></div>`;
        });
    }

    function renderCustomers() {
        const customersList = document.getElementById('customers-list');
        const customerSelect = document.getElementById('customer-select');
        customersList.innerHTML = '';
        customerSelect.innerHTML = '<option value="">Nenhum cliente selecionado</option>';
        customers.forEach(customer => {
            customersList.innerHTML += `<div class="flex justify-between items-center p-2 border-b border-[var(--border-color)]"><p>${customer.name} <span class="text-sm text-[var(--text-secondary)]">${customer.contact}</span></p><div><button data-id="${customer.id}" class="edit-customer-btn text-blue-500 hover:text-blue-700 p-1"><i class="fas fa-edit"></i></button><button data-id="${customer.id}" class="delete-customer-btn text-red-500 hover:text-red-700 p-1"><i class="fas fa-trash"></i></button></div></div>`;
            customerSelect.innerHTML += `<option value="${customer.id}">${customer.name}</option>`;
        });
    }
    
    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`tab-${tabName}`).classList.remove('hidden');
        document.querySelector(`.tab-button[data-tab="${tabName}"]`).classList.add('active');
        if (tabName === 'vendas-cliente') renderSalesByCustomerReport();
        else if (tabName === 'desempenho-produtos') renderProductPerformanceReport();
        else if (['vendas', 'estoque-produtos', 'estoque-materias'].includes(tabName)) {
            populateMonthYearSelectors();
            renderReports(currentReportPeriod);
        }
    }

    function renderReports(period = currentReportPeriod, month, year) {
        try {
            const now = new Date();
            const annualSummaryTable = document.getElementById('annual-summary-table');
            const transactionsList = document.getElementById('transactions-list');
            let filteredTransactions, startDate;
            
            document.getElementById('month-year-selector').classList.toggle('hidden', period !== 'monthly');

            if (period === 'annual') {
                startDate = new Date(now.getFullYear(), 0, 1);
                filteredTransactions = transactions.filter(t => new Date(t.date) >= startDate);
            } else if (period === 'monthly') {
                const selectedYear = parseInt(year) || now.getFullYear();
                const selectedMonth = parseInt(month) ?? now.getMonth();
                startDate = new Date(selectedYear, selectedMonth, 1);
                const endDate = new Date(selectedYear, selectedMonth + 1, 0);
                endDate.setHours(23, 59, 59, 999);
                filteredTransactions = transactions.filter(t => {
                    const transactionDate = new Date(t.date);
                    return transactionDate >= startDate && transactionDate <= endDate;
                });
            } else {
                switch(period) {
                    case 'daily': startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate()); break;
                    case 'weekly': default: startDate = new Date(); startDate.setDate(startDate.getDate() - 7); break;
                }
                 filteredTransactions = transactions.filter(t => new Date(t.date) >= startDate);
            }

            transactionsList.classList.toggle('hidden', period === 'annual');
            annualSummaryTable.classList.toggle('hidden', period !== 'annual');
            
            const salesSummary = document.getElementById('sales-summary');
            const totalRevenue = filteredTransactions.filter(t => t.type === 'venda' && !t.reversed).reduce((s, t) => s + t.amount, 0);
            const totalCost = filteredTransactions.filter(t => t.type === 'venda' && !t.reversed).reduce((s, t) => s + (t.cost || 0), 0);
            const profit = totalRevenue - totalCost;
            salesSummary.innerHTML = `<div class="p-2"><p class="text-sm text-[var(--text-secondary)]">Receita Bruta</p><p class="text-lg font-bold text-[var(--primary-600)]">${formatCurrency(totalRevenue)}</p></div><div class="p-2"><p class="text-sm text-[var(--text-secondary)]">Custo Produtos</p><p class="text-lg font-bold text-[var(--danger-600)]">${formatCurrency(totalCost)}</p></div><div class="p-2"><p class="text-sm text-[var(--text-secondary)]">Lucro Líquido</p><p class="text-lg font-bold text-[var(--secondary-600)]">${formatCurrency(profit)}</p></div><div class="p-2"><p class="text-sm text-[var(--text-secondary)]">Margem de Lucro</p><p class="text-lg font-bold text-[var(--secondary-600)]">${(totalRevenue > 0 ? (profit / totalRevenue) * 100 : 0).toFixed(2)}%</p></div>`;

            if (period !== 'annual') {
                renderTransactionList(transactionsList, filteredTransactions);
            }
            
            const salesData = { labels: [], datasets: [ { label: 'Vendas Pagas', data: [], backgroundColor: 'rgba(5, 150, 105, 0.6)' }, { label: 'Vendas Não Pagas', data: [], backgroundColor: 'rgba(220, 38, 38, 0.6)' } ] };
            if (period === 'annual') {
                const monthNames = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
                const monthlyData = Array(12).fill(0).map(() => ({ paid: 0, unpaid: 0, cost: 0 }));
                
                filteredTransactions.filter(t => t.type === 'venda' && !t.reversed).forEach(t => {
                    const month = new Date(t.date).getMonth();
                    if (t.status === 'Não Pago') monthlyData[month].unpaid += t.amount;
                    else monthlyData[month].paid += t.amount;
                    monthlyData[month].cost += (t.cost || 0);
                });
                
                salesData.labels = monthNames;
                salesData.datasets[0].data = monthlyData.map(m => m.paid);
                salesData.datasets[1].data = monthlyData.map(m => m.unpaid);
                
                annualSummaryTable.innerHTML = `<table class="w-full text-left"><thead><tr class="border-b border-[var(--border-color)]"><th class="p-2">Mês</th><th>Faturação Bruta</th><th>Custo Produtos</th><th>Lucro Líquido</th><th>Margem %</th></tr></thead><tbody></tbody></table>`;
                const annualTbody = annualSummaryTable.querySelector('tbody');
                monthlyData.forEach((monthData, index) => {
                    const totalRevenue = monthData.paid + monthData.unpaid;
                    const profit = totalRevenue - monthData.cost;
                    const profitPercentage = totalRevenue > 0 ? (profit / totalRevenue) * 100 : 0;
                    annualTbody.innerHTML += `<tr><td class="p-2 font-semibold">${monthNames[index]}</td><td>${formatCurrency(totalRevenue)}</td><td>${formatCurrency(monthData.cost)}</td><td class="${profit >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(profit)}</td><td class="${profit >= 0 ? 'text-green-600' : 'text-red-600'}">${profitPercentage.toFixed(2)}%</td></tr>`;
                });
            } else {
                const salesByDate = {};
                let loopDate = new Date(startDate);
                let endDate = (period === 'monthly') ? new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0) : new Date();

                while(loopDate <= endDate) {
                     salesByDate[loopDate.toISOString().split('T')[0]] = { paid: 0, unpaid: 0 };
                     loopDate.setDate(loopDate.getDate() + 1);
                }

                filteredTransactions.filter(t => t.type === 'venda' && !t.reversed).forEach(t => {
                    const key = new Date(t.date).toISOString().split('T')[0];
                    if(salesByDate[key]) {
                        if (t.status === 'Não Pago') salesByDate[key].unpaid += t.amount;
                        else salesByDate[key].paid += t.amount;
                    }
                });
                if (period === 'daily') {
                    salesData.labels.push('Hoje');
                    const dailyTotals = Object.values(salesByDate).reduce((acc, curr) => ({ paid: acc.paid + curr.paid, unpaid: acc.unpaid + curr.unpaid }), { paid: 0, unpaid: 0 });
                    salesData.datasets[0].data.push(dailyTotals.paid);
                    salesData.datasets[1].data.push(dailyTotals.unpaid);
                } else {
                    for(const [day, totals] of Object.entries(salesByDate)) {
                        salesData.labels.push(new Date(day + 'T00:00:00').toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'}));
                        salesData.datasets[0].data.push(totals.paid);
                        salesData.datasets[1].data.push(totals.unpaid);
                    }
                }
            }
            
            const ctx = document.getElementById('salesChart').getContext('2d');
            if (salesChart) salesChart.destroy();
            salesChart = new Chart(ctx, { type: 'bar', data: salesData, options: { scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } } });
            
            const stockProductsList = document.getElementById('tab-estoque-produtos');
            stockProductsList.innerHTML = `<table class="w-full text-left text-sm"><thead><tr class="border-b"><th class="p-2">Produto</th><th>Categoria</th><th>Estoque</th><th>Custo</th><th>Preço</th><th>Lucro</th><th>Ações</th></tr></thead><tbody></tbody></table>`;
            const productTbody = stockProductsList.querySelector('tbody');
            products.forEach(p => { const profit = p.price - p.cost; const categoryName = categories.find(c => c.id == p.categoryId)?.name || 'N/A'; productTbody.innerHTML += `<tr><td class="p-2">${p.name}</td><td>${categoryName}</td><td>${p.stock} un.</td><td>${formatCurrency(p.cost)}</td><td>${formatCurrency(p.price)}</td><td class="${profit >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(profit)}</td><td><button data-id="${p.id}" class="edit-product-btn text-blue-500 p-1"><i class="fas fa-edit"></i></button></td></tr>`; });
            
            const stockMaterialsList = document.getElementById('tab-estoque-materias');
            stockMaterialsList.innerHTML = `<table class="w-full text-left text-sm"><thead><tr class="border-b"><th class="p-2">Insumo</th><th>Fornecedor</th><th>Data Receb.</th><th>Estoque</th><th>Custo Unitário</th><th>Ações</th></tr></thead><tbody></tbody></table>`;
            const materialTbody = stockMaterialsList.querySelector('tbody');
            rawMaterials.forEach(rm => { const unitCost = (rm.totalCost && rm.stock > 0) ? rm.totalCost / rm.stock : 0; materialTbody.innerHTML += `<tr><td class="p-2">${rm.name}</td><td>${rm.supplier || 'N/A'}</td><td>${rm.receiptDate ? new Date(rm.receiptDate + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A'}</td><td>${rm.stock} ${rm.unit}</td><td>${formatCurrency(unitCost)}</td><td><button data-id="${rm.id}" class="edit-raw-material-btn text-blue-500 p-1"><i class="fas fa-edit"></i></button><button data-id="${rm.id}" class="delete-raw-material-btn text-red-500 p-1"><i class="fas fa-trash"></i></button></td></tr>`; });
        } catch (error) { console.error("Erro ao renderizar relatórios:", error); showToast("Ocorreu um erro ao gerar o relatório.", "error"); }
    }
    
    function renderSalesByCustomerReport() {
        const container = document.getElementById('tab-vendas-cliente');
        const salesByCustomer = transactions.filter(t => t.type === 'venda' && !t.reversed).reduce((acc, sale) => {
            const customerId = sale.customerId || 'unknown';
            if (!acc[customerId]) { acc[customerId] = { paid: 0, unpaid: 0, total: 0, count: 0, customerName: customers.find(c => c.id == customerId)?.name || 'Cliente Não Identificado' }; }
            acc[customerId].total += sale.amount; acc[customerId].count++;
            if (sale.status === 'Não Pago') acc[customerId].unpaid += sale.amount; else acc[customerId].paid += sale.amount;
            return acc;
        }, {});
        let tableHtml = `<table class="w-full text-left mt-4"><thead><tr class="border-b"><th class="p-2">Cliente</th><th class="text-right">Total Comprado</th><th class="text-right">Total Pago</th><th class="text-right">Total Devido</th><th class="text-center">Nº de Vendas</th></tr></thead><tbody>`;
        Object.entries(salesByCustomer).sort(([,a],[,b]) => b.total - a.total).forEach(([customerId, data]) => {
            tableHtml += `<tr class="hover:bg-[var(--bg-secondary)] cursor-pointer customer-details-row" data-customer-id="${customerId}"><td class="p-2 font-semibold">${data.customerName}</td><td class="text-right">${formatCurrency(data.total)}</td><td class="text-right text-green-600">${formatCurrency(data.paid)}</td><td class="text-right text-red-600">${formatCurrency(data.unpaid)}</td><td class="text-center">${data.count}</td></tr>`;
        });
        container.innerHTML = tableHtml + '</tbody></table>';
    }

    function renderCashClosingReport() {
        const today = new Date(); today.setHours(0,0,0,0);
        const todaysTransactions = transactions.filter(t => new Date(t.date) >= today);
        const summary = { totalSales: 0, totalCost: 0, byMethod: { 'Dinheiro': 0, 'Pix': 0, 'Cartão de Crédito': 0 } };
        todaysTransactions.filter(t => t.type === 'venda' && t.status !== 'Não Pago' && !t.reversed).forEach(sale => {
            summary.totalSales += sale.amount;
            summary.totalCost += sale.cost || 0;
            if (sale.method) summary.byMethod[sale.method] += sale.amount;
        });
        todaysTransactions.filter(t => t.type === 'recebimento').forEach(receipt => {
            summary.totalSales += receipt.amount;
            if (receipt.method) summary.byMethod[receipt.method] += receipt.amount;
        });
        document.getElementById('cash-closing-summary').innerHTML = `<div class="flex justify-between border-b pb-2 border-[var(--border-color)]"><span class="font-semibold">Total de Vendas Pagas do Dia:</span><span class="font-bold text-[var(--primary-600)]">${formatCurrency(summary.totalSales)}</span></div><div class="flex justify-between"><span class="text-sm">Lucro Líquido (de vendas pagas hoje):</span><span class="text-sm font-semibold text-[var(--secondary-600)]">${formatCurrency(summary.totalSales - summary.totalCost)}</span></div><div class="pt-4 mt-4 border-t border-[var(--border-color)]"><h4 class="font-semibold mb-2">Recebimentos por Forma de Pagamento:</h4><div class="flex justify-between text-sm"><span>Dinheiro:</span><span>${formatCurrency(summary.byMethod['Dinheiro'])}</span></div><div class="flex justify-between text-sm"><span>Pix:</span><span>${formatCurrency(summary.byMethod['Pix'])}</span></div><div class="flex justify-between text-sm"><span>Cartão de Crédito:</span><span>${formatCurrency(summary.byMethod['Cartão de Crédito'])}</span></div></div>`;
    }
    
    function renderProductPerformanceReport() {
        const container = document.getElementById('tab-desempenho-produtos');
        const productPerformance = {};

        transactions.filter(t => t.type === 'venda' && !t.reversed).forEach(sale => {
            sale.items.forEach(item => {
                if (!productPerformance[item.id]) {
                    productPerformance[item.id] = {
                        name: item.name,
                        quantitySold: 0,
                        totalRevenue: 0,
                        totalCost: 0,
                        totalProfit: 0
                    };
                }
                const performance = productPerformance[item.id];
                performance.quantitySold += item.quantity;
                const revenue = item.price * item.quantity;
                const cost = item.cost * item.quantity;
                performance.totalRevenue += revenue;
                performance.totalCost += cost;
                performance.totalProfit += revenue - cost;
            });
        });

        const performanceArray = Object.values(productPerformance);
        const allProducts = products.map(p => ({
            name: p.name,
            quantitySold: productPerformance[p.id]?.quantitySold || 0,
            totalRevenue: productPerformance[p.id]?.totalRevenue || 0,
            totalProfit: productPerformance[p.id]?.totalProfit || 0
        }));

        const mostSold = [...allProducts].sort((a, b) => b.quantitySold - a.quantitySold).slice(0, 5);
        const mostProfitable = [...allProducts].sort((a, b) => b.totalProfit - a.totalProfit).slice(0, 5);
        const unsold = products.filter(p => !productPerformance[p.id]).map(p => ({ name: p.name, stock: p.stock }));

        container.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-4">
                <div>
                    <h3 class="text-xl font-semibold mb-3">Top 5 Produtos Mais Vendidos</h3>
                    ${createPerformanceTable(mostSold, ['#', 'Produto', 'Qtd. Vendida', 'Receita Total'], ['quantitySold', 'totalRevenue'])}
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-3">Top 5 Produtos Mais Lucrativos</h3>
                    ${createPerformanceTable(mostProfitable, ['#', 'Produto', 'Lucro Total', 'Receita Total'], ['totalProfit', 'totalRevenue'])}
                </div>
            </div>
            <div class="mt-8">
                <h3 class="text-xl font-semibold mb-3">Produtos Sem Vendas</h3>
                ${createPerformanceTable(unsold, ['Produto', 'Estoque Atual'], ['stock'], false)}
            </div>
        `;
    }

    function createPerformanceTable(data, headers, dataKeys, includeRank = true) {
        if (data.length === 0) return '<p class="text-gray-500">Nenhum dado disponível.</p>';
        let table = '<table class="w-full text-left text-sm"><thead><tr class="border-b">';
        headers.forEach(h => table += `<th class="p-2">${h}</th>`);
        table += '</tr></thead><tbody>';
        data.forEach((item, index) => {
            table += '<tr class="border-b">';
            if (includeRank) table += `<td class="p-2">${index + 1}</td>`;
            table += `<td class="p-2 font-medium">${item.name}</td>`;
            dataKeys.forEach(key => {
                table += `<td class="p-2">${typeof item[key] === 'number' && key !== 'stock' ? formatCurrency(item[key]) : item[key]}</td>`;
            });
            table += '</tr>';
        });
        table += '</tbody></table>';
        return table;
    }
    
    function setReportPeriod(period) {
        currentReportPeriod = period;
        document.querySelectorAll('#report-period-buttons .period-button').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`#report-period-buttons .period-button[data-period="${period}"]`).classList.add('active');
        renderReports(period);
    }
    function updateTotals() {
        const subtotal = cart.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        let totalDiscount = cart.items.reduce((sum, item) => {
            const itemTotal = item.price * item.quantity;
            if (item.discount.value > 0) {
                return sum + (item.discount.type === 'percentage' ? (itemTotal * item.discount.value / 100) : item.discount.value);
            }
            return sum;
        }, 0);
        if (cart.generalDiscount.value > 0) {
            totalDiscount += cart.generalDiscount.type === 'percentage' ? ((subtotal - totalDiscount) * cart.generalDiscount.value / 100) : cart.generalDiscount.value;
        }
        const total = subtotal - totalDiscount;

        document.getElementById('subtotal').textContent = formatCurrency(subtotal);
        document.getElementById('discounts-total').textContent = formatCurrency(-totalDiscount);
        document.getElementById('total').textContent = formatCurrency(total);
    }
    function updateCashBalance() { 
        const cashBalanceElement = document.getElementById('cash-balance');
        if (cashBalanceElement) {
            cashBalanceElement.textContent = formatCurrency(cashBalance);
        }
    }
    function addToCart(productId) {
        const product = products.find(p => p.id === productId);
        if (product && product.stock > 0) {
            const cartItem = cart.items.find(item => item.id === productId);
            if (cartItem) {
                cartItem.quantity++;
            } else {
                cart.items.push({ ...product, quantity: 1, discount: { type: 'fixed', value: 0 } });
            }
            product.stock--;
            renderProducts(document.getElementById('search-product').value, document.querySelector('.category-filter-btn.active').dataset.categoryId); 
            renderCart(); 
            showToast(`'${product.name}' adicionado.`);
        } else { showToast('Produto sem estoque!', 'error'); }
    }
    function increaseCartItemQuantity(index) {
        const product = products.find(p => p.id === cart.items[index].id);
        if (product && product.stock > 0) { cart.items[index].quantity++; product.stock--; renderCart(); renderProducts(document.getElementById('search-product').value, document.querySelector('.category-filter-btn.active').dataset.categoryId); } 
        else { showToast('Não há mais estoque para este produto.', 'error'); }
    }
    function decreaseCartItemQuantity(index) {
        const product = products.find(p => p.id === cart.items[index].id);
        cart.items[index].quantity--; product.stock++;
        if (cart.items[index].quantity === 0) cart.items.splice(index, 1);
        renderCart(); renderProducts(document.getElementById('search-product').value, document.querySelector('.category-filter-btn.active').dataset.categoryId);
    }
    function removeFromCart(index) {
        const product = products.find(p => p.id === cart.items[index].id);
        if (product) product.stock += cart.items[index].quantity;
        cart.items.splice(index, 1);
        renderProducts(document.getElementById('search-product').value, document.querySelector('.category-filter-btn.active').dataset.categoryId); 
        renderCart();
    }
    function clearCart() {
        cart.items.forEach(item => { const product = products.find(p => p.id === item.id); if (product) product.stock += item.quantity; });
        cart.items = [];
        cart.generalDiscount = { type: 'fixed', value: 0 };
        renderProducts(document.getElementById('search-product').value, document.querySelector('.category-filter-btn.active').dataset.categoryId); 
        renderCart();
    }
    function processSale(paymentDetails) {
        if (cart.items.length === 0) return;
        const subtotal = cart.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        let totalDiscount = cart.items.reduce((sum, item) => {
            const itemTotal = item.price * item.quantity;
            return sum + (item.discount.type === 'percentage' ? (itemTotal * item.discount.value / 100) : item.discount.value);
        }, 0);
        if (cart.generalDiscount.value > 0) {
            totalDiscount += cart.generalDiscount.type === 'percentage' ? ((subtotal - totalDiscount) * cart.generalDiscount.value / 100) : cart.generalDiscount.value;
        }
        const total = subtotal - totalDiscount;
        const totalCost = cart.items.reduce((sum, item) => sum + (item.cost * item.quantity), 0);
        const customerId = document.getElementById('customer-select').value;
        const saleDate = paymentDetails.isRetroactive && paymentDetails.date ? new Date(paymentDetails.date).toISOString() : new Date().toISOString();

        if (paymentDetails.status === 'Pago' && !paymentDetails.isRetroactive) {
            cashBalance += total;
        }
        
        const transaction = { id: Date.now(), type: 'venda', amount: total, cost: totalCost, description: `Venda de ${cart.items.reduce((s, i) => s + i.quantity, 0)} item(s)`, date: saleDate, items: [...cart.items], customerId: customerId ? parseInt(customerId) : null, ...paymentDetails, reversed: false, discount: totalDiscount };
        transactions.push(transaction);
        transactions.sort((a,b) => new Date(a.date) - new Date(b.date));

        if (paymentDetails.status === 'Pago') {
            showReceipt(transaction);
        }
        document.getElementById('customer-select').value = "";
        clearCart(); 
        updateCashBalance(); 
        showToast('Venda registada com sucesso!', 'success');
        saveData();
    }
    function processPaidSale(e) {
        e.preventDefault();
        const form = document.getElementById('payment-form');
        const method = form.elements.paymentMethod.value;
        const isRetroactive = form.elements.retroactiveSale.checked;
        const retroactiveDate = form.elements.retroactiveDate.value;
        processSale({ method: method, installments: method === 'Cartão de Crédito' ? parseInt(form.elements.paymentInstallments.value) : 1, status: 'Pago', isRetroactive, date: retroactiveDate });
        closeModal('modal-payment');
    }
    function processSaleAsUnpaid() {
        const form = document.getElementById('payment-form');
        const customerId = document.getElementById('customer-select').value;
        if (!customerId || parseInt(customerId) === 1) { showToast('Selecione um cliente válido (não "Cliente Balcão") para guardar como não pago.', 'error'); return; }
        const isRetroactive = form.elements.retroactiveSale.checked;
        const retroactiveDate = form.elements.retroactiveDate.value;
        processSale({ method: 'A Prazo', installments: 1, status: 'Não Pago', isRetroactive, date: retroactiveDate });
        closeModal('modal-payment');
    }
    function addProduct(name, price, cost, stock, categoryId) {
        if (products.some(p => p.name.toLowerCase() === name.toLowerCase())) { showToast('Produto já registado!', 'error'); return; }
        products.push({ id: Date.now(), name, price: parseFloat(price), cost: parseFloat(cost), stock: parseInt(stock), categoryId: parseInt(categoryId) });
        renderProducts(); showToast('Novo produto adicionado!'); saveData();
    }
    function addRawMaterial(name, stock, unit, totalCost, supplier, receiptDate) {
        if (rawMaterials.some(rm => rm.name.toLowerCase() === name.toLowerCase())) { showToast('Insumo já registado!', 'error'); return; }
        rawMaterials.push({ id: Date.now(), name, stock: parseFloat(stock), unit, totalCost: parseFloat(totalCost), supplier, receiptDate });
        renderRawMaterials(); showToast('Insumo adicionado!'); saveData();
    }
    function addCustomer(name, contact) {
        if (customers.some(c => c.name.toLowerCase() === name.toLowerCase())) { showToast('Cliente com este nome já existe.', 'error'); return; }
        customers.push({ id: Date.now(), name, contact });
        renderCustomers(); showToast('Novo cliente adicionado!'); saveData();
    }
    function handleCashFlow(type, amount, description) {
        if (type === 'saida' && amount > cashBalance) { showToast('Saldo insuficiente para esta saída!', 'error'); return; }
        cashBalance += (type === 'entrada' ? amount : -amount);
        transactions.push({ id: Date.now(), type, amount, description, date: new Date().toISOString() });
        updateCashBalance(); showToast(`Movimentação registada.`); saveData();
    }
    function deleteProduct() {
        const productId = parseInt(document.getElementById('edit-product-form').elements.productId.value);
        openConfirmationModal('Excluir Produto', 'Tem a certeza de que deseja excluir este produto? Esta ação não pode ser desfeita.', () => {
            products = products.filter(p => p.id !== productId);
            renderProducts(); if (!document.getElementById('modal-relatorios').classList.contains('hidden')) renderReports(currentReportPeriod);
            closeModal('modal-edit-produto'); showToast('Produto excluído com sucesso!'); saveData();
        });
    }
    function deleteRawMaterial(materialId) {
        openConfirmationModal('Excluir Insumo', 'Tem a certeza de que deseja excluir este insumo?', () => {
            rawMaterials = rawMaterials.filter(rm => rm.id !== materialId);
            renderRawMaterials(); showToast('Insumo excluído com sucesso!'); saveData();
        });
    }
    function deleteCustomer(customerId) {
        if (customerId === 1) { showToast('Não é possível excluir o cliente padrão.', 'error'); return; }
        if (transactions.some(t => t.customerId == customerId)) { showToast('Cliente não pode ser excluído pois está associado a vendas.', 'error'); return; }
        openConfirmationModal('Excluir Cliente', 'Tem a certeza de que deseja excluir este cliente?', () => {
            customers = customers.filter(c => c.id !== customerId);
            renderCustomers(); showToast('Cliente excluído com sucesso!'); saveData();
        });
    }
    function cancelSale(transactionId) {
        const sale = transactions.find(t => t.id === transactionId);
        if (!sale || sale.reversed) return;
        openConfirmationModal('Estornar Venda', 'Tem a certeza de que deseja estornar esta venda?', () => {
            sale.items.forEach(item => { const product = products.find(p => p.id === item.id); if (product) product.stock += item.quantity; });
            if (sale.status !== 'Não Pago') cashBalance -= sale.amount;
            sale.reversed = true;
            transactions.push({ id: Date.now(), type: 'estorno', amount: -sale.amount, description: `Estorno da venda #${sale.id}`, date: new Date().toISOString() });
            renderProducts(); updateCashBalance(); renderReports(currentReportPeriod);
            showToast('Venda estornada com sucesso!'); saveData();
        });
    }
    function deleteTransaction(transactionId) {
        openConfirmationModal('Excluir Venda Permanentemente?', 'Esta ação é irreversível e não pode ser desfeita. A venda será apagada do histórico. Deseja continuar?', () => {
            const saleIndex = transactions.findIndex(t => t.id === transactionId);
            if (saleIndex > -1) {
                transactions.splice(saleIndex, 1);
                showToast('Venda excluída com sucesso.', 'success');
                renderReports(currentReportPeriod);
                if (!document.getElementById('modal-cliente-detalhes').classList.contains('hidden')) {
                    const customerId = document.getElementById('modal-cliente-detalhes').dataset.customerId;
                    openCustomerDetailsModal(customerId);
                }
                saveData();
            } else {
                showToast('Venda não encontrada.', 'error');
            }
        });
    }
    function resetSystem() {
        openConfirmationModal('Zerar Todo o Sistema', 'Esta ação é irreversível e apagará TODOS os dados. Deseja continuar?', () => {
            localStorage.clear();
            products = [...sampleProducts]; rawMaterials = [...sampleRawMaterials]; customers = [{ id: 1, name: 'Cliente Balcão', contact: '' }];
            categories = [{ id: 1, name: 'Sem Categoria' }];
            transactions = []; cashBalance = 0;
            initializeApp();
            showToast('Sistema zerado com sucesso!', 'success');
            closeModal('modal-settings');
            saveData();
        });
    }
    function openModal(modalId) {
        if (modalId === 'modal-relatorios') { setReportPeriod(currentReportPeriod); renderSalesByCustomerReport(); }
        if(modalId === 'modal-contas-receber') renderUnpaidSales();
        if (modalId === 'modal-materiaprima') renderRawMaterials();
        if (modalId === 'modal-clientes') renderCustomers();
        if (modalId === 'modal-categorias') renderCategoriesManagement();
        if (modalId === 'modal-fechamento') renderCashClosingReport();
        if (modalId === 'modal-produto' || modalId === 'modal-edit-produto') populateCategoryDropdowns();
        const modal = document.getElementById(modalId);
        if (modal) { modal.classList.remove('hidden'); modal.classList.add('flex'); }
    }
    function closeModal(modalId) { const modal = typeof modalId === 'string' ? document.getElementById(modalId) : modalId; if (modal) { modal.classList.add('hidden'); modal.classList.remove('flex'); } }
    function openEditProductModal(productId) {
        const product = products.find(p => p.id === productId); if (!product) return;
        const form = document.getElementById('edit-product-form');
        form.elements.productId.value = product.id; form.elements.productName.value = product.name; form.elements.productPrice.value = product.price; form.elements.productCost.value = product.cost; form.elements.productStock.value = product.stock;
        populateCategoryDropdowns();
        form.elements.editProductCategory.value = product.categoryId;
        openModal('modal-edit-produto');
    }
    function openEditRawMaterialModal(materialId) {
        const material = rawMaterials.find(rm => rm.id === materialId); if (!material) return;
        const form = document.getElementById('edit-raw-material-form');
        form.elements.rawMaterialId.value = material.id;
        form.elements.rawMaterialName.value = material.name;
        form.elements.rawMaterialSupplier.value = material.supplier || '';
        form.elements.rawMaterialStock.value = material.stock;
        form.elements.rawMaterialUnit.value = material.unit;
        form.elements.rawMaterialTotalCost.value = material.totalCost;
        form.elements.rawMaterialReceiptDate.value = material.receiptDate ? new Date(material.receiptDate).toISOString().slice(0, 10) : '';
        openModal('modal-edit-materiaprima');
    }
    function openEditCustomerModal(customerId) {
        const customer = customers.find(c => c.id === customerId); if (!customer) return;
        const form = document.getElementById('edit-customer-form');
        form.elements.customerId.value = customer.id; form.elements.customerName.value = customer.name; form.elements.customerContact.value = customer.contact;
        openModal('modal-edit-cliente');
    }
    function openConfirmationModal(title, message, onConfirm) { document.getElementById('confirm-title').textContent = title; document.getElementById('confirm-message').textContent = message; confirmCallback = onConfirm; openModal('modal-confirm'); }
    function openPaymentModal() {
        const customerId = document.getElementById('customer-select').value;
        if (!customerId) { showToast('Por favor, selecione um cliente para continuar.', 'error'); return; }
        const subtotal = cart.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        let totalDiscount = cart.items.reduce((sum, item) => {
            const itemTotal = item.price * item.quantity;
            return sum + (item.discount.type === 'percentage' ? (itemTotal * item.discount.value / 100) : item.discount.value);
        }, 0);
        if (cart.generalDiscount.value > 0) {
            totalDiscount += cart.generalDiscount.type === 'percentage' ? ((subtotal - totalDiscount) * cart.generalDiscount.value / 100) : cart.generalDiscount.value;
        }
        const total = subtotal - totalDiscount;
        document.getElementById('payment-total').textContent = formatCurrency(total);
        document.getElementById('payment-amount-paid').value = total.toFixed(2);
        document.getElementById('payment-method').value = 'Dinheiro';
        document.getElementById('installments-group').classList.add('hidden');
        document.getElementById('amount-paid-group').classList.remove('hidden');
        document.getElementById('retroactive-sale-toggle').checked = false;
        document.getElementById('retroactive-date-group').classList.add('hidden');
        document.getElementById('payment-retroactive-date').value = '';
        updateChange(); openModal('modal-payment');
    }
    function updateChange() { 
        const subtotal = cart.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        let totalDiscount = cart.items.reduce((sum, item) => {
            const itemTotal = item.price * item.quantity;
            return sum + (item.discount.type === 'percentage' ? (itemTotal * item.discount.value / 100) : item.discount.value);
        }, 0);
        if (cart.generalDiscount.value > 0) {
            totalDiscount += cart.generalDiscount.type === 'percentage' ? ((subtotal - totalDiscount) * cart.generalDiscount.value / 100) : cart.generalDiscount.value;
        }
        const total = subtotal - totalDiscount;
        const paid = parseFloat(document.getElementById('payment-amount-paid').value) || 0;
        document.getElementById('payment-change').textContent = formatCurrency(paid - total > 0 ? paid - total : 0); 
    }
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        toast.children[0].textContent = message;
        toast.className = `fixed bottom-5 right-5 text-white px-6 py-3 rounded-lg shadow-lg transition-all duration-300 z-[200] ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
        toast.classList.remove('opacity-0', 'translate-y-10');
        setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-10'); }, 3000);
    }
    function showReceipt(transaction) {
        const receiptDetails = document.getElementById('receipt-details');
        receiptDetails.innerHTML = '';
        let subtotal = 0;
        transaction.items.forEach(item => { 
            const itemTotal = item.price * item.quantity;
            subtotal += itemTotal;
            receiptDetails.innerHTML += `<div class="flex justify-between"><span>${item.quantity}x ${item.name}</span><span>${formatCurrency(itemTotal)}</span></div>`; 
            if (item.discount && item.discount.value > 0) {
                const discountValue = item.discount.type === 'percentage' ? (itemTotal * item.discount.value / 100) : item.discount.value;
                receiptDetails.innerHTML += `<div class="flex justify-between text-xs text-red-500 pl-4"><span>&nbsp;&nbsp;Desconto</span><span>-${formatCurrency(discountValue)}</span></div>`;
            }
        });
         if (transaction.discount > 0 && transaction.items.some(i => i.discount.value > 0)) {
            // O desconto geral é mais complexo de mostrar se existirem descontos por item, por isso mostramos apenas o desconto total
        }
        receiptDetails.innerHTML += `<div class="mt-2 pt-2 border-t flex justify-between"><span>Subtotal</span><span>${formatCurrency(subtotal)}</span></div>`;
        receiptDetails.innerHTML += `<div class="flex justify-between text-red-500"><span>Descontos</span><span>-${formatCurrency(transaction.discount)}</span></div>`;
        receiptDetails.innerHTML += `<div class="font-semibold mt-2 pt-2 border-t border-[var(--border-color)]"><span>Forma de Pagamento:</span><span> ${transaction.method}${transaction.installments > 1 ? ` (${transaction.installments}x)` : ''}</span></div>`;
        document.getElementById('receipt-total').textContent = `TOTAL: ${formatCurrency(transaction.amount)}`;
        document.getElementById('receipt-date').textContent = new Date(transaction.date).toLocaleString('pt-BR');
        openModal('receipt-modal');
    }
    function applyTheme(themeName) {
        document.documentElement.setAttribute('data-theme', themeName);
        localStorage.setItem('theme', themeName);
        document.querySelectorAll('#theme-selector .theme-button').forEach(btn => btn.classList.remove('active'));
        const activeBtn = document.querySelector(`#theme-selector .theme-button[data-theme="${themeName}"]`);
        if(activeBtn) activeBtn.classList.add('active');
    }
    function renderUnpaidSales() {
        const list = document.getElementById('unpaid-sales-list');
        const unpaidSales = transactions.filter(t => t.type === 'venda' && t.status === 'Não Pago' && !t.reversed);
        if (unpaidSales.length === 0) { list.innerHTML = '<p class="text-center text-[var(--text-secondary)] mt-4">Nenhuma conta pendente.</p>'; return; }
        list.innerHTML = '';
        unpaidSales.forEach(sale => {
            const customer = customers.find(c => c.id === sale.customerId);
            list.innerHTML += `<div class="flex justify-between items-center p-3 border-b border-[var(--border-color)]"><div><p class="font-bold">${customer ? customer.name : 'Cliente desconhecido'}</p><p class="text-sm text-[var(--text-secondary)]">Venda de ${new Date(sale.date).toLocaleDateString('pt-BR')}</p></div><div class="text-right"><p class="font-bold text-lg text-red-500">${formatCurrency(sale.amount)}</p><button data-id="${sale.id}" class="receive-payment-btn text-sm text-green-600 hover:underline">Receber Pagamento</button></div></div>`;
        });
    }
    function openReceivePaymentModal(transactionId) {
        const sale = transactions.find(t => t.id === transactionId); if (!sale) return;
        const form = document.getElementById('receive-payment-form');
        form.elements.transactionId.value = sale.id;
        document.getElementById('receive-payment-total').textContent = formatCurrency(sale.amount);
        openModal('modal-receber-pagamento');
    }
    function handleReceivedPayment(e) {
        e.preventDefault();
        const form = document.getElementById('receive-payment-form');
        const sale = transactions.find(t => t.id == form.elements.transactionId.value); if (!sale) return;
        sale.status = 'Pago';
        sale.method = form.elements.paymentMethod.value;
        sale.installments = sale.method === 'Cartão de Crédito' ? parseInt(form.elements.paymentInstallments.value) : 1;
        transactions.push({ id: Date.now(), type: 'recebimento', amount: sale.amount, description: `Recebimento da venda #${sale.id}`, date: new Date().toISOString(), method: sale.method, installments: sale.installments });
        cashBalance += sale.amount;
        updateCashBalance(); renderUnpaidSales(); closeModal('modal-receber-pagamento');
        showToast('Pagamento recebido com sucesso!', 'success'); saveData();
    }
    function handleImportSales(e) {
        e.preventDefault();
        const file = document.getElementById('csv-file-input').files[0]; const logDiv = document.getElementById('import-log');
        if (!file) { showToast('Por favor, selecione um ficheiro.', 'error'); return; }
        const reader = new FileReader();
        reader.onload = function(event) {
            const rows = event.target.result.split('\n').filter(row => row.trim() !== ''); logDiv.innerHTML = '';
            let newTransactions = [];
            rows.forEach((row, index) => {
                const [dateStr, productIdStr, quantityStr, customerIdStr, paymentMethod, status] = row.split(',');
                const product = products.find(p => p.id == productIdStr); const customer = customers.find(c => c.id == customerIdStr);
                if (!dateStr || !product || !customer || !quantityStr || !paymentMethod || !status) { logDiv.innerHTML += `<p class="text-red-500">Linha ${index + 1}: Dados inválidos. (${row})</p>`; return; }
                product.stock -= parseInt(quantityStr);
                newTransactions.push({ id: new Date(dateStr).getTime() + index, type: 'venda', amount: product.price * parseInt(quantityStr), cost: product.cost * parseInt(quantityStr), description: `Venda importada`, date: new Date(dateStr).toISOString(), items: [{...product, quantity: parseInt(quantityStr)}], customerId: parseInt(customerIdStr), method: paymentMethod.trim(), installments: 1, status: status.trim(), reversed: false, discount: 0 });
            });
            transactions.push(...newTransactions);
            transactions.sort((a, b) => new Date(a.date) - new Date(b.date));
            showToast(`${newTransactions.length} vendas importadas!`, 'success');
            document.getElementById('csv-file-input').value = '';
            renderProducts(); saveData();
        };
        reader.readAsText(file);
    }
    function openSaleDetailsModal(transactionId) {
        const sale = transactions.find(t => t.id === transactionId); if (!sale) return;
        document.getElementById('details-id').textContent = sale.id;
        document.getElementById('details-date').textContent = new Date(sale.date).toLocaleString('pt-BR');
        document.getElementById('details-customer').textContent = customers.find(c => c.id === sale.customerId)?.name || 'Não identificado';
        const itemsTable = document.getElementById('details-items-table'); itemsTable.innerHTML = '';
        sale.items.forEach(item => itemsTable.innerHTML += `<tr><td class="p-2">${item.name}</td><td class="p-2 text-center">${item.quantity}</td><td class="p-2 text-right">${formatCurrency(item.price)}</td><td class="p-2 text-right">${formatCurrency(item.price * item.quantity)}</td></tr>`);
        const profit = sale.amount - sale.cost;
        document.getElementById('details-subtotal').textContent = formatCurrency(sale.amount + (sale.discount || 0));
        document.getElementById('details-cost').textContent = formatCurrency(sale.cost);
        document.getElementById('details-profit').textContent = formatCurrency(profit);
        document.getElementById('details-margin').textContent = `${(sale.amount > 0 ? (profit / sale.amount) * 100 : 0).toFixed(2)}%`;
        openModal('modal-venda-detalhes');
    }
    function openCustomerDetailsModal(customerId) {
        const customer = customers.find(c => c.id == customerId);
        if (!customer) { showToast("Cliente não encontrado.", "error"); return; }
        document.getElementById('modal-cliente-detalhes').dataset.customerId = customerId;
        document.getElementById('details-customer-name').textContent = customer.name;
        const customerSales = transactions.filter(t => t.customerId == customerId);
        const listContainer = document.getElementById('details-customer-sales-list');
        renderTransactionList(listContainer, customerSales);
        openModal('modal-cliente-detalhes');
    }
    function populateMonthYearSelectors() {
        const monthSelect = document.getElementById('report-month-select');
        const yearSelect = document.getElementById('report-year-select');
        const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        const currentYear = new Date().getFullYear();
        const currentMonth = new Date().getMonth();
        monthSelect.innerHTML = monthNames.map((m, i) => `<option value="${i}" ${i === currentMonth ? 'selected' : ''}>${m}</option>`).join('');
        yearSelect.innerHTML = '';
        for (let y = currentYear; y >= 2020; y--) {
            yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
        }
    }
    function renderTransactionList(container, transactionList) {
        container.innerHTML = '';
        if (transactionList.length === 0) {
            container.innerHTML = `<p class="text-center text-gray-500 mt-4">Nenhuma transação encontrada para este período.</p>`;
            return;
        }
        [...transactionList].reverse().forEach(t => {
            let color = '', icon = 'fa-question-circle', profitHtml = '', actionsHtml = '', paymentInfo = '', rowClass = '';
            if (t.type === 'venda') {
                icon = 'fa-shopping-cart';
                const profit = t.amount - (t.cost || 0);
                profitHtml = `<span class="text-xs ${profit >= 0 ? 'text-green-500' : 'text-red-500'}">Lucro: ${formatCurrency(profit)}</span>`;
                actionsHtml = `<button data-id="${t.id}" class="open-sale-details-btn text-xs text-blue-600 hover:underline mr-2">Detalhes</button>`;
                if (!t.reversed) {
                    actionsHtml += `<button data-id="${t.id}" class="cancel-sale-btn text-xs text-yellow-600 hover:underline mr-2">Estornar</button>`;
                } else {
                    actionsHtml += `<span class="text-xs text-gray-400 mr-2">Estornada</span>`;
                }
                actionsHtml += `<button data-id="${t.id}" class="edit-sale-btn text-xs text-purple-600 hover:underline">Editar</button>`;
                if (t.status === 'Não Pago') {
                    paymentInfo = ` &middot; <span class="font-bold">NÃO PAGO</span>`;
                    rowClass = 'bg-red-50 text-red-800';
                    color = 'text-red-600';
                } else {
                    color = 'text-[var(--secondary-600)]';
                    if (t.method) {
                        let badgeClass = '', methodText = t.method;
                        switch(t.method) {
                            case 'Dinheiro': badgeClass = 'badge-dinheiro'; break;
                            case 'Pix': badgeClass = 'badge-pix'; break;
                            case 'Cartão de Crédito': badgeClass = 'badge-credito'; methodText = `CRÉDITO ${t.installments > 1 ? `(${t.installments}x)` : ''}`; break;
                        }
                        paymentInfo = `<span class="payment-badge ${badgeClass}">${methodText}</span>`;
                    }
                }
            }
            if (t.type === 'entrada' || t.type === 'recebimento') { color = 'text-blue-600'; icon = 'fa-arrow-down'; }
            if (t.type === 'saida') { color = 'text-red-600'; icon = 'fa-arrow-up'; }
            if (t.type === 'estorno') { color = 'text-yellow-600'; icon = 'fa-undo'; }
            container.innerHTML += `<div class="flex justify-between items-center p-2 border-b border-[var(--border-color)] ${rowClass}"><div class="flex items-center gap-3"><i class="fas ${icon} ${color}"></i><div><p class="font-semibold capitalize">${t.description}</p><p class="text-sm flex items-center">${new Date(t.date).toLocaleString('pt-BR')}${paymentInfo}</p></div></div><div class="text-right"><div><p class="font-bold ${color}">${formatCurrency(t.amount)}</p>${profitHtml}</div><div class="mt-1">${actionsHtml}</div></div></div>`;
        });
    }

    // --- FUNÇÕES DE CATEGORIA ---
    function renderCategoryFilters() {
        const container = document.getElementById('category-filters');
        container.innerHTML = `<button data-category-id="all" class="category-filter-btn active px-3 py-1 text-sm border rounded-full border-[var(--border-color)]">Todas</button>`;
        categories.forEach(cat => {
            container.innerHTML += `<button data-category-id="${cat.id}" class="category-filter-btn px-3 py-1 text-sm border rounded-full border-[var(--border-color)]">${cat.name}</button>`;
        });
    }

    function renderCategoriesManagement() {
        const list = document.getElementById('categories-list');
        list.innerHTML = '';
        categories.forEach(cat => {
            const productCount = products.filter(p => p.categoryId === cat.id).length;
            list.innerHTML += `<div class="flex justify-between items-center p-2 border-b border-[var(--border-color)]"><p>${cat.name} <span class="text-sm text-[var(--text-secondary)]">(${productCount} produtos)</span></p><div><button data-id="${cat.id}" class="edit-category-btn text-blue-500 hover:text-blue-700 p-1"><i class="fas fa-edit"></i></button><button data-id="${cat.id}" class="delete-category-btn text-red-500 hover:text-red-700 p-1 ${cat.id === 1 ? 'hidden' : ''}"><i class="fas fa-trash"></i></button></div></div>`;
        });
    }

    function populateCategoryDropdowns() {
        const addSelect = document.getElementById('add-product-category');
        const editSelect = document.getElementById('edit-product-category');
        addSelect.innerHTML = '';
        editSelect.innerHTML = '';
        categories.forEach(cat => {
            addSelect.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
            editSelect.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
        });
    }

    function addCategory(name) {
        if (!name.trim()) { showToast('O nome da categoria não pode estar vazio.', 'error'); return; }
        if (categories.some(c => c.name.toLowerCase() === name.toLowerCase())) { showToast('Categoria já existe.', 'error'); return; }
        categories.push({ id: Date.now(), name });
        renderCategoriesManagement();
        renderCategoryFilters();
        showToast('Categoria adicionada!', 'success');
        saveData();
    }

    function openEditCategoryModal(categoryId) {
        const category = categories.find(c => c.id === categoryId); if (!category) return;
        const form = document.getElementById('edit-category-form');
        form.elements.categoryId.value = category.id;
        form.elements.categoryName.value = category.name;
        openModal('modal-edit-categoria');
    }
    
    function handleEditCategory(e) {
        e.preventDefault();
        const form = e.target;
        const categoryId = parseInt(form.elements.categoryId.value);
        const newName = form.elements.categoryName.value;
        const category = categories.find(c => c.id === categoryId);
        if (category) {
            category.name = newName;
            renderCategoriesManagement();
            renderCategoryFilters();
            closeModal('modal-edit-categoria');
            showToast('Categoria atualizada!', 'success');
            saveData();
        }
    }

    function deleteCategory(categoryId) {
        if (categoryId === 1) { showToast('Não pode excluir a categoria padrão.', 'error'); return; }
        openConfirmationModal('Excluir Categoria?', 'Os produtos nesta categoria serão movidos para "Sem Categoria". Deseja continuar?', () => {
            products.forEach(p => { if (p.categoryId === categoryId) p.categoryId = 1; });
            categories = categories.filter(c => c.id !== categoryId);
            renderCategoriesManagement();
            renderCategoryFilters();
            renderProducts();
            showToast('Categoria excluída.', 'success');
            saveData();
        });
    }

    // --- FUNÇÕES DE BACKUP E RESTAURAÇÃO ---
    function exportAllData() {
        const allData = { products, customers, transactions, cashBalance, rawMaterials, categories, theme: document.documentElement.getAttribute('data-theme'), backupDate: new Date().toISOString() };
        const dataStr = JSON.stringify(allData, null, 2); 
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob); const a = document.createElement('a');
        a.href = url; a.download = `backup-sistema-papelaria-${new Date().toISOString().slice(0, 10)}.json`; 
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(url); showToast("Backup exportado com sucesso!", "success");
    }
    function importAllData(event) {
        const file = event.target.files[0]; if (!file) { showToast("Nenhum ficheiro selecionado.", "error"); return; }
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                if (importedData.products && importedData.transactions && importedData.customers) {
                    openConfirmationModal('Restaurar Backup?', 'Isto substituirá TODOS os dados atuais. Esta ação é irreversível. Deseja continuar?', () => {
                        products = importedData.products || []; customers = importedData.customers || []; transactions = importedData.transactions || [];
                        cashBalance = importedData.cashBalance || 0; rawMaterials = importedData.rawMaterials || []; categories = importedData.categories || [{ id: 1, name: 'Sem Categoria' }];
                        if (importedData.theme) applyTheme(importedData.theme);
                        saveData(); initializeApp(); 
                        showToast("Backup restaurado com sucesso!", "success"); closeModal('modal-settings');
                    });
                } else { showToast("O ficheiro selecionado não parece ser um backup válido.", "error"); }
            } catch (error) { showToast("Erro ao ler o ficheiro de backup.", "error"); } 
            finally { event.target.value = ''; }
        };
        reader.readAsText(file);
    }
    function saveToGoogleSheets(isAuto = false) {
        if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL === 'COLE_A_URL_DO_SEU_APP_DA_WEB_AQUI') {
            if (!isAuto) showToast("URL do Google Script não configurada.", "error");
            return;
        }
        if (!isAuto) { showToast("A guardar na nuvem... Aguarde.", "success"); toggleLoading(true); }
        const allData = { products, customers, rawMaterials, transactions, cashBalance, categories };
        fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', cache: 'no-cache', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(allData), keepalive: true })
        .then(() => {
            if (!isAuto) { showToast("Dados enviados para a nuvem com sucesso!", "success"); }
            console.log("Save to cloud successful at " + new Date().toLocaleTimeString());
        })
        .catch(error => {
            if (!isAuto) { showToast("Falha ao guardar na nuvem. Verifique a sua conexão.", "error"); }
            console.error('Error saving to cloud:', error);
        })
        .finally(() => { if (!isAuto) { toggleLoading(false); } });
    }
    function loadFromGoogleSheets() {
        if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL === 'COLE_A_URL_DO_SEU_APP_DA_WEB_AQUI') {
            showToast("URL do Google Script não configurada.", "error");
            return;
        }
        openConfirmationModal(
            'Carregar Dados da Nuvem?',
            'Isto substituirá TODOS os dados atuais pelos dados guardados na sua Planilha Google. Deseja continuar?',
            () => {
                showToast("A carregar dados da nuvem... Aguarde.", "success");
                toggleLoading(true);
                fetch(GOOGLE_SCRIPT_URL)
                    .then(response => response.json())
                    .then(data => {
                        if (data.products && data.transactions) {
                            products = data.products || [];
                            customers = data.customers || [];
                            transactions = data.transactions || [];
                            cashBalance = data.cashBalance || 0;
                            rawMaterials = data.rawMaterials || [];
                            categories = data.categories || [{ id: 1, name: 'Sem Categoria' }];
                            saveData(); 
                            initializeApp();
                            closeModal('modal-settings');
                            showToast("Dados carregados da nuvem com sucesso!", "success");
                        } else {
                            throw new Error("Dados recebidos da nuvem são inválidos.");
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao carregar do Google Sheets:', error);
                        showToast("Falha ao carregar da nuvem. Verifique a sua conexão e as permissões do script.", "error");
                    })
                    .finally(() => {
                        toggleLoading(false);
                    });
            }
        );
    }
    function manageAutoSaveInterval(enable) {
        const FIVE_MINUTES = 300000;
        if (autoSaveInterval) clearInterval(autoSaveInterval);
        autoSaveInterval = null;
        if (enable) {
            isAutoSaveEnabled = true;
            autoSaveInterval = setInterval(() => saveToGoogleSheets(true), FIVE_MINUTES);
            console.log("Auto-save started. Saving every 5 minutes.");
        } else {
            isAutoSaveEnabled = false;
            console.log("Auto-save stopped.");
        }
    }
    function handleAutoSaveToggle(event) {
        const enabled = event.target.checked;
        manageAutoSaveInterval(enabled);
        localStorage.setItem('isAutoSaveEnabled', JSON.stringify(enabled));
        showToast(`Guardar automaticamente ${enabled ? 'ativado' : 'desativado'}.`, "success");
    }
    function initializeAutoSave() {
        isAutoSaveEnabled = JSON.parse(localStorage.getItem('isAutoSaveEnabled')) || false;
        document.getElementById('autosave-toggle').checked = isAutoSaveEnabled;
        if (isAutoSaveEnabled) {
            manageAutoSaveInterval(true);
        }
    }
    
    // --- LÓGICA DE EDIÇÃO DE VENDA ---
    function openEditSaleModal(transactionId) {
        const sale = transactions.find(t => t.id === transactionId);
        if (!sale) {
            showToast("Venda não encontrada.", "error");
            return;
        }

        const form = document.getElementById('edit-sale-form');
        form.elements.transactionId.value = sale.id;
        document.getElementById('edit-sale-total').textContent = formatCurrency(sale.amount);
        form.elements.saleStatus.value = sale.status;
        form.elements.paymentMethod.value = sale.method || 'A Prazo';
        form.elements.paymentInstallments.value = sale.installments || 1;

        const installmentsGroup = document.getElementById('edit-installments-group');
        installmentsGroup.classList.toggle('hidden', form.elements.paymentMethod.value !== 'Cartão de Crédito');

        openModal('modal-edit-venda');
    }

    function handleEditSale(e) {
        e.preventDefault();
        const form = document.getElementById('edit-sale-form');
        const transactionId = parseInt(form.elements.transactionId.value);
        const sale = transactions.find(t => t.id === transactionId);

        if (!sale) {
            showToast("Erro: Venda não encontrada.", "error");
            closeModal('modal-edit-venda');
            return;
        }

        const oldStatus = sale.status;
        const newStatus = form.elements.saleStatus.value;
        const newMethod = form.elements.paymentMethod.value;
        const newInstallments = parseInt(form.elements.paymentInstallments.value) || 1;

        // Ajusta o saldo de caixa com base na alteração de estado
        if (oldStatus === 'Não Pago' && newStatus === 'Pago') {
            cashBalance += sale.amount;
        } else if (oldStatus === 'Pago' && newStatus === 'Não Pago') {
            cashBalance -= sale.amount;
        }

        sale.status = newStatus;
        sale.method = newMethod;
        sale.installments = newInstallments;

        updateCashBalance();
        showToast("Venda atualizada com sucesso!", "success");
        closeModal('modal-edit-venda');
        
        // Atualiza as vistas do relatório se estiverem abertas
        if (!document.getElementById('modal-relatorios').classList.contains('hidden')) {
            renderReports(currentReportPeriod);
        }
        if (!document.getElementById('modal-cliente-detalhes').classList.contains('hidden')) {
            const customerId = document.getElementById('modal-cliente-detalhes').dataset.customerId;
            openCustomerDetailsModal(customerId);
        }
        if (!document.getElementById('modal-contas-receber').classList.contains('hidden')) {
            renderUnpaidSales();
        }

        saveData();
    }
    
    function switchView(viewId) {
        document.getElementById('dashboard-view').classList.add('hidden');
        document.getElementById('pos-view').classList.add('hidden');
        document.getElementById(viewId).classList.remove('hidden');
        document.querySelectorAll('.sidebar-item').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.view === viewId) {
                btn.classList.add('active');
            }
        });
        if (viewId === 'dashboard-view') {
            renderDashboard();
        }
        if (viewId === 'pos-view') {
            renderCategoryFilters();
        }
    }
    
    function renderDashboard() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todaysTransactions = transactions.filter(t => new Date(t.date) >= today && t.type === 'venda' && !t.reversed);
        const salesToday = todaysTransactions.reduce((sum, t) => sum + t.amount, 0);
        const profitToday = todaysTransactions.reduce((sum, t) => sum + (t.amount - (t.cost || 0)), 0);
        document.getElementById('kpi-sales-today').textContent = formatCurrency(salesToday);
        document.getElementById('kpi-profit-today').textContent = formatCurrency(profitToday);
        const lowStockCount = products.filter(p => p.stock > 0 && p.stock <= 10).length;
        document.getElementById('kpi-low-stock').textContent = `${lowStockCount} Produtos`;
        const unpaidAmount = transactions.filter(t => t.status === 'Não Pago' && !t.reversed).reduce((sum, t) => sum + t.amount, 0);
        document.getElementById('kpi-unpaid').textContent = formatCurrency(unpaidAmount);
        const recentTransactionsList = document.getElementById('recent-transactions-list');
        renderTransactionList(recentTransactionsList, transactions.slice(-5));
    }
    
    function openDiscountModal(itemIndex) {
        const form = document.getElementById('discount-form');
        form.reset();
        const title = document.getElementById('discount-modal-title');
        form.elements.itemIndex.value = itemIndex !== undefined ? itemIndex : '';
        if (itemIndex !== undefined) {
            title.textContent = `Desconto em ${cart.items[itemIndex].name}`;
            const currentDiscount = cart.items[itemIndex].discount;
            form.elements.discountType.value = currentDiscount.type;
            form.elements.discountValue.value = currentDiscount.value > 0 ? currentDiscount.value : '';
        } else {
            title.textContent = 'Desconto Geral na Venda';
            const currentDiscount = cart.generalDiscount;
            form.elements.discountType.value = currentDiscount.type;
            form.elements.discountValue.value = currentDiscount.value > 0 ? currentDiscount.value : '';
        }
        openModal('modal-desconto');
    }
    
    function handleDiscountForm(e) {
        e.preventDefault();
        const form = e.target;
        const itemIndex = form.elements.itemIndex.value;
        const type = form.elements.discountType.value;
        const value = parseFloat(form.elements.discountValue.value) || 0;

        if (itemIndex !== '') {
            cart.items[parseInt(itemIndex)].discount = { type, value };
        } else {
            cart.generalDiscount = { type, value };
        }
        renderCart();
        closeModal('modal-desconto');
    }

    // --- CENTRAL DE EVENT LISTENERS ---
    function addEventListeners() {
        // Submissão de Formulários
        document.getElementById('add-product-form').addEventListener('submit', function(e) { e.preventDefault(); addProduct(this.elements.productName.value, this.elements.productPrice.value, this.elements.productCost.value, this.elements.productStock.value, this.elements.productCategory.value); this.reset(); closeModal('modal-produto'); });
        document.getElementById('edit-product-form').addEventListener('submit', function(e) { e.preventDefault(); const p = products.find(p => p.id == this.elements.productId.value); if(p) { Object.assign(p, { name: this.elements.productName.value, price: parseFloat(this.elements.productPrice.value), cost: parseFloat(this.elements.productCost.value), stock: parseInt(this.elements.productStock.value), categoryId: parseInt(this.elements.editProductCategory.value) }); renderProducts(); if (!document.getElementById('modal-relatorios').classList.contains('hidden')) renderReports(currentReportPeriod); closeModal('modal-edit-produto'); showToast('Produto atualizado!'); saveData(); } });
        document.getElementById('add-category-form').addEventListener('submit', function(e) { e.preventDefault(); addCategory(this.elements.categoryName.value); this.reset(); });
        document.getElementById('edit-category-form').addEventListener('submit', handleEditCategory);
        document.getElementById('edit-raw-material-form').addEventListener('submit', function(e) { e.preventDefault(); const rm = rawMaterials.find(rm => rm.id == this.elements.rawMaterialId.value); if(rm) { Object.assign(rm, { name: this.elements.rawMaterialName.value, supplier: this.elements.rawMaterialSupplier.value, stock: parseFloat(this.elements.rawMaterialStock.value), unit: this.elements.rawMaterialUnit.value, totalCost: parseFloat(this.elements.rawMaterialTotalCost.value), receiptDate: this.elements.rawMaterialReceiptDate.value }); renderRawMaterials(); if (!document.getElementById('modal-relatorios').classList.contains('hidden')) renderReports(currentReportPeriod); closeModal('modal-edit-materiaprima'); showToast('Insumo atualizado!'); saveData(); } });
        document.getElementById('add-raw-material-form').addEventListener('submit', function(e) { e.preventDefault(); addRawMaterial(this.elements.rawMaterialName.value, this.elements.rawMaterialStock.value, this.elements.rawMaterialUnit.value, this.elements.rawMaterialTotalCost.value, this.elements.rawMaterialSupplier.value, this.elements.rawMaterialReceiptDate.value); this.reset(); });
        document.getElementById('edit-customer-form').addEventListener('submit', function(e) { e.preventDefault(); const c = customers.find(c => c.id == this.elements.customerId.value); if(c) { Object.assign(c, { name: this.elements.customerName.value, contact: this.elements.customerContact.value }); renderCustomers(); closeModal('modal-edit-cliente'); showToast('Cliente atualizado!'); saveData(); } });
        document.getElementById('add-customer-form').addEventListener('submit', function(e) { e.preventDefault(); addCustomer(this.elements.customerName.value, this.elements.customerContact.value); this.reset(); });
        document.getElementById('cash-flow-form').addEventListener('submit', function(e) { e.preventDefault(); handleCashFlow(this.elements.cashFlowType.value, parseFloat(this.elements.cashFlowAmount.value), this.elements.cashFlowDescription.value); this.reset(); closeModal('modal-caixa'); });
        document.getElementById('payment-form').addEventListener('submit', processPaidSale);
        document.getElementById('receive-payment-form').addEventListener('submit', handleReceivedPayment);
        document.getElementById('import-sales-form').addEventListener('submit', handleImportSales);
        document.getElementById('edit-sale-form').addEventListener('submit', handleEditSale);
        document.getElementById('discount-form').addEventListener('submit', handleDiscountForm);
        // Botões da Página Principal
        document.getElementById('checkout-button').addEventListener('click', openPaymentModal);
        document.getElementById('clear-cart-button').addEventListener('click', clearCart);
        document.getElementById('search-product').addEventListener('input', (e) => {
            const activeCategory = document.querySelector('.category-filter-btn.active');
            renderProducts(e.target.value, activeCategory.dataset.categoryId);
        });
        document.getElementById('open-settings-modal-btn').addEventListener('click', () => openModal('modal-settings'));
        document.getElementById('kpi-card-unpaid').addEventListener('click', () => openModal('modal-contas-receber'));
        // Abrir/Fechar Modais
        document.querySelectorAll('.open-modal-btn').forEach(btn => btn.addEventListener('click', () => openModal(btn.dataset.modalId)));
        document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', (e) => closeModal(e.target.closest('.modal-backdrop').id)));
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.addEventListener('click', (e) => { if (e.target === backdrop) closeModal(backdrop.id); }));
        // Modal de Confirmação
        document.getElementById('confirm-cancel-btn').addEventListener('click', () => closeModal('modal-confirm'));
        document.getElementById('confirm-confirm-btn').addEventListener('click', () => { if (typeof confirmCallback === 'function') confirmCallback(); closeModal('modal-confirm'); });
        // Modal de Configurações
        document.getElementById('reset-system-btn').addEventListener('click', resetSystem);
        document.getElementById('theme-selector').addEventListener('click', (e) => { const btn = e.target.closest('.theme-button'); if (btn) applyTheme(btn.dataset.theme); });
        // Botões de Backup
        document.getElementById('export-data-btn').addEventListener('click', exportAllData);
        document.getElementById('import-file-input').addEventListener('change', importAllData);
        document.getElementById('save-to-google-sheets-btn').addEventListener('click', () => saveToGoogleSheets(false));
        document.getElementById('load-from-google-sheets-btn').addEventListener('click', loadFromGoogleSheets);
        document.getElementById('autosave-toggle').addEventListener('change', handleAutoSaveToggle);
        window.addEventListener('beforeunload', () => { if (isAutoSaveEnabled) { saveToGoogleSheets(true); } });
        // Modal de Pagamento
        document.getElementById('payment-method').addEventListener('change', function() { document.getElementById('installments-group').classList.toggle('hidden', this.value !== 'Cartão de Crédito'); document.getElementById('amount-paid-group').classList.toggle('hidden', this.value === 'Cartão de Crédito'); });
        document.getElementById('receive-payment-method').addEventListener('change', function() { document.getElementById('receive-installments-group').classList.toggle('hidden', this.value !== 'Cartão de Crédito'); });
        document.getElementById('edit-sale-method').addEventListener('change', function() { document.getElementById('edit-installments-group').classList.toggle('hidden', this.value !== 'Cartão de Crédito'); });
        document.getElementById('payment-amount-paid').addEventListener('input', updateChange);
        document.getElementById('process-unpaid-sale-btn').addEventListener('click', processSaleAsUnpaid);
        document.getElementById('apply-general-discount-btn').addEventListener('click', () => openDiscountModal());
        document.getElementById('retroactive-sale-toggle').addEventListener('change', function() { document.getElementById('retroactive-date-group').classList.toggle('hidden', !this.checked); });
        // Botões de Impressão
        document.getElementById('print-receipt-btn').addEventListener('click', window.print);
        document.getElementById('print-details-btn').addEventListener('click', window.print);
        // Selectors de Relatório
        document.getElementById('report-month-select').addEventListener('change', () => renderReports('monthly', document.getElementById('report-month-select').value, document.getElementById('report-year-select').value));
        document.getElementById('report-year-select').addEventListener('change', () => renderReports('monthly', document.getElementById('report-month-select').value, document.getElementById('report-year-select').value));
        // Delegação de Eventos para Conteúdo Dinâmico
        document.body.addEventListener('click', e => {
            const target = e.target.closest('button, tr'); if (!target) return;
            const classList = target.classList; const dataset = target.dataset;
            if (classList.contains('increase-qty-btn')) increaseCartItemQuantity(dataset.index);
            else if (classList.contains('decrease-qty-btn')) decreaseCartItemQuantity(dataset.index);
            else if (classList.contains('remove-from-cart-btn')) removeFromCart(dataset.index);
            else if (classList.contains('edit-product-btn')) openEditProductModal(parseInt(dataset.id));
            else if (target.id === 'delete-product-btn') deleteProduct();
            else if (classList.contains('edit-category-btn')) openEditCategoryModal(parseInt(dataset.id));
            else if (classList.contains('delete-category-btn')) deleteCategory(parseInt(dataset.id));
            else if (classList.contains('edit-raw-material-btn')) openEditRawMaterialModal(parseInt(dataset.id));
            else if (classList.contains('delete-raw-material-btn')) deleteRawMaterial(parseInt(dataset.id));
            else if (classList.contains('edit-customer-btn')) openEditCustomerModal(parseInt(dataset.id));
            else if (classList.contains('delete-customer-btn')) deleteCustomer(parseInt(dataset.id));
            else if (classList.contains('open-sale-details-btn')) openSaleDetailsModal(parseInt(dataset.id));
            else if (classList.contains('cancel-sale-btn')) cancelSale(parseInt(dataset.id));
            else if (classList.contains('delete-sale-btn')) deleteTransaction(parseInt(dataset.id));
            else if (classList.contains('edit-sale-btn')) openEditSaleModal(parseInt(dataset.id));
            else if (classList.contains('receive-payment-btn')) openReceivePaymentModal(parseInt(dataset.id));
            else if (classList.contains('tab-button')) switchTab(dataset.tab);
            else if (classList.contains('period-button')) setReportPeriod(dataset.period);
            else if (classList.contains('customer-details-row')) openCustomerDetailsModal(dataset.customerId);
            else if (classList.contains('sidebar-item') || classList.contains('quick-action-btn')) {
                switchView(dataset.view);
            } else if (classList.contains('apply-item-discount-btn')) {
                openDiscountModal(parseInt(dataset.index));
            } else if (classList.contains('category-filter-btn')) {
                document.querySelectorAll('.category-filter-btn').forEach(btn => btn.classList.remove('active'));
                target.classList.add('active');
                renderProducts(document.getElementById('search-product').value, dataset.categoryId);
            }
        });
    }
</script>
</body>
</html>

