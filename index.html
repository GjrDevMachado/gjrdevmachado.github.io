<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão - MOLDART 3D (Online)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-primary: #ffffff; --bg-secondary: #f3f4f6; --bg-tertiary: #f9fafb;
            --text-primary: #1f2937; --text-secondary: #4b5563; --text-tertiary: #6b7280;
            --border-color: #e5e7eb;
            --primary-500: #6366f1; --primary-600: #4f46e5; --primary-700: #4338ca;
            --secondary-500: #10b981; --secondary-600: #059669; --secondary-700: #047857;
            --danger-500: #ef4444; --danger-600: #dc2626;
        }
        [data-theme="dark"] {
            --bg-primary: #1f2937; --bg-secondary: #111827; --bg-tertiary: #374151;
            --text-primary: #f9fafb; --text-secondary: #d1d5db; --text-tertiary: #9ca3af;
            --border-color: #374151;
        }
        [data-theme="ocean"] {
            --bg-primary: #eff6ff; --bg-secondary: #dbeafe; --bg-tertiary: #bfdbfe;
            --text-primary: #1e3a8a; --text-secondary: #1d4ed8; --text-tertiary: #1e40af;
            --border-color: #93c5fd;
            --primary-500: #3b82f6; --primary-600: #2563eb; --primary-700: #1d4ed8;
            --secondary-500: #2dd4bf; --secondary-600: #14b8a6; --secondary-700: #0d9488;
        }
        [data-theme="forest"] {
            --bg-primary: #f0fdf4; --bg-secondary: #dcfce7; --bg-tertiary: #bbf7d0;
            --text-primary: #14532d; --text-secondary: #166534; --text-tertiary: #15803d;
            --border-color: #86efac;
            --primary-500: #84cc16; --primary-600: #65a30d; --primary-700: #4d7c0f;
            --secondary-500: #22c55e; --secondary-600: #16a34a; --secondary-700: #15803d;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-secondary); color: var(--text-primary); }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); z-index: 50; }
        .modal { transition: opacity 0.3s ease, transform 0.3s ease; z-index: 100; background-color: var(--bg-primary); }
        .product-card { background-color: var(--bg-primary); transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
        .tab-button.active, .category-filter-btn.active { border-color: var(--primary-500); color: var(--primary-500); background-color: var(--bg-tertiary); }
        .period-button.active { background-color: var(--primary-500); color: white; }
        .theme-button.active { box-shadow: 0 0 0 3px var(--primary-500); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-600); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .payment-badge { padding: 2px 8px; border-radius: 9999px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; margin-left: 8px; display: inline-block; vertical-align: middle; }
        .badge-dinheiro { background-color: #d1fae5; color: #065f46; }
        .badge-pix { background-color: #cffafe; color: #0e7490; }
        .badge-credito { background-color: #dbeafe; color: #1e40af; }
        #modal-edit-produto, #modal-edit-materiaprima, #modal-edit-cliente, #modal-venda-antiga, #modal-importar-vendas, #modal-edit-categoria, #modal-edit-product-list { z-index: 110; }
        #modal-venda-detalhes, #modal-cliente-detalhes, #modal-edit-venda, #modal-desconto { z-index: 115; }
        #modal-confirm, #modal-contas-receber { z-index: 120; }
        #modal-receber-pagamento { z-index: 125; }
        #loading-overlay { z-index: 9999; }
        .toggle-checkbox:checked { right: 0; border-color: var(--secondary-500); background-color: white; }
        .toggle-checkbox:checked + .toggle-label { background-color: var(--secondary-500); }
        .toggle-checkbox { transition: all 0.2s ease-in-out; }
        .sidebar-item.active { background-color: var(--primary-600); color: white; }
        @media print {
            body * { visibility: hidden; }
            #receipt-modal, #receipt-modal *, #modal-venda-detalhes, #modal-venda-detalhes * { visibility: visible; }
            #receipt-modal, #modal-venda-detalhes { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none; }
        }
    </style>
</head>
<body class="antialiased">

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center hidden z-[9999]">
        <div class="loader"></div>
    </div>

    <div class="relative min-h-screen lg:flex">
        <nav id="sidebar" class="bg-[var(--bg-primary)] text-[var(--text-primary)] w-64 p-4 fixed inset-y-0 left-0 z-40
                                 transform -translate-x-full transition-transform duration-300
                                 lg:relative lg:translate-x-0 lg:shadow-lg">
            <div class="text-center mb-10">
                <h2 class="text-2xl font-bold text-[var(--primary-600)]">Gestão PDV</h2>
                <p class="text-sm text-[var(--text-secondary)]">Papelaria & 3D</p>
            </div>
            <ul class="space-y-2">
                <li><button data-view="dashboard-view" class="sidebar-item w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-[var(--primary-600)] hover:text-white transition-colors duration-200"><i class="fas fa-tachometer-alt w-5"></i> Dashboard</button></li>
                <li><button data-view="pos-view" class="sidebar-item w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-[var(--primary-600)] hover:text-white transition-colors duration-200"><i class="fas fa-cash-register w-5"></i> Ponto de Venda</button></li>
            </ul>
        </nav>

        <div id="sidebar-overlay" class="fixed inset-0 bg-black opacity-50 z-30 hidden lg:hidden"></div>

        <main class="flex-1 p-4 sm:p-6 lg:p-8 bg-[var(--bg-secondary)] overflow-y-auto">
            <header class="flex items-center justify-between mb-6">
                <button id="hamburger-btn" class="text-2xl text-[var(--text-secondary)] lg:hidden">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="lg:hidden"></div>
                
                <button id="open-settings-modal-btn" class="text-2xl text-[var(--text-secondary)] hover:text-[var(--primary-600)] transition-colors duration-200">
                    <i class="fas fa-cog"></i>
                </button>
            </header>

            <div id="dashboard-view" class="">
                <header class="mb-8">
                    <h1 class="text-3xl font-bold">Dashboard</h1>
                    <p class="text-[var(--text-secondary)]">Resumo do seu negócio em tempo real.</p>
                </header>

                <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
                    <div class="bg-[var(--bg-primary)] p-6 rounded-lg shadow-md flex items-center gap-4">
                        <div class="bg-green-100 p-3 rounded-full"><i class="fas fa-dollar-sign fa-2x text-green-600"></i></div>
                        <div>
                            <p class="text-sm text-[var(--text-secondary)]">Vendas Hoje</p>
                            <p id="kpi-sales-today" class="text-2xl font-bold">R$ 0,00</p>
                        </div>
                    </div>
                    <div class="bg-[var(--bg-primary)] p-6 rounded-lg shadow-md flex items-center gap-4">
                        <div class="bg-blue-100 p-3 rounded-full"><i class="fas fa-chart-line fa-2x text-blue-600"></i></div>
                        <div>
                            <p class="text-sm text-[var(--text-secondary)]">Lucro Hoje</p>
                            <p id="kpi-profit-today" class="text-2xl font-bold">R$ 0,00</p>
                        </div>
                    </div>
                    <div class="bg-[var(--bg-primary)] p-6 rounded-lg shadow-md flex items-center gap-4">
                        <div class="bg-purple-100 p-3 rounded-full"><i class="fas fa-receipt fa-2x text-purple-600"></i></div>
                        <div>
                            <p class="text-sm text-[var(--text-secondary)]">Ticket Médio (Hoje)</p>
                            <p id="kpi-avg-ticket" class="text-2xl font-bold">R$ 0,00</p>
                        </div>
                    </div>
                    <div id="kpi-card-unpaid" class="bg-[var(--bg-primary)] p-6 rounded-lg shadow-md flex items-center gap-4 cursor-pointer hover:shadow-xl transition-shadow">
                        <div class="bg-red-100 p-3 rounded-full"><i class="fas fa-file-invoice-dollar fa-2x text-red-600"></i></div>
                        <div>
                            <p class="text-sm text-[var(--text-secondary)]">Contas a Receber</p>
                            <p id="kpi-unpaid" class="text-2xl font-bold">R$ 0,00</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                    <div class="xl:col-span-1 bg-[var(--bg-primary)] p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-bold mb-4">Ações Rápidas</h3>
                        <div class="space-y-3">
                            <button data-view="pos-view" class="quick-action-btn w-full text-left bg-[var(--primary-600)] text-white px-4 py-3 rounded-lg shadow hover:bg-[var(--primary-700)] transition flex items-center gap-3"><i class="fas fa-cash-register w-5"></i> Nova Venda</button>
                            <button data-modal-id="modal-produto" class="open-modal-btn w-full text-left bg-[var(--secondary-600)] text-white px-4 py-3 rounded-lg shadow hover:bg-[var(--secondary-700)] transition flex items-center gap-3"><i class="fas fa-plus-circle w-5"></i> Adicionar Produto</button>
                            <button data-modal-id="modal-contas-receber" class="open-modal-btn w-full text-left bg-orange-500 text-white px-4 py-3 rounded-lg shadow hover:bg-orange-600 transition flex items-center gap-3"><i class="fas fa-file-invoice-dollar w-5"></i> Contas a Receber</button>
                            <button data-modal-id="modal-relatorios" class="open-modal-btn w-full text-left bg-gray-700 text-white px-4 py-3 rounded-lg shadow hover:bg-gray-800 transition flex items-center gap-3"><i class="fas fa-chart-bar w-5"></i> Ver Relatórios</button>
                        </div>
                    </div>
                    <div class="xl:col-span-2 bg-[var(--bg-primary)] p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-bold mb-4">Atividade Recente</h3>
                        <div id="recent-transactions-list" class="space-y-2">
                            <p class="text-center text-gray-500 mt-4">Nenhuma atividade recente.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="pos-view" class="hidden">
                 <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                    <div class="lg:col-span-3">
                        <header class="mb-4">
                            <h1 class="text-2xl lg:text-3xl font-bold">Ponto de Venda</h1>
                            <p class="text-[var(--text-secondary)]">Selecione produtos para adicionar ao caixa.</p>
                        </header>
                        
                        <div class="flex flex-wrap gap-2 sm:gap-3 mb-4">
                            <button data-modal-id="modal-produto" class="open-modal-btn bg-[var(--primary-600)] text-white px-3 py-2 text-sm sm:px-4 rounded-lg shadow hover:bg-[var(--primary-700)] transition flex items-center gap-2"><i class="fas fa-plus-circle"></i> Novo Produto</button>
                            <button data-modal-id="modal-categorias" class="open-modal-btn bg-teal-600 text-white px-3 py-2 text-sm sm:px-4 rounded-lg shadow hover:bg-teal-700 transition flex items-center gap-2"><i class="fas fa-tags"></i> Gerir Categorias</button>
                            <button data-modal-id="modal-materiaprima" class="open-modal-btn bg-[var(--secondary-600)] text-white px-3 py-2 text-sm sm:px-4 rounded-lg shadow hover:bg-[var(--secondary-700)] transition flex items-center gap-2"><i class="fas fa-boxes-stacked"></i> Estoque</button>
                            <button data-modal-id="modal-clientes" class="open-modal-btn bg-purple-600 text-white px-3 py-2 text-sm sm:px-4 rounded-lg shadow hover:bg-purple-700 transition flex items-center gap-2"><i class="fas fa-users"></i> Clientes</button>
                            <button data-modal-id="modal-contas-receber" class="open-modal-btn bg-orange-500 text-white px-3 py-2 text-sm sm:px-4 rounded-lg shadow hover:bg-orange-600 transition flex items-center gap-2"><i class="fas fa-file-invoice-dollar"></i> A Receber</button>
                        </div>
                        
                        <div class="mb-4 relative">
                            <input type="text" id="search-barcode" placeholder="BIPAR CÓDIGO DE BARRAS AQUI..." class="w-full p-3 pl-10 border-2 border-dashed border-[var(--primary-500)] rounded-lg bg-[var(--bg-tertiary)] text-center font-semibold">
                            <i class="fas fa-barcode absolute left-3 top-1/2 -translate-y-1/2 text-[var(--text-tertiary)] text-2xl"></i>
                        </div>
                        
                        <div class="mb-4 relative">
                            <input type="text" id="search-product" placeholder="Ou procurar produto por nome..." class="w-full p-2 pl-10 border rounded-lg bg-[var(--bg-primary)] border-[var(--border-color)]">
                            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-[var(--text-tertiary)]"></i>
                        </div>
                        
                        <div id="category-filters" class="mb-4 flex flex-wrap gap-2"></div>
                        
                        <div id="product-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
                    </div>

                    <div class="lg:col-span-2">
                        <div class="lg:sticky top-6">
                            <div class="bg-[var(--bg-primary)] shadow-lg rounded-lg flex flex-col p-4 sm:p-6">
                                 <div class="flex-grow">
                            <h2 class="text-xl lg:text-2xl font-bold mb-4 border-b pb-2 border-[var(--border-color)]">Caixa</h2>
                            <div class="mb-4">
    <label for="customer-select" ...>Associar Cliente (Obrigatório)</label>
    <select id="customer-select" ...></select>
</div>

<div id="customer-info-summary" class="hidden mt-2 p-3 bg-[var(--bg-tertiary)] rounded-lg text-sm border border-[var(--border-color)] space-y-1">
    </div>
                            
                            <div id="cart-items" class="space-y-3 mt-4 max-h-[40vh] overflow-y-auto"></div>
                        </div>
                                <div class="border-t border-[var(--border-color)] pt-4 mt-4 space-y-3 flex-shrink-0">
                                    <div class="flex justify-between font-medium text-lg"><span>Subtotal</span><span id="subtotal">R$ 0,00</span></div>
                                    <div class="flex justify-between font-medium text-lg text-red-500"><span>Descontos</span><span id="discounts-total">R$ 0,00</span></div>
                                    <div class="flex justify-between font-bold text-xl lg:text-2xl text-[var(--primary-600)]"><span>TOTAL</span><span id="total">R$ 0,00</span></div>
                                    <button id="apply-general-discount-btn" class="w-full text-[var(--primary-600)] border-2 border-[var(--primary-600)] py-2 rounded-lg hover:bg-[var(--primary-600)] hover:text-white transition-colors duration-200"><i class="fas fa-tags"></i> Aplicar Desconto Geral</button>
                                    <button id="checkout-button" class="w-full bg-[var(--primary-600)] text-white py-3 rounded-lg text-lg font-bold hover:bg-[var(--primary-700)]" disabled><i class="fas fa-check-circle"></i> Finalizar Venda</button>
                                    <button id="clear-cart-button" class="w-full bg-[var(--danger-500)] text-white py-2 rounded-lg hover:bg-[var(--danger-600)]"><i class="fas fa-times-circle"></i> Cancelar Venda</button>
                                </div>
                            </div>
                        </div>
                    </div>
                 </div>
            </div>
        </main>
    </div>

    <div id="modal-relatorios" class="fixed inset-0 hidden items-center justify-center modal-backdrop">
        <div class="modal w-[95%] max-w-6xl h-[90vh] flex flex-col rounded-lg shadow-xl p-4 sm:p-6 bg-[var(--bg-primary)]">
            <div class="flex justify-between items-center border-b pb-3 mb-4 flex-shrink-0">
                <h3 class="text-xl sm:text-2xl font-bold">Relatórios</h3>
                <button class="close-modal-btn text-2xl">&times;</button>
            </div>
            
            <div class="flex-grow overflow-y-auto pr-2">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between border-b mb-4 pb-2 gap-2">
                    <div id="report-period-buttons" class="flex flex-wrap gap-2">
                        <button class="period-button text-xs sm:text-sm py-2 px-3 rounded-md" data-period="daily">Diário</button>
                        <button class="period-button text-xs sm:text-sm py-2 px-3 rounded-md" data-period="weekly">Semanal</button>
                        <button class="period-button text-xs sm:text-sm py-2 px-3 rounded-md" data-period="monthly">Mensal</button>
                        <button class="period-button text-xs sm:text-sm py-2 px-3 rounded-md" data-period="annual">Anual</button>
                    </div>
                    <div id="month-year-selector" class="hidden flex items-center gap-2">
                         <select id="report-month-select" class="border rounded-md p-2 bg-[var(--bg-tertiary)] text-sm"></select>
                         <select id="report-year-select" class="border rounded-md p-2 bg-[var(--bg-tertiary)] text-sm"></select>
                    </div>
                </div>

                <div class="mb-4 border-b">
                    <button class="tab-button text-sm sm:text-base py-2 px-4 border-b-2" data-tab="vendas">Vendas</button>
                    <button class="tab-button text-sm sm:text-base py-2 px-4 border-b-2" data-tab="vendas-cliente">Por Cliente</button>
                    <button class="tab-button text-sm sm:text-base py-2 px-4 border-b-2" data-tab="desempenho-produtos">Produtos</button>
                 </div>

                <div id="tab-vendas" class="tab-content space-y-6">
                    <div id="sales-summary" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 text-center"></div>
                    <div class="relative h-64 sm:h-96 w-full mb-4">
                        <canvas id="salesChart"></canvas>
                    </div>
                    <div class="overflow-x-auto">
                        <div id="transactions-list" class="min-w-[600px]"></div>
                    </div>
                    <div class="overflow-x-auto">
                        <div id="annual-summary-table" class="min-w-[600px] hidden"></div>
                    </div>
                </div>

                <div id="tab-vendas-cliente" class="tab-content hidden overflow-x-auto">
                    <div class="min-w-[600px]"></div>
                </div>

                <div id="tab-desempenho-produtos" class="tab-content hidden overflow-x-auto">
                     <div class="min-w-[600px]"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-produto" class="fixed inset-0 hidden items-center justify-center modal-backdrop">
        <div class="modal w-full max-w-lg rounded-lg shadow-xl p-6 bg-[var(--bg-primary)]">
            <h3 class="text-xl font-bold mb-4">Adicionar Novo Produto</h3>
            <form id="add-product-form" class="space-y-4">
                <input type="text" name="productName" placeholder="Nome do Produto" class="w-full border rounded p-2 bg-[var(--bg-secondary)]" required>
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" name="productPrice" placeholder="Preço (R$)" step="0.01" class="w-full border rounded p-2 bg-[var(--bg-secondary)]" required>
                    <input type="number" name="productCost" placeholder="Custo (R$)" step="0.01" class="w-full border rounded p-2 bg-[var(--bg-secondary)]" required>
                </div>
                <input type="text" name="productBarcode" placeholder="Código de Barras (Opcional)" class="w-full border rounded p-2 bg-[var(--bg-secondary)]">
                <div>
                    <label for="add-product-category" class="block text-sm font-medium">Categoria</label>
                    <select id="add-product-category" name="productCategory" class="w-full border rounded p-2 mt-1 bg-[var(--bg-secondary)]"></select>
                </div>
                <div class="flex justify-end gap-3 mt-4">
                    <button type="button" class="close-modal-btn px-4 py-2 rounded bg-gray-300 text-gray-800">Cancelar</button>
                    <button type="submit" class="px-4 py-2 rounded bg-[var(--primary-600)] text-white">Salvar Produto</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-edit-produto" class="fixed inset-0 hidden items-center justify-center modal-backdrop">
         <div class="modal w-full max-w-lg rounded-lg shadow-xl p-6 bg-[var(--bg-primary)]">
            <h3 class="text-xl font-bold mb-4">Editar Produto</h3>
            <form id="edit-product-form" class="space-y-4">
                <input type="hidden" name="productId">
                <input type="text" name="productName" placeholder="Nome do Produto" class="w-full border rounded p-2 bg-[var(--bg-secondary)]" required>
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" name="productPrice" placeholder="Preço (R$)" step="0.01" class="w-full border rounded p-2 bg-[var(--bg-secondary)]" required>
                    <input type="number" name="productCost" placeholder="Custo (R$)" step="0.01" class="w-full border rounded p-2 bg-[var(--bg-secondary)]" required>
                </div>
                <input type="text" name="productBarcode" placeholder="Código de Barras (Opcional)" class="w-full border rounded p-2 bg-[var(--bg-secondary)]">
                <div>
                    <label for="edit-product-category" class="block text-sm font-medium">Categoria</label>
                    <select id="edit-product-category" name="editProductCategory" class="w-full border rounded p-2 mt-1 bg-[var(--bg-secondary)]"></select>
                </div>
                <div class="flex justify-between gap-3 mt-4">
                    <button type="button" id="delete-product-btn" class="px-4 py-2 rounded bg-[var(--danger-500)] text-white">Excluir</button>
                    <div>
                        <button type="button" class="close-modal-btn px-4 py-2 rounded bg-gray-300 text-gray-800">Cancelar</button>
                        <button type="submit" class="px-4 py-2 rounded bg-[var(--primary-600)] text-white">Salvar Alterações</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-categorias" class="fixed inset-0 hidden items-center justify-center modal-backdrop">
        <div class="modal w-full max-w-md rounded-lg shadow-xl p-6 bg-[var(--bg-primary)]">
            <h3 class="text-xl font-bold mb-4">Gerenciar Categorias</h3>
            <div id="categories-list" class="space-y-2 mb-4 max-h-60 overflow-y-auto"></div>
            <form id="add-category-form" class="flex gap-2 border-t pt-4">
                <input type="text" name="categoryName" class="w-full border rounded p-2 bg-[var(--bg-secondary)]" placeholder="Nome da nova categoria" required>
                <button type="submit" class="bg-[var(--primary-600)] text-white px-4 py-2 rounded">Adicionar</button>
            </form>
            <button type="button" class="close-modal-btn mt-4 w-full px-4 py-2 rounded bg-gray-300 text-gray-800">Fechar</button>
        </div>
    </div>
    <div id="modal-edit-categoria" class="fixed inset-0 hidden items-center justify-center modal-backdrop">
        <div class="modal w-full max-w-md rounded-lg shadow-xl p-6 bg-[var(--bg-primary)]">
            <h3 class="text-xl font-bold mb-4">Editar Categoria</h3>
            <form id="edit-category-form" class="space-y-3">
                <input type="hidden" name="categoryId">
                <input type="text" name="categoryName" class="w-full border rounded p-2 bg-[var(--bg-secondary)]" required>
                <div class="flex justify-end gap-3 mt-4">
                    <button type="button" class="close-modal-btn px-4 py-2 rounded bg-gray-300 text-gray-800">Cancelar</button>
                    <button type="submit" class="px-4 py-2 rounded bg-[var(--primary-600)] text-white">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-materiaprima" class="fixed inset-0 hidden items-center justify-center modal-backdrop">
        <div class="modal w-full max-w-4xl rounded-lg shadow-xl p-6 bg-[var(--bg-primary)]">
            <h3 class="text-xl font-bold mb-4">Gerenciar Estoque de Insumos</h3>
            <div id="raw-materials-list" class="max-h-80 overflow-y-auto"></div>
            <form id="add-raw-material-form" class="mt-4 border-t pt-4 space-y-3">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <input type="text" name="rawMaterialName" placeholder="Nome do Insumo" class="w-full border rounded p-2 bg-[var(--bg-secondary)]" required>
                    <input type="text" name="rawMaterialSupplier" placeholder="Fornecedor" class="w-full border rounded p-2 bg-[var(--bg-secondary)]">
                    <input type="date" name="rawMaterialReceiptDate" class="w-full border rounded p-2 bg-[var(--bg-secondary)]">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                     <input type="number" name="rawMaterialStock" placeholder="Quantidade" step="any" class="w-full border rounded p-2 bg-[var(--bg-secondary)]" required>
                     <input type="text" name="rawMaterialUnit" placeholder="Unidade (ex: kg, un, m)" class="w-full border rounded p-2 bg-[var(--bg-secondary)]" required>
                     <input type="number" name="rawMaterialTotalCost" placeholder="Custo Total (R$)" step="0.01" class="w-full border rounded p-2 bg-[var(--bg-secondary)]" required>
                </div>
                <div class="flex justify-end gap-3">
                     <button type="button" class="close-modal-btn px-4 py-2 rounded bg-gray-300 text-gray-800">Fechar</button>
                     <button type="submit" class="px-4 py-2 rounded bg-[var(--primary-600)] text-white">Adicionar ao Estoque</button>
                </div>
            </form>
        </div>
    </div>
    <div id="modal-edit-materiaprima" class="fixed inset-0 hidden items-center justify-center modal-backdrop">
        <div class="modal w-full max-w-4xl rounded-lg shadow-xl p-6 bg-[var(--bg-primary)]">
             <h3 class="text-xl font-bold mb-4">Editar Item de Estoque</h3>
             <form id="edit-raw-material-form" class="space-y-3">
                <input type="hidden" name="rawMaterialId">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <input type="text" name="rawMaterialName" placeholder="Nome do Insumo" class="w-full border rounded p-2 bg-[var(--bg-secondary)]" required>
                    <input type="text" name="rawMaterialSupplier" placeholder="Fornecedor" class="w-full border rounded p-2 bg-[var(--bg-secondary)]">
                    <input type="date" name="rawMaterialReceiptDate" class="w-full border rounded p-2 bg-[var(--bg-secondary)]">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                     <input type="number" name="rawMaterialStock" placeholder="Quantidade" step="any" class="w-full border rounded p-2 bg-[var(--bg-secondary)]" required>
                     <input type="text" name="rawMaterialUnit" placeholder="Unidade (ex: kg, un, m)" class="w-full border rounded p-2 bg-[var(--bg-secondary)]" required>
                     <input type="number" name="rawMaterialTotalCost" placeholder="Custo Total (R$)" step="0.01" class="w-full border rounded p-2 bg-[var(--bg-secondary)]" required>
                </div>
                <div class="flex justify-end gap-3">
                     <button type="button" class="close-modal-btn px-4 py-2 rounded bg-gray-300 text-gray-800">Cancelar</button>
                     <button type="submit" class="px-4 py-2 rounded bg-[var(--primary-600)] text-white">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-relatorios" class="fixed inset-0 hidden items-center justify-center modal-backdrop">
        <div class="modal w-full max-w-6xl h-[90vh] flex flex-col rounded-lg shadow-xl p-6 bg-[var(--bg-primary)]">
            <div class="flex justify-between items-center border-b pb-3 mb-4 flex-shrink-0">
                <h3 class="text-2xl font-bold">Relatórios</h3>
                <button class="close-modal-btn text-2xl">&times;</button>
            </div>
            
            <div class="flex-grow overflow-y-auto pr-4">
                <div class="flex flex-wrap items-center justify-between border-b mb-4 pb-2">
                    <div id="report-period-buttons" class="flex space-x-2 sm:space-x-4 mb-2">
                        <button class="period-button text-sm sm:text-base py-2 px-3 rounded-md" data-period="daily">Diário</button>
                        <button class="period-button text-sm sm:text-base py-2 px-3 rounded-md" data-period="weekly">Semanal</button>
                        <button class="period-button text-sm sm:text-base py-2 px-3 rounded-md" data-period="monthly">Mensal</button>
                        <button class="period-button text-sm sm:text-base py-2 px-3 rounded-md" data-period="annual">Anual</button>
                    </div>
                    <div id="month-year-selector" class="hidden flex items-center gap-2">
                         <select id="report-month-select" class="border rounded-md p-2 bg-[var(--bg-tertiary)]"></select>
                         <select id="report-year-select" class="border rounded-md p-2 bg-[var(--bg-tertiary)]"></select>
                    </div>
                </div>

                <div class="mb-4">
                    <button class="tab-button py-2 px-4 border-b-2" data-tab="vendas">Vendas</button>
                    <button class="tab-button py-2 px-4 border-b-2" data-tab="vendas-cliente">Vendas por Cliente</button>
                    <button class="tab-button py-2 px-4 border-b-2" data-tab="desempenho-produtos">Desempenho de Produtos</button>
                 </div>

                <div id="tab-vendas" class="tab-content">
                    <div id="sales-summary" class="mb-4"></div>
                    <div class="relative h-96 w-full mb-4">
                        <canvas id="salesChart"></canvas>
                    </div>
                    <div id="transactions-list" class="mt-4"></div>
                    <div id="annual-summary-table" class="mt-4 hidden"></div>
                </div>

                <div id="tab-vendas-cliente" class="tab-content hidden">
                    </div>

                <div id="tab-desempenho-produtos" class="tab-content hidden">
                    </div>
            </div>
        </div>
    </div>

    <div id="modal-clientes" class="fixed inset-0 hidden items-center justify-center modal-backdrop">
        <div class="modal w-full max-w-2xl rounded-lg shadow-xl p-6 bg-[var(--bg-primary)]">
            <div class="flex justify-between items-center border-b pb-3">
                <h3 class="text-xl font-bold">Gerenciar Clientes</h3>
                <button class="close-modal-btn text-2xl">&times;</button>
            </div>
            <div class="mt-4">
                <div id="customers-list" class="space-y-2 max-h-64 overflow-y-auto"></div>
            </div>
            <div class="mt-6 border-t pt-4">
                <h4 class="font-semibold mb-2">Adicionar Novo Cliente</h4>
                <form id="add-customer-form" class="flex gap-2">
                    <input type="text" name="customerName" placeholder="Nome do Cliente" class="flex-grow border rounded p-2 bg-[var(--bg-secondary)]" required>
                    <input type="text" name="customerContact" placeholder="Contato (Telefone/Email)" class="flex-grow border rounded p-2 bg-[var(--bg-secondary)]">
                    <button type="submit" class="bg-[var(--primary-600)] text-white px-4 py-2 rounded">Adicionar</button>
                </form>
            </div>
        </div>
    </div>
    <div id="modal-edit-cliente" class="fixed inset-0 hidden items-center justify-center modal-backdrop">
        <div class="modal w-full max-w-lg rounded-lg shadow-xl p-6 bg-[var(--bg-primary)]">
            <h3 class="text-xl font-bold mb-4">Editar Cliente</h3>
            <form id="edit-customer-form" class="space-y-3">
                <input type="hidden" name="customerId">
                <input type="text" name="customerName" class="w-full border rounded p-2 bg-[var(--bg-secondary)]" required>
                <input type="text" name="customerContact" class="w-full border rounded p-2 bg-[var(--bg-secondary)]">
                <div class="flex justify-end gap-3 mt-4">
                    <button type="button" class="close-modal-btn px-4 py-2 rounded bg-gray-300 text-gray-800">Cancelar</button>
                    <button type="submit" class="px-4 py-2 rounded bg-[var(--primary-600)] text-white">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-settings" class="fixed inset-0 hidden items-center justify-center modal-backdrop">
        <div class="modal w-full max-w-2xl rounded-lg shadow-xl p-6 bg-[var(--bg-primary)]">
            <h3 class="text-xl font-bold mb-4">Configurações</h3>
            <div class="space-y-4">
                <div>
                    <h4 class="font-semibold">Tema Visual</h4>
                    <div id="theme-selector" class="flex gap-3 mt-2">
                        <button class="theme-button w-10 h-10 rounded-full bg-gray-200" data-theme="light"></button>
                        <button class="theme-button w-10 h-10 rounded-full bg-gray-800" data-theme="dark"></button>
                        <button class="theme-button w-10 h-10 rounded-full bg-blue-200" data-theme="ocean"></button>
                        <button class="theme-button w-10 h-10 rounded-full bg-green-200" data-theme="forest"></button>
                    </div>
                </div>
                <div class="border-t pt-4">
                     <h4 class="font-semibold">Backup e Restauração</h4>
                     <div class="flex gap-3 mt-2">
                        <button id="export-data-btn" class="px-4 py-2 bg-green-600 text-white rounded">Exportar Backup (JSON)</button>
                        <label class="px-4 py-2 bg-blue-600 text-white rounded cursor-pointer">
                            Importar Backup (JSON)
                            <input type="file" id="import-file-input" class="hidden" accept=".json">
                        </label>
                     </div>
                </div>
                 <div class="border-t pt-4">
                     <h4 class="font-semibold">Backup na Nuvem (Google Sheets)</h4>
                     <div class="flex gap-3 mt-2">
                        <button id="save-to-google-sheets-btn" class="px-4 py-2 bg-green-600 text-white rounded">Salvar na Nuvem</button>
                        <button id="load-from-google-sheets-btn" class="px-4 py-2 bg-blue-600 text-white rounded">Carregar da Nuvem</button>
                     </div>
                      <div class="mt-2 space-y-1">
                        <div class="flex items-center gap-2"><input type="checkbox" id="autosave-toggle"><label for="autosave-toggle">Salvar na nuvem a cada 2 minutos</label></div>
                        <div class="flex items-center gap-2"><input type="checkbox" id="autoload-toggle"><label for="autoload-toggle">Carregar da nuvem ao iniciar</label></div>
                    </div>
                </div>
                <div class="border-t pt-4">
                     <h4 class="font-semibold text-[var(--danger-600)]">Área de Risco</h4>
                     <button id="reset-system-btn" class="mt-2 px-4 py-2 bg-[var(--danger-500)] text-white rounded">Zerar Todo o Sistema</button>
                </div>
            </div>
             <div class="flex justify-end mt-6">
                <button class="close-modal-btn px-4 py-2 rounded bg-gray-300 text-gray-800">Fechar</button>
            </div>
        </div>
    </div>

    <div id="modal-confirm" class="fixed inset-0 hidden items-center justify-center modal-backdrop">
        <div class="modal w-full max-w-sm rounded-lg shadow-xl p-6 bg-[var(--bg-primary)]">
            <h3 id="confirm-title" class="text-xl font-bold mb-2">Título</h3>
            <p id="confirm-message" class="mb-6">Mensagem</p>
            <div class="flex justify-end gap-3">
                <button id="confirm-cancel-btn" class="px-4 py-2 rounded bg-gray-300 text-gray-800">Cancelar</button>
                <button id="confirm-confirm-btn" class="px-4 py-2 rounded bg-[var(--danger-500)] text-white">Confirmar</button>
            </div>
        </div>
    </div>
    
    <div id="receipt-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="modal w-full max-w-sm rounded-lg shadow-xl p-6 bg-white text-black">
            <h3 class="text-xl font-bold text-center mb-4">Recibo</h3>
            <div id="receipt-details" class="text-sm space-y-1"></div>
            <p id="receipt-total" class="text-lg font-bold text-center my-4"></p>
            <p id="receipt-date" class="text-xs text-center text-gray-600"></p>
            <div class="flex justify-around mt-6 no-print">
                <button id="print-receipt-btn" class="px-4 py-2 bg-blue-600 text-white rounded">Imprimir</button>
                <button class="close-modal-btn px-4 py-2 bg-gray-300 text-gray-800 rounded">Fechar</button>
            </div>
        </div>
    </div>

    <div id="modal-payment" class="fixed inset-0 hidden items-center justify-center modal-backdrop">
         <div class="modal w-full max-w-md rounded-lg shadow-xl p-6 bg-[var(--bg-primary)]">
            <h3 class="text-xl font-bold mb-2">Finalizar Venda</h3>
            <p class="text-center text-4xl font-bold my-4" id="payment-total">R$ 0,00</p>
            <form id="payment-form" class="space-y-4">
                <div>
                    <label for="payment-method">Forma de Pagamento</label>
                    <select id="payment-method" name="paymentMethod" class="w-full border rounded p-2 mt-1 bg-[var(--bg-secondary)]">
                        <option>Dinheiro</option>
                        <option>Pix</option>
                        <option>Cartão de Crédito</option>
                    </select>
                </div>
                <div id="installments-group" class="hidden">
                    <label for="payment-installments">Parcelas</label>
                    <input type="number" id="payment-installments" name="paymentInstallments" value="1" min="1" class="w-full border rounded p-2 mt-1 bg-[var(--bg-secondary)]">
                </div>
                <div id="amount-paid-group">
                     <label for="payment-amount-paid">Valor Recebido (R$)</label>
                     <input type="number" id="payment-amount-paid" name="paymentAmount" step="0.01" class="w-full border rounded p-2 mt-1 bg-[var(--bg-secondary)]">
                </div>
                <div class="text-lg font-semibold flex justify-between">
                    <span>Troco:</span>
                    <span id="payment-change">R$ 0,00</span>
                </div>
                 <div class="flex items-center justify-between border-t pt-4">
                    <label for="retroactive-sale-toggle">É uma venda antiga?</label>
                    <input type="checkbox" id="retroactive-sale-toggle" name="retroactiveSale">
                </div>
                <div id="retroactive-date-group" class="hidden">
                    <label for="payment-retroactive-date">Data da Venda</label>
                    <input type="datetime-local" id="payment-retroactive-date" name="retroactiveDate" class="w-full border rounded p-2 mt-1 bg-[var(--bg-secondary)]">
                </div>
                <div class="flex flex-col gap-2 mt-4">
                    <button type="submit" class="w-full px-4 py-3 rounded bg-green-600 text-white font-bold">Confirmar Pagamento</button>
                    <button type="button" id="process-unpaid-sale-btn" class="w-full px-4 py-2 rounded bg-orange-500 text-white">Salvar como Não Pago</button>
                    <button type="button" class="close-modal-btn w-full px-4 py-2 rounded bg-gray-300 text-gray-800">Voltar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-contas-receber" class="fixed inset-0 hidden items-center justify-center modal-backdrop">
        <div class="modal w-full max-w-lg rounded-lg shadow-xl p-6 bg-[var(--bg-primary)]">
            <h3 class="text-xl font-bold mb-4">Contas a Receber</h3>
            <div id="unpaid-sales-list" class="max-h-96 overflow-y-auto"></div>
            <div class="flex justify-end mt-4">
                 <button type="button" class="close-modal-btn px-4 py-2 rounded bg-gray-300 text-gray-800">Fechar</button>
            </div>
        </div>
    </div>
    <div id="modal-receber-pagamento" class="fixed inset-0 hidden items-center justify-center modal-backdrop">
        <div class="modal w-full max-w-md rounded-lg shadow-xl p-6 bg-[var(--bg-primary)]">
            <h3 class="text-xl font-bold mb-2">Receber Pagamento</h3>
            <p class="text-center text-3xl font-bold my-4" id="receive-payment-total">R$ 0,00</p>
             <form id="receive-payment-form" class="space-y-4">
                <input type="hidden" name="transactionId">
                <div>
                    <label for="receive-payment-method">Forma de Pagamento</label>
                    <select id="receive-payment-method" name="paymentMethod" class="w-full border rounded p-2 mt-1 bg-[var(--bg-secondary)]">
                        <option>Dinheiro</option>
                        <option>Pix</option>
                        <option>Cartão de Crédito</option>
                    </select>
                </div>
                <div id="receive-installments-group" class="hidden">
                    <label for="receive-payment-installments">Parcelas</label>
                    <input type="number" id="receive-payment-installments" name="paymentInstallments" value="1" min="1" class="w-full border rounded p-2 mt-1 bg-[var(--bg-secondary)]">
                </div>
                <div class="flex justify-end gap-3 mt-4">
                    <button type="button" class="close-modal-btn px-4 py-2 rounded bg-gray-300 text-gray-800">Cancelar</button>
                    <button type="submit" class="px-4 py-2 rounded bg-green-600 text-white">Confirmar Recebimento</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-venda-detalhes" class="fixed inset-0 hidden items-center justify-center modal-backdrop">
        <div class="modal w-[95%] max-w-md rounded-lg shadow-xl p-6 bg-[var(--bg-primary)]">
            <h3 class="text-xl font-bold mb-4">Detalhes da Venda</h3>
            
            <div id="sale-details-content" class="space-y-2">
                </div>

            <div class="flex justify-end mt-4 no-print">
                <button id="print-details-btn" class="px-4 py-2 rounded bg-blue-600 text-white mr-2">Imprimir</button>
                <button class="close-modal-btn px-4 py-2 rounded bg-gray-300 text-gray-800">Fechar</button>
            </div>
        </div>
    </div>
    
    <div id="modal-cliente-detalhes" class="fixed inset-0 hidden items-center justify-center modal-backdrop">
        <div class="modal w-full max-w-4xl h-[80vh] flex flex-col rounded-lg shadow-xl p-6 bg-[var(--bg-primary)]">
            <h3 class="text-xl font-bold mb-4">Histórico de <span id="details-customer-name"></span></h3>
            <div id="details-customer-sales-list" class="flex-grow overflow-y-auto"></div>
             <div class="flex justify-end mt-4">
                <button class="close-modal-btn px-4 py-2 rounded bg-gray-300 text-gray-800">Fechar</button>
            </div>
        </div>
    </div>

    <div id="modal-edit-venda" class="fixed inset-0 hidden items-center justify-center modal-backdrop">
        <div class="modal w-full max-w-md rounded-lg shadow-xl p-6 bg-[var(--bg-primary)]">
            <h3 class="text-xl font-bold mb-2">Editar Venda</h3>
            <p class="text-center text-3xl font-bold my-4" id="edit-sale-total">R$ 0,00</p>
             <form id="edit-sale-form" class="space-y-4">
                <input type="hidden" name="transactionId">
                <div>
                    <label>Status</label>
                    <select name="saleStatus" class="w-full border rounded p-2 mt-1 bg-[var(--bg-secondary)]">
                        <option value="Pago">Pago</option>
                        <option value="Não Pago">Não Pago</option>
                    </select>
                </div>
                 <div>
                    <label for="edit-sale-method">Forma de Pagamento</label>
                    <select id="edit-sale-method" name="paymentMethod" class="w-full border rounded p-2 mt-1 bg-[var(--bg-secondary)]">
                        <option>A Prazo</option>
                        <option>Dinheiro</option>
                        <option>Pix</option>
                        <option>Cartão de Crédito</option>
                    </select>
                </div>
                <div id="edit-installments-group" class="hidden">
                    <label for="edit-payment-installments">Parcelas</label>
                    <input type="number" id="edit-payment-installments" name="paymentInstallments" value="1" min="1" class="w-full border rounded p-2 mt-1 bg-[var(--bg-secondary)]">
                </div>
                <div class="flex justify-end gap-3 mt-4">
                    <button type="button" class="close-modal-btn px-4 py-2 rounded bg-gray-300 text-gray-800">Cancelar</button>
                    <button type="submit" class="px-4 py-2 rounded bg-green-600 text-white">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="modal-desconto" class="fixed inset-0 hidden items-center justify-center modal-backdrop">
         <div class="modal w-full max-w-md rounded-lg shadow-xl p-6 bg-[var(--bg-primary)]">
            <h3 id="discount-modal-title" class="text-xl font-bold mb-4">Aplicar Desconto</h3>
            <form id="discount-form" class="space-y-4">
                <input type="hidden" name="itemIndex">
                <div>
                    <label>Tipo de Desconto</label>
                    <select name="discountType" class="w-full border rounded p-2 mt-1 bg-[var(--bg-secondary)]">
                        <option value="fixed">Valor Fixo (R$)</option>
                        <option value="percentage">Porcentagem (%)</option>
                    </select>
                </div>
                <div>
                    <label>Valor</label>
                    <input type="number" name="discountValue" step="0.01" class="w-full border rounded p-2 mt-1 bg-[var(--bg-secondary)]">
                </div>
                <div class="flex justify-end gap-3 mt-4">
                    <button type="button" class="close-modal-btn px-4 py-2 rounded bg-gray-300 text-gray-800">Cancelar</button>
                    <button type="submit" class="px-4 py-2 rounded bg-green-600 text-white">Aplicar Desconto</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-importar-vendas" class="fixed inset-0 hidden items-center justify-center modal-backdrop">
        <div class="modal w-full max-w-lg rounded-lg shadow-xl p-6 bg-[var(--bg-primary)]">
            <h3 class="text-xl font-bold mb-4">Importar Vendas de CSV</h3>
            <form id="import-sales-form">
                <input type="file" id="csv-file-input" accept=".csv">
                <button type="submit">Importar</button>
            </form>
            <div id="import-log" class="mt-4 text-sm max-h-40 overflow-y-auto"></div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 translate-y-10 transition-all duration-300 z-[200]">
        <span>Mensagem aqui</span>
    </div>

<script>
// ===================================================================================
// CONFIGURAÇÃO OPCIONAL: BACKUP NA NUVEM
// ===================================================================================
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxbiXuGirSCuAG4atOy9hPdGo_ZXlubcXPbUJnfxihWRPmM_4z5thJeqVZ_23H1_9246g/exec'; // INSIRA A URL DO SEU SCRIPT DO GOOGLE SHEETS AQUI

// --- DADOS EM MEMÓRIA ---
let products = [];
let customers = [];
let transactions = [];
let cashBalance = 0.00;
let rawMaterials = []; // Renomeado para Estoque na interface
let categories = [];
let cart = {
    items: [],
    generalDiscount: { type: 'fixed', value: 0 }
};
let salesChart;
let currentReportPeriod = 'weekly';
let confirmCallback = null;
let autoSaveInterval = null;
let isAutoSaveEnabled = false;
let isAutoLoadEnabled = false;
let areEventListenersAdded = false;

// --- FUNÇÕES DE PERSISTÊNCIA E INICIALIZAÇÃO ---
function saveData() {
    try {
        localStorage.setItem('products', JSON.stringify(products));
        localStorage.setItem('customers', JSON.stringify(customers));
        localStorage.setItem('transactions', JSON.stringify(transactions));
        localStorage.setItem('cashBalance', JSON.stringify(cashBalance));
        localStorage.setItem('rawMaterials', JSON.stringify(rawMaterials));
        localStorage.setItem('categories', JSON.stringify(categories));
        localStorage.setItem('theme', document.documentElement.getAttribute('data-theme'));
    } catch (error) {
        console.error("Erro ao guardar dados:", error);
        showToast("Não foi possível guardar os dados. O armazenamento pode estar cheio.", "error");
    }
}

function loadDataFromLocalStorage() {
    toggleLoading(true);
    try {
        categories = JSON.parse(localStorage.getItem('categories')) || [{ id: 1, name: 'Sem Categoria' }];
        products = JSON.parse(localStorage.getItem('products')) || [];
        rawMaterials = JSON.parse(localStorage.getItem('rawMaterials')) || [];
        customers = JSON.parse(localStorage.getItem('customers')) || [{ id: 1, name: 'Cliente Balcão', contact: '' }];
        transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        cashBalance = JSON.parse(localStorage.getItem('cashBalance')) || 0.00;
        const savedTheme = localStorage.getItem('theme') || 'light';
        applyTheme(savedTheme);

        transactions.forEach(t => {
            if (t.customerid !== undefined) { 
                t.customerId = t.customerid; 
                delete t.customerid;       
            }
        });

    } catch (error) {
        console.error("Erro ao carregar dados locais:", error);
        showToast("Erro ao carregar dados. A utilizar valores padrão.", "error");
    } finally {
        initializeAppUI();
        toggleLoading(false);
    }
}

function initializeAppUI() {
    switchView('dashboard-view');
    renderProducts();
    renderCart();
    updateCashBalance();
    renderCustomers();
    renderCategoryFilters();

    if (!areEventListenersAdded) {
        addEventListeners();
        areEventListenersAdded = true;
    }
    
    if (isAutoSaveEnabled) {
        manageAutoSaveInterval(true);
    }
}

window.onload = function() {
    try {
        isAutoSaveEnabled = JSON.parse(localStorage.getItem('isAutoSaveEnabled')) || false;
        isAutoLoadEnabled = JSON.parse(localStorage.getItem('isAutoLoadEnabled')) || false;
        
        const autosaveToggle = document.getElementById('autosave-toggle');
        const autoloadToggle = document.getElementById('autoload-toggle');

        if(autosaveToggle) autosaveToggle.checked = isAutoSaveEnabled;
        if(autoloadToggle) autoloadToggle.checked = isAutoLoadEnabled;

        if (isAutoLoadEnabled && GOOGLE_SCRIPT_URL) {
            loadFromGoogleSheets(true);
        } else {
            if(isAutoLoadEnabled) {
                console.warn("Carregamento automático da nuvem está ativado, mas a URL não foi configurada. A carregar dados locais.");
            }
            loadDataFromLocalStorage();
        }
    } catch (e) {
        alert("Ocorreu um erro crítico ao iniciar a aplicação. Por favor, limpe o cache do seu navegador e tente novamente. Erro: " + e.message);
        console.error("Erro fatal no window.onload:", e);
    }
};

// --- FUNÇÕES DE LÓGICA PRINCIPAL (vendas, produtos, etc.) ---
function addProduct(name, price, cost, categoryId, barcode) {
    if (products.some(p => p.name.toLowerCase() === name.toLowerCase())) { 
        showToast('Produto com este nome já está registado!', 'error'); 
        return; 
    }
    if (barcode && products.some(p => p.barcode === barcode)) {
        showToast('Este código de barras já está associado a outro produto!', 'error');
        return;
    }
    products.push({ 
        id: Date.now(), 
        name, 
        price: parseFloat(price), 
        cost: parseFloat(cost), 
        categoryId: parseInt(categoryId),
        barcode: barcode.trim()
    });
    renderProducts(); 
    showToast('Novo produto adicionado!'); 
    saveData();
}

function addByBarcode(barcode) {
    if (!barcode) return;
    const product = products.find(p => p.barcode && p.barcode === barcode);
    if (product) {
        addToCart(product.id);
    } else {
        showToast(`Produto com código de barras "${barcode}" não encontrado.`, 'error');
    }
}

// --- FUNÇÕES DE RENDERIZAÇÃO E UI ---
function formatCurrency(value) { return (value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }

function toggleLoading(isLoading) { document.getElementById('loading-overlay').classList.toggle('hidden', !isLoading); }

function renderProducts(filter = '', categoryId = 'all') {
    const productGrid = document.getElementById('product-grid');
    productGrid.innerHTML = '';
    
    let filteredProducts = products.filter(p => p.name.toLowerCase().includes(filter.toLowerCase()));
    if (categoryId !== 'all') {
        filteredProducts = filteredProducts.filter(p => p.categoryId == categoryId);
    }

    if (filteredProducts.length === 0) { 
        productGrid.innerHTML = `<p class="col-span-full text-center text-gray-500 mt-8">Nenhum produto encontrado.</p>`; 
        return; 
    }
    
    filteredProducts.forEach(product => {
        const card = document.createElement('div');
        card.className = `product-card relative p-4 rounded-lg shadow cursor-pointer hover:bg-[var(--bg-secondary)]`;
        card.setAttribute('title', product.name); 

        card.innerHTML = `
            <button data-id="${product.id}" class="edit-product-btn absolute bottom-1 right-1 text-blue-500 hover:text-blue-700 p-1 transition-colors z-10" title="Editar ${product.name}">
                <i class="fas fa-edit"></i>
            </button>
            <div class="flex flex-col h-full" data-action="add-to-cart" data-id="${product.id}">
                <h3 class="font-bold truncate mb-1">${product.name}</h3>
                <div class="mt-auto">
                    <p class="text-[var(--primary-600)] font-semibold">${formatCurrency(product.price)}</p>
                    <p class="text-xs text-red-500/80">Custo: ${formatCurrency(product.cost)}</p>
                </div>
            </div>
        `;
        
        productGrid.appendChild(card);
    });
}

function renderProductEditList(filter = '') {
    const container = document.getElementById('edit-product-list-container');
    container.innerHTML = '';

    const filtered = products.filter(p => p.name.toLowerCase().includes(filter.toLowerCase()));

    if (filtered.length === 0) {
        container.innerHTML = `<p class="text-center text-gray-500 mt-4">Nenhum produto encontrado.</p>`;
        return;
    }

    let tableHTML = `<table class="w-full text-left text-sm">
        <thead>
            <tr class="border-b">
                <th class="p-2">Produto</th>
                <th class="p-2">Categoria</th>
                <th class="p-2 text-right">Preço</th>
                <th class="p-2 text-right">Custo</th>
                <th class="p-2 text-center">Ações</th>
            </tr>
        </thead>
        <tbody>`;

    filtered.forEach(p => {
        const categoryName = categories.find(c => c.id == p.categoryId)?.name || 'N/A';
        tableHTML += `
            <tr class="border-b hover:bg-[var(--bg-tertiary)]">
                <td class="p-2 font-medium">${p.name}</td>
                <td class="p-2">${categoryName}</td>
                <td class="p-2 text-right">${formatCurrency(p.price)}</td>
                <td class="p-2 text-right text-red-500">${formatCurrency(p.cost)}</td>
                <td class="p-2 text-center">
                    <button data-id="${p.id}" class="edit-product-btn text-blue-500 p-1" title="Editar ${p.name}">
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
            </tr>`;
    });

    tableHTML += `</tbody></table>`;
    container.innerHTML = tableHTML;
}

function renderCart() {
    const cartItems = document.getElementById('cart-items');
    if (cart.items.length === 0) { cartItems.innerHTML = '<p class="text-center text-[var(--text-secondary)] mt-8">O caixa está vazio.</p>'; } 
    else {
        cartItems.innerHTML = '';
        cart.items.forEach((item, index) => {
            const itemTotal = item.price * item.quantity;
            let discountText = '';
            if (item.discount.value > 0) {
                const discountValue = item.discount.type === 'percentage' ? (itemTotal * item.discount.value / 100) : item.discount.value;
                discountText = `<span class="text-xs text-red-500">(-${formatCurrency(discountValue)})</span>`;
            }
            cartItems.innerHTML += `<div class="flex justify-between items-center bg-[var(--bg-tertiary)] p-3 rounded-lg"><div><p class="font-semibold">${item.name} ${discountText}</p><p class="text-sm text-[var(--text-secondary)]">${item.quantity} x ${formatCurrency(item.price)}</p></div><div class="flex items-center gap-3"><button data-index="${index}" class="apply-item-discount-btn text-blue-500 hover:text-blue-700"><i class="fas fa-tag"></i></button><button data-index="${index}" class="decrease-qty-btn w-6 h-6 bg-gray-200 rounded-full font-bold">-</button><span>${item.quantity}</span><button data-index="${index}" class="increase-qty-btn w-6 h-6 bg-gray-200 rounded-full font-bold">+</button><button data-index="${index}" class="remove-from-cart-btn text-[var(--danger-500)] hover:text-[var(--danger-600)] ml-2"><i class="fas fa-trash-alt"></i></button></div></div>`;
        });
    }
    document.getElementById('checkout-button').disabled = cart.items.length === 0;
    updateTotals();
}

 function renderRawMaterials() {
        const list = document.getElementById('raw-materials-list');
        list.innerHTML = '';
        if (rawMaterials.length === 0) { list.innerHTML = `<p class="text-center text-gray-500 mt-4">Nenhum item de estoque registado.</p>`; return; }
        list.innerHTML = `<div class="grid grid-cols-7 items-center p-2 border-b font-bold text-sm text-[var(--text-secondary)]"><p class="col-span-2">Nome</p><p>Fornecedor</p><p>Data</p><p>Qtd.</p><p>Custo Unit.</p><p class="text-right">Ações</p></div>`;
        rawMaterials.forEach(rm => {
            // CORRIGIDO: Usando 'rm.stock' que é o nome correto da propriedade
            const unitCost = (rm.totalCost && rm.stock > 0) ? rm.totalCost / rm.stock : 0;
            list.innerHTML += `<div class="grid grid-cols-7 items-center p-2 border-b border-[var(--border-color)] text-sm"><p class="col-span-2 font-medium">${rm.name}</p><p>${rm.supplier || 'N/A'}</p><p>${rm.receiptDate ? new Date(rm.receiptDate + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A'}</p><p>${rm.stock} ${rm.unit}</p><p class="font-semibold">${formatCurrency(unitCost)}</p><div class="justify-self-end"><button data-id="${rm.id}" class="edit-stock-item-btn text-blue-500 hover:text-blue-700 p-1"><i class="fas fa-edit"></i></button><button data-id="${rm.id}" class="delete-stock-item-btn text-red-500 hover:text-red-700 p-1"><i class="fas fa-trash"></i></button></div></div>`;
        });
    }

function renderCustomers() {
    const customersList = document.getElementById('customers-list');
    const customerSelect = document.getElementById('customer-select');
    customersList.innerHTML = '';
    customerSelect.innerHTML = '<option value="">Nenhum cliente selecionado</option>';
    customers.forEach(customer => {
        customersList.innerHTML += `<div class="flex justify-between items-center p-2 border-b border-[var(--border-color)]"><p>${customer.name} <span class="text-sm text-[var(--text-secondary)]">${customer.contact}</span></p><div><button data-id="${customer.id}" class="edit-customer-btn text-blue-500 hover:text-blue-700 p-1"><i class="fas fa-edit"></i></button><button data-id="${customer.id}" class="delete-customer-btn text-red-500 hover:text-red-700 p-1"><i class="fas fa-trash"></i></button></div></div>`;
        customerSelect.innerHTML += `<option value="${customer.id}">${customer.name}</option>`;
    });
}

function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`tab-${tabName}`).classList.remove('hidden');
    document.querySelector(`.tab-button[data-tab="${tabName}"]`).classList.add('active');
    if (tabName === 'vendas-cliente') renderSalesByCustomerReport();
    else if (tabName === 'desempenho-produtos') renderProductPerformanceReport();
    else if (['vendas', 'estoque-materias'].includes(tabName)) {
        populateMonthYearSelectors();
        renderReports(currentReportPeriod);
    }
}

function renderReports(period = currentReportPeriod, month, year) {
        try {
            const now = new Date();
            const annualSummaryTable = document.getElementById('annual-summary-table');
            const transactionsList = document.getElementById('transactions-list');
            let filteredTransactions, startDate;
            
            const monthYearSelector = document.getElementById('month-year-selector');
            if(monthYearSelector) {
                monthYearSelector.classList.toggle('hidden', period !== 'monthly');
            }

            if (period === 'annual') {
                startDate = new Date(now.getFullYear(), 0, 1);
                filteredTransactions = transactions.filter(t => new Date(t.date) >= startDate);
            } else if (period === 'monthly') {
                const selectedYear = parseInt(year) || now.getFullYear();
                const selectedMonth = parseInt(month) ?? now.getMonth();
                startDate = new Date(selectedYear, selectedMonth, 1);
                const endDate = new Date(selectedYear, selectedMonth + 1, 0);
                endDate.setHours(23, 59, 59, 999);
                filteredTransactions = transactions.filter(t => {
                    const transactionDate = new Date(t.date);
                    return transactionDate >= startDate && transactionDate <= endDate;
                });
            } else {
                switch(period) {
                    case 'daily': startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate()); break;
                    case 'weekly': default: startDate = new Date(); startDate.setDate(startDate.getDate() - 7); break;
                }
                 filteredTransactions = transactions.filter(t => new Date(t.date) >= startDate);
            }

            if(transactionsList) transactionsList.classList.toggle('hidden', period === 'annual');
            if(annualSummaryTable) annualSummaryTable.classList.toggle('hidden', period !== 'annual');
            
            const salesSummary = document.getElementById('sales-summary');
            const salesTransactions = filteredTransactions.filter(t => t.type === 'venda' && !t.reversed);

            const totalRevenue = salesTransactions.reduce((s, t) => s + t.amount, 0);
            const totalDiscounts = salesTransactions.reduce((s, t) => s + (t.discount || 0), 0);
            const grossRevenue = totalRevenue + totalDiscounts;
            const totalCost = salesTransactions.reduce((s, t) => s + (t.cost || 0), 0);
            const profit = totalRevenue - totalCost;

            if(salesSummary) {
                salesSummary.className = "grid grid-cols-2 md:grid-cols-5 gap-4 text-center mb-4";
                salesSummary.innerHTML = `
                    <div class="p-2 bg-[var(--bg-tertiary)] rounded-lg"><p class="text-sm text-[var(--text-secondary)]">Faturamento Bruto</p><p class="text-lg font-bold">${formatCurrency(grossRevenue)}</p></div>
                    <div class="p-2 bg-[var(--bg-tertiary)] rounded-lg"><p class="text-sm text-[var(--text-secondary)]">Total Descontos</p><p class="text-lg font-bold text-red-500">${formatCurrency(totalDiscounts)}</p></div>
                    <div class="p-2 bg-[var(--bg-tertiary)] rounded-lg"><p class="text-sm text-[var(--text-secondary)]">Custo Produtos</p><p class="text-lg font-bold text-[var(--danger-600)]">${formatCurrency(totalCost)}</p></div>
                    <div class="p-2 bg-[var(--bg-tertiary)] rounded-lg"><p class="text-sm text-[var(--text-secondary)]">Lucro Líquido</p><p class="text-lg font-bold text-[var(--secondary-600)]">${formatCurrency(profit)}</p></div>
                    <div class="p-2 bg-[var(--bg-tertiary)] rounded-lg"><p class="text-sm text-[var(--text-secondary)]">Margem de Lucro</p><p class="text-lg font-bold text-[var(--secondary-600)]">${(grossRevenue > 0 ? (profit / grossRevenue) * 100 : 0).toFixed(2)}%</p></div>
                `;
            }

            if (period !== 'annual') {
                renderTransactionList(transactionsList, filteredTransactions);
            }
            
            const salesData = { labels: [], datasets: [ { label: 'Vendas Pagas', data: [], backgroundColor: 'rgba(5, 150, 105, 0.6)' }, { label: 'Vendas Não Pagas', data: [], backgroundColor: 'rgba(220, 38, 38, 0.6)' } ] };
            if (period === 'annual') {
                const monthNames = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
                const monthlyData = Array(12).fill(0).map(() => ({ paid: 0, unpaid: 0, cost: 0, discount: 0 }));
                
                salesTransactions.forEach(t => {
                    const month = new Date(t.date).getMonth();
                    if (t.status === 'Não Pago') monthlyData[month].unpaid += t.amount;
                    else monthlyData[month].paid += t.amount;
                    monthlyData[month].cost += (t.cost || 0);
                    monthlyData[month].discount += (t.discount || 0);
                });
                
                salesData.labels = monthNames;
                salesData.datasets[0].data = monthlyData.map(m => m.paid);
                salesData.datasets[1].data = monthlyData.map(m => m.unpaid);
                
                if(annualSummaryTable) {
                    annualSummaryTable.innerHTML = `<table class="w-full text-left text-sm"><thead><tr class="border-b border-[var(--border-color)]"><th class="p-2">Mês</th><th class="text-right">Fat. Bruto</th><th class="text-right">Descontos</th><th class="text-right">Custo</th><th class="text-right">Lucro Líquido</th><th class="text-right">Margem %</th></tr></thead><tbody></tbody></table>`;
                    const annualTbody = annualSummaryTable.querySelector('tbody');
                    monthlyData.forEach((monthData, index) => {
                        const totalPaidAndUnpaid = monthData.paid + monthData.unpaid;
                        const grossMonthRevenue = totalPaidAndUnpaid + monthData.discount;
                        const profit = totalPaidAndUnpaid - monthData.cost;
                        const profitPercentage = grossMonthRevenue > 0 ? (profit / grossMonthRevenue) * 100 : 0;
                        annualTbody.innerHTML += `<tr><td class="p-2 font-semibold">${monthNames[index]}</td><td class="text-right">${formatCurrency(grossMonthRevenue)}</td><td class="text-right text-red-600">${formatCurrency(monthData.discount)}</td><td class="text-right">${formatCurrency(monthData.cost)}</td><td class="text-right ${profit >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(profit)}</td><td class="text-right ${profit >= 0 ? 'text-green-600' : 'text-red-600'}">${profitPercentage.toFixed(2)}%</td></tr>`;
                    });
                }
            } else {
                const salesByDate = {};
                let loopDate = new Date(startDate);
                let endDate = (period === 'monthly') ? new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0) : new Date();

                while(loopDate <= endDate) {
                     salesByDate[loopDate.toISOString().split('T')[0]] = { paid: 0, unpaid: 0 };
                     loopDate.setDate(loopDate.getDate() + 1);
                }

                salesTransactions.forEach(t => {
                    const key = new Date(t.date).toISOString().split('T')[0];
                    if(salesByDate[key]) {
                        if (t.status === 'Não Pago') salesByDate[key].unpaid += t.amount;
                        else salesByDate[key].paid += t.amount;
                    }
                });

                if (period === 'daily') {
                    salesData.labels.push('Hoje');
                    const dailyTotals = Object.values(salesByDate).reduce((acc, curr) => ({ paid: acc.paid + curr.paid, unpaid: acc.unpaid + curr.unpaid }), { paid: 0, unpaid: 0 });
                    salesData.datasets[0].data.push(dailyTotals.paid);
                    salesData.datasets[1].data.push(dailyTotals.unpaid);
                } else {
                    for(const [day, totals] of Object.entries(salesByDate)) {
                        salesData.labels.push(new Date(day + 'T00:00:00').toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'}));
                        salesData.datasets[0].data.push(totals.paid);
                        salesData.datasets[1].data.push(totals.unpaid);
                    }
                }
            }
            
            const canvas = document.getElementById('salesChart');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                if (salesChart) salesChart.destroy();
                salesChart = new Chart(ctx, { type: 'bar', data: salesData, options: { scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } } });
            }

            // =================================================================
            // CÓDIGO PROBLEMÁTICO REMOVIDO DESTA FUNÇÃO
            // O código que tentava renderizar a lista de estoque foi apagado.
            // =================================================================

        } catch (error) { 
            console.error("Erro ao renderizar relatórios:", error); 
            showToast("Ocorreu um erro ao gerar o relatório.", "error"); 
        }
    }

function renderSalesByCustomerReport() {
    const container = document.getElementById('tab-vendas-cliente');
    const salesByCustomer = transactions.filter(t => t.type === 'venda' && !t.reversed).reduce((acc, sale) => {
        const customerId = sale.customerId || 'unknown';
        if (!acc[customerId]) { 
            acc[customerId] = { 
                paid: 0, 
                unpaid: 0, 
                total: 0, 
                count: 0, 
                customerName: customers.find(c => c.id == customerId)?.name || 'Cliente Não Identificado' 
            }; 
        }
        acc[customerId].total += sale.amount; acc[customerId].count++;
        if (sale.status === 'Não Pago') acc[customerId].unpaid += sale.amount; else acc[customerId].paid += sale.amount;
        return acc;
    }, {});
    let tableHtml = `<table class="w-full text-left mt-4"><thead><tr class="border-b"><th class="p-2">Cliente</th><th class="text-right">Total Comprado</th><th class="text-right">Total Pago</th><th class="text-right">Total Devido</th><th class="text-center">Nº de Vendas</th></tr></thead><tbody>`;
    Object.entries(salesByCustomer).sort(([,a],[,b]) => b.total - a.total).forEach(([customerId, data]) => {
        tableHtml += `<tr class="hover:bg-[var(--bg-secondary)] cursor-pointer customer-details-row" data-customer-id="${customerId}"><td class="p-2 font-semibold">${data.customerName}</td><td class="text-right">${formatCurrency(data.total)}</td><td class="text-right text-green-600">${formatCurrency(data.paid)}</td><td class="text-right text-red-600">${formatCurrency(data.unpaid)}</td><td class="text-center">${data.count}</td></tr>`;
    });
    container.innerHTML = tableHtml + '</tbody></table>';
}

function renderCashClosingReport() {
    const today = new Date(); today.setHours(0,0,0,0);
    const todaysTransactions = transactions.filter(t => new Date(t.date) >= today);
    const summary = { totalSales: 0, totalCost: 0, byMethod: { 'Dinheiro': 0, 'Pix': 0, 'Cartão de Crédito': 0 } };
    todaysTransactions.filter(t => t.type === 'venda' && t.status !== 'Não Pago' && !t.reversed).forEach(sale => {
        summary.totalSales += sale.amount;
        summary.totalCost += sale.cost || 0;
        if (sale.method) summary.byMethod[sale.method] += sale.amount;
    });
    todaysTransactions.filter(t => t.type === 'recebimento').forEach(receipt => {
        summary.totalSales += receipt.amount;
        if (receipt.method) summary.byMethod[receipt.method] += receipt.amount;
    });
    document.getElementById('cash-closing-summary').innerHTML = `<div class="flex justify-between border-b pb-2 border-[var(--border-color)]"><span class="font-semibold">Total de Vendas Pagas do Dia:</span><span class="font-bold text-[var(--primary-600)]">${formatCurrency(summary.totalSales)}</span></div><div class="flex justify-between"><span class="text-sm">Lucro Líquido (de vendas pagas hoje):</span><span class="text-sm font-semibold text-[var(--secondary-600)]">${formatCurrency(summary.totalSales - summary.totalCost)}</span></div><div class="pt-4 mt-4 border-t border-[var(--border-color)]"><h4 class="font-semibold mb-2">Recebimentos por Forma de Pagamento:</h4><div class="flex justify-between text-sm"><span>Dinheiro:</span><span>${formatCurrency(summary.byMethod['Dinheiro'])}</span></div><div class="flex justify-between text-sm"><span>Pix:</span><span>${formatCurrency(summary.byMethod['Pix'])}</span></div><div class="flex justify-between text-sm"><span>Cartão de Crédito:</span><span>${formatCurrency(summary.byMethod['Cartão de Crédito'])}</span></div></div>`;
}

function renderProductPerformanceReport() {
    const container = document.getElementById('tab-desempenho-produtos');
    const productPerformance = {};

    transactions.filter(t => t.type === 'venda' && !t.reversed).forEach(sale => {
        sale.items.forEach(item => {
            if (!productPerformance[item.id]) {
                productPerformance[item.id] = {
                    name: item.name,
                    quantitySold: 0,
                    totalRevenue: 0,
                    totalCost: 0,
                    totalProfit: 0
                };
            }
            const performance = productPerformance[item.id];
            performance.quantitySold += item.quantity;
            const revenue = item.price * item.quantity;
            const cost = item.cost * item.quantity;
            performance.totalRevenue += revenue;
            performance.totalCost += cost;
            performance.totalProfit += revenue - cost;
        });
    });

    const performanceArray = Object.values(productPerformance);
    const allProducts = products.map(p => ({
        name: p.name,
        quantitySold: productPerformance[p.id]?.quantitySold || 0,
        totalRevenue: productPerformance[p.id]?.totalRevenue || 0,
        totalProfit: productPerformance[p.id]?.totalProfit || 0
    }));

    const mostSold = [...allProducts].sort((a, b) => b.quantitySold - a.quantitySold).slice(0, 5);
    const mostProfitable = [...allProducts].sort((a, b) => b.totalProfit - a.totalProfit).slice(0, 5);
    const unsold = products.filter(p => !productPerformance[p.id]).map(p => ({ name: p.name }));

    container.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-4">
            <div>
                <h3 class="text-xl font-semibold mb-3">Top 5 Produtos Mais Vendidos</h3>
                ${createPerformanceTable(mostSold, ['#', 'Produto', 'Qtd. Vendida', 'Receita Total'], ['quantitySold', 'totalRevenue'])}
            </div>
            <div>
                <h3 class="text-xl font-semibold mb-3">Top 5 Produtos Mais Lucrativos</h3>
                ${createPerformanceTable(mostProfitable, ['#', 'Produto', 'Lucro Total', 'Receita Total'], ['totalProfit', 'totalRevenue'])}
            </div>
        </div>
        <div class="mt-8">
            <h3 class="text-xl font-semibold mb-3">Produtos Sem Vendas</h3>
            ${createPerformanceTable(unsold, ['Produto'], [], false)}
        </div>
    `;
}

function createPerformanceTable(data, headers, dataKeys, includeRank = true) {
    if (data.length === 0) return '<p class="text-gray-500">Nenhum dado disponível.</p>';
    let table = '<table class="w-full text-left text-sm"><thead><tr class="border-b">';
    headers.forEach(h => table += `<th class="p-2">${h}</th>`);
    table += '</tr></thead><tbody>';
    data.forEach((item, index) => {
        table += '<tr class="border-b">';
        if (includeRank) table += `<td class="p-2">${index + 1}</td>`;
        table += `<td class="p-2 font-medium">${item.name}</td>`;
        dataKeys.forEach(key => {
            table += `<td class="p-2">${typeof item[key] === 'number' ? formatCurrency(item[key]) : item[key]}</td>`;
        });
        table += '</tr>';
    });
    table += '</tbody></table>';
    return table;
}

function setReportPeriod(period) {
    currentReportPeriod = period;
    document.querySelectorAll('#report-period-buttons .period-button').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`#report-period-buttons .period-button[data-period="${period}"]`).classList.add('active');
    
    if (period === 'monthly') {
        populateMonthYearSelectors();
        const now = new Date();
        renderReports(period, now.getMonth(), now.getFullYear()); 
    } else {
        renderReports(period);
    }
}
function updateTotals() {
    const subtotal = cart.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    let totalDiscount = cart.items.reduce((sum, item) => {
        const itemTotal = item.price * item.quantity;
        if (item.discount.value > 0) {
            return sum + (item.discount.type === 'percentage' ? (itemTotal * item.discount.value / 100) : item.discount.value);
        }
        return sum;
    }, 0);
    if (cart.generalDiscount.value > 0) {
        totalDiscount += cart.generalDiscount.type === 'percentage' ? ((subtotal - totalDiscount) * cart.generalDiscount.value / 100) : cart.generalDiscount.value;
    }
    const total = subtotal - totalDiscount;

    document.getElementById('subtotal').textContent = formatCurrency(subtotal);
    document.getElementById('discounts-total').textContent = formatCurrency(-totalDiscount);
    document.getElementById('total').textContent = formatCurrency(total);
}
function updateCashBalance() { 
    const cashBalanceElement = document.getElementById('cash-balance');
    if (cashBalanceElement) {
        cashBalanceElement.textContent = formatCurrency(cashBalance);
    }
}
function addToCart(productId) {
    const product = products.find(p => p.id === productId);
    if (product) {
        const cartItem = cart.items.find(item => item.id === productId);
        if (cartItem) {
            cartItem.quantity++;
        } else {
            cart.items.push({ ...product, quantity: 1, discount: { type: 'fixed', value: 0 } });
        }
        renderCart(); 
        showToast(`'${product.name}' adicionado.`);
    }
}
function increaseCartItemQuantity(index) {
    cart.items[index].quantity++;
    renderCart();
}
function decreaseCartItemQuantity(index) {
    cart.items[index].quantity--;
    if (cart.items[index].quantity === 0) cart.items.splice(index, 1);
    renderCart();
}
function removeFromCart(index) {
    cart.items.splice(index, 1);
    renderCart();
}
function clearCart() {
    cart.items = [];
    cart.generalDiscount = { type: 'fixed', value: 0 };
    renderCart();
}
function processSale(paymentDetails) {
    if (cart.items.length === 0) return;
    const subtotal = cart.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    let totalDiscount = cart.items.reduce((sum, item) => {
        const itemTotal = item.price * item.quantity;
        return sum + (item.discount.type === 'percentage' ? (itemTotal * item.discount.value / 100) : item.discount.value);
    }, 0);
    if (cart.generalDiscount.value > 0) {
        totalDiscount += cart.generalDiscount.type === 'percentage' ? ((subtotal - totalDiscount) * cart.generalDiscount.value / 100) : cart.generalDiscount.value;
    }
    const total = subtotal - totalDiscount;
    const totalCost = cart.items.reduce((sum, item) => sum + (item.cost * item.quantity), 0);
    const customerId = document.getElementById('customer-select').value;
    
    // --- CORREÇÃO APLICADA AQUI ---
    // Trocamos .toISOString() por .getTime() ou Date.now() para usar o fuso horário local
    const saleDate = paymentDetails.isRetroactive && paymentDetails.date ? new Date(paymentDetails.date).getTime() : Date.now();

    if (paymentDetails.status === 'Pago' && !paymentDetails.isRetroactive) {
        cashBalance += total;
    }
    
    const { date, ...otherPaymentDetails } = paymentDetails;
    const transaction = { 
        id: Date.now(), 
        type: 'venda', 
        amount: total, 
        cost: totalCost, 
        description: `Venda de ${cart.items.reduce((s, i) => s + i.quantity, 0)} item(s)`, 
        date: saleDate, 
        items: [...cart.items], 
        customerId: customerId ? parseInt(customerId) : null, 
        ...otherPaymentDetails, 
        reversed: false, 
        discount: totalDiscount 
    };

    transactions.push(transaction);
    transactions.sort((a,b) => new Date(a.date) - new Date(b.date));

    if (paymentDetails.status === 'Pago') {
        showReceipt(transaction);
    }
    document.getElementById('customer-select').value = "";
    displayCustomerSummary(null); // <-- ADICIONE ESTA LINHA
    clearCart(); 
    showToast('Venda registada com sucesso!', 'success');
    saveData();
}

function processPaidSale(e) {
    e.preventDefault();
    const form = document.getElementById('payment-form');
    const method = form.elements.paymentMethod.value;
    const isRetroactive = form.elements.retroactiveSale.checked;
    const retroactiveDate = form.elements.retroactiveDate.value;
    processSale({ method: method, installments: method === 'Cartão de Crédito' ? parseInt(form.elements.paymentInstallments.value) : 1, status: 'Pago', isRetroactive, date: retroactiveDate });
    closeModal('modal-payment');
}
function processSaleAsUnpaid() {
    const form = document.getElementById('payment-form');
    const customerId = document.getElementById('customer-select').value;
    if (!customerId || parseInt(customerId) === 1) { showToast('Selecione um cliente válido (não "Cliente Balcão") para guardar como não pago.', 'error'); return; }
    const isRetroactive = form.elements.retroactiveSale.checked;
    const retroactiveDate = form.elements.retroactiveDate.value;
    processSale({ method: 'A Prazo', installments: 1, status: 'Não Pago', isRetroactive, date: retroactiveDate });
    closeModal('modal-payment');
}
function addRawMaterial(name, stock, unit, totalCost, supplier, receiptDate) {
    if (rawMaterials.some(rm => rm.name.toLowerCase() === name.toLowerCase())) { showToast('Insumo já registado!', 'error'); return; }
    rawMaterials.push({ id: Date.now(), name, stock: parseFloat(stock), unit, totalCost: parseFloat(totalCost), supplier, receiptDate });
    renderRawMaterials(); showToast('Insumo adicionado!'); saveData();
}
function addCustomer(name, contact) {
    if (customers.some(c => c.name.toLowerCase() === name.toLowerCase())) { showToast('Cliente com este nome já existe.', 'error'); return; }
    customers.push({ id: Date.now(), name, contact });
    renderCustomers(); showToast('Novo cliente adicionado!'); saveData();
}
function handleCashFlow(type, amount, description) {
    if (type === 'saida' && amount > cashBalance) { showToast('Saldo insuficiente para esta saída!', 'error'); return; }
    cashBalance += (type === 'entrada' ? amount : -amount);
    // --- CORREÇÃO APLICADA AQUI ---
    transactions.push({ id: Date.now(), type, amount, description, date: Date.now() });
    showToast(`Movimentação registada.`); saveData();
}
function deleteProduct() {
    const productId = parseInt(document.getElementById('edit-product-form').elements.productId.value);
    openConfirmationModal('Excluir Produto', 'Tem a certeza de que deseja excluir este produto? Esta ação não pode ser desfeita.', () => {
        products = products.filter(p => p.id !== productId);
        renderProducts();
        closeModal('modal-edit-produto'); showToast('Produto excluído com sucesso!'); saveData();
    });
}
function deleteRawMaterial(materialId) {
    openConfirmationModal('Excluir Insumo', 'Tem a certeza de que deseja excluir este insumo?', () => {
        rawMaterials = rawMaterials.filter(rm => rm.id !== materialId);
        renderRawMaterials(); showToast('Insumo excluído com sucesso!'); saveData();
    });
}
function deleteCustomer(customerId) {
    if (customerId === 1) { showToast('Não é possível excluir o cliente padrão.', 'error'); return; }
    if (transactions.some(t => t.customerId == customerId)) { showToast('Cliente não pode ser excluído pois está associado a vendas.', 'error'); return; }
    openConfirmationModal('Excluir Cliente', 'Tem a certeza de que deseja excluir este cliente?', () => {
        customers = customers.filter(c => c.id !== customerId);
        renderCustomers(); showToast('Cliente excluído com sucesso!'); saveData();
    });
}
function cancelSale(transactionId) {
    const sale = transactions.find(t => t.id === transactionId);
    if (!sale || sale.reversed) return;
    openConfirmationModal('Estornar Venda', 'Tem a certeza de que deseja estornar esta venda?', () => {
        if (sale.status !== 'Não Pago') cashBalance -= sale.amount;
        sale.reversed = true;
        // --- CORREÇÃO APLICADA AQUI ---
        transactions.push({ id: Date.now(), type: 'estorno', amount: -sale.amount, description: `Estorno da venda #${sale.id}`, date: Date.now() });
        renderReports(currentReportPeriod);
        showToast('Venda estornada com sucesso!'); saveData();
    });
}
function deleteTransaction(transactionId) {
    openConfirmationModal('Excluir Venda Permanentemente?', 'Esta ação é irreversível e não pode ser desfeita. A venda será apagada do histórico. Deseja continuar?', () => {
        const saleIndex = transactions.findIndex(t => t.id === transactionId);
        if (saleIndex > -1) {
            transactions.splice(saleIndex, 1);
            showToast('Venda excluída com sucesso.', 'success');
            renderReports(currentReportPeriod);
            if (!document.getElementById('modal-cliente-detalhes').classList.contains('hidden')) {
                const customerId = document.getElementById('modal-cliente-detalhes').dataset.customerId;
                openCustomerDetailsModal(customerId);
            }
            saveData();
        } else {
            showToast('Venda não encontrada.', 'error');
        }
    });
}
function resetSystem() {
    openConfirmationModal('Zerar Todo o Sistema', 'Esta ação é irreversível e apagará TODOS os dados. Deseja continuar?', () => {
        localStorage.clear();
        products = []; rawMaterials = []; customers = [{ id: 1, name: 'Cliente Balcão', contact: '' }];
        categories = [{ id: 1, name: 'Sem Categoria' }];
        transactions = []; cashBalance = 0;
        initializeAppUI();
        showToast('Sistema zerado com sucesso!', 'success');
        closeModal('modal-settings');
        saveData();
    });
}
function openModal(modalId) {
    if (modalId === 'modal-relatorios') { setReportPeriod(currentReportPeriod); renderSalesByCustomerReport(); }
    if(modalId === 'modal-contas-receber') renderUnpaidSales();
    if (modalId === 'modal-materiaprima') renderRawMaterials();
    if (modalId === 'modal-clientes') renderCustomers();
    if (modalId === 'modal-categorias') renderCategoriesManagement();
    if (modalId === 'modal-fechamento') renderCashClosingReport();
    if (modalId === 'modal-produto' || modalId === 'modal-edit-produto') populateCategoryDropdowns();
    const modal = document.getElementById(modalId);
    if (modal) { modal.classList.remove('hidden'); modal.classList.add('flex'); }
}
function closeModal(modalId) { const modal = typeof modalId === 'string' ? document.getElementById(modalId) : modalId; if (modal) { modal.classList.add('hidden'); modal.classList.remove('flex'); } }
function openEditProductModal(productId) {
    const product = products.find(p => p.id === productId); if (!product) return;
    const form = document.getElementById('edit-product-form');
    form.elements.productId.value = product.id; 
    form.elements.productName.value = product.name; 
    form.elements.productPrice.value = product.price; 
    form.elements.productCost.value = product.cost; 
    form.elements.productBarcode.value = product.barcode || '';
    populateCategoryDropdowns();
    form.elements.editProductCategory.value = product.categoryId;
    openModal('modal-edit-produto');
}
function openEditRawMaterialModal(materialId) {
    const material = rawMaterials.find(rm => rm.id === materialId); if (!material) return;
    const form = document.getElementById('edit-raw-material-form');
    form.elements.rawMaterialId.value = material.id;
    form.elements.rawMaterialName.value = material.name;
    form.elements.rawMaterialSupplier.value = material.supplier || '';
    form.elements.rawMaterialStock.value = material.stock;
    form.elements.rawMaterialUnit.value = material.unit;
    form.elements.rawMaterialTotalCost.value = material.totalCost;
    form.elements.rawMaterialReceiptDate.value = material.receiptDate ? new Date(material.receiptDate).toISOString().slice(0, 10) : '';
    openModal('modal-edit-materiaprima');
}
function openEditCustomerModal(customerId) {
    const customer = customers.find(c => c.id === customerId); if (!customer) return;
    const form = document.getElementById('edit-customer-form');
    form.elements.customerId.value = customer.id; form.elements.customerName.value = customer.name; form.elements.customerContact.value = customer.contact;
    openModal('modal-edit-cliente');
}
function openConfirmationModal(title, message, onConfirm) { document.getElementById('confirm-title').textContent = title; document.getElementById('confirm-message').textContent = message; confirmCallback = onConfirm; openModal('modal-confirm'); }
function openPaymentModal() {
    const customerId = document.getElementById('customer-select').value;
    if (!customerId) { showToast('Por favor, selecione um cliente para continuar.', 'error'); return; }
    const subtotal = cart.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    let totalDiscount = cart.items.reduce((sum, item) => {
        const itemTotal = item.price * item.quantity;
        return sum + (item.discount.type === 'percentage' ? (itemTotal * item.discount.value / 100) : item.discount.value);
    }, 0);
    if (cart.generalDiscount.value > 0) {
        totalDiscount += cart.generalDiscount.type === 'percentage' ? ((subtotal - totalDiscount) * cart.generalDiscount.value / 100) : cart.generalDiscount.value;
    }
    const total = subtotal - totalDiscount;
    document.getElementById('payment-total').textContent = formatCurrency(total);
    document.getElementById('payment-amount-paid').value = total.toFixed(2);
    document.getElementById('payment-method').value = 'Dinheiro';
    document.getElementById('installments-group').classList.add('hidden');
    document.getElementById('amount-paid-group').classList.remove('hidden');
    document.getElementById('retroactive-sale-toggle').checked = false;
    document.getElementById('retroactive-date-group').classList.add('hidden');
    document.getElementById('payment-retroactive-date').value = '';
    updateChange(); openModal('modal-payment');
}
function updateChange() { 
    const subtotal = cart.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    let totalDiscount = cart.items.reduce((sum, item) => {
        const itemTotal = item.price * item.quantity;
        return sum + (item.discount.type === 'percentage' ? (itemTotal * item.discount.value / 100) : item.discount.value);
    }, 0);
    if (cart.generalDiscount.value > 0) {
        totalDiscount += cart.generalDiscount.type === 'percentage' ? ((subtotal - totalDiscount) * cart.generalDiscount.value / 100) : cart.generalDiscount.value;
    }
    const total = subtotal - totalDiscount;
    const paid = parseFloat(document.getElementById('payment-amount-paid').value) || 0;
    document.getElementById('payment-change').textContent = formatCurrency(paid - total > 0 ? paid - total : 0); 
}
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.children[0].textContent = message;
    toast.className = `fixed bottom-5 right-5 text-white px-6 py-3 rounded-lg shadow-lg transition-all duration-300 z-[200] ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
    toast.classList.remove('opacity-0', 'translate-y-10');
    setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-10'); }, 3000);
}
function showReceipt(transaction) {
    const receiptDetails = document.getElementById('receipt-details');
    receiptDetails.innerHTML = '';
    let subtotal = 0;
    transaction.items.forEach(item => { 
        const itemTotal = item.price * item.quantity;
        subtotal += itemTotal;
        receiptDetails.innerHTML += `<div class="flex justify-between"><span>${item.quantity}x ${item.name}</span><span>${formatCurrency(itemTotal)}</span></div>`; 
        if (item.discount && item.discount.value > 0) {
            const discountValue = item.discount.type === 'percentage' ? (itemTotal * item.discount.value / 100) : item.discount.value;
            receiptDetails.innerHTML += `<div class="flex justify-between text-xs text-red-500 pl-4"><span>&nbsp;&nbsp;Desconto</span><span>-${formatCurrency(discountValue)}</span></div>`;
        }
    });
    if (transaction.discount > 0 && transaction.items.some(i => i.discount.value > 0)) {
    }
    receiptDetails.innerHTML += `<div class="mt-2 pt-2 border-t flex justify-between"><span>Subtotal</span><span>${formatCurrency(subtotal)}</span></div>`;
    receiptDetails.innerHTML += `<div class="flex justify-between text-red-500"><span>Descontos</span><span>-${formatCurrency(transaction.discount)}</span></div>`;
    receiptDetails.innerHTML += `<div class="font-semibold mt-2 pt-2 border-t border-[var(--border-color)]"><span>Forma de Pagamento:</span><span> ${transaction.method}${transaction.installments > 1 ? ` (${transaction.installments}x)` : ''}</span></div>`;
    document.getElementById('receipt-total').textContent = `TOTAL: ${formatCurrency(transaction.amount)}`;
    document.getElementById('receipt-date').textContent = new Date(transaction.date).toLocaleString('pt-BR');
    openModal('receipt-modal');
}
function applyTheme(themeName) {
    document.documentElement.setAttribute('data-theme', themeName);
    localStorage.setItem('theme', themeName);
    document.querySelectorAll('#theme-selector .theme-button').forEach(btn => btn.classList.remove('active'));
    const activeBtn = document.querySelector(`#theme-selector .theme-button[data-theme="${themeName}"]`);
    if(activeBtn) activeBtn.classList.add('active');
}
function renderUnpaidSales() {
    const list = document.getElementById('unpaid-sales-list');
    const unpaidSales = transactions.filter(t => t.type === 'venda' && t.status === 'Não Pago' && !t.reversed);
    if (unpaidSales.length === 0) { list.innerHTML = '<p class="text-center text-[var(--text-secondary)] mt-4">Nenhuma conta pendente.</p>'; return; }
    list.innerHTML = '';
    unpaidSales.forEach(sale => {
        const customer = customers.find(c => c.id == sale.customerId);
        list.innerHTML += `<div class="flex justify-between items-center p-3 border-b border-[var(--border-color)]"><div><p class="font-bold">${customer ? customer.name : 'Cliente desconhecido'}</p><p class="text-sm text-[var(--text-secondary)]">Venda de ${new Date(sale.date).toLocaleDateString('pt-BR')}</p></div><div class="text-right"><p class="font-bold text-lg text-red-500">${formatCurrency(sale.amount)}</p><button data-id="${sale.id}" class="receive-payment-btn text-sm text-green-600 hover:underline">Receber Pagamento</button></div></div>`;
    });
}
function openReceivePaymentModal(transactionId) {
    const sale = transactions.find(t => t.id === transactionId); if (!sale) return;
    const form = document.getElementById('receive-payment-form');
    form.elements.transactionId.value = sale.id;
    document.getElementById('receive-payment-total').textContent = formatCurrency(sale.amount);
    openModal('modal-receber-pagamento');
}
function handleReceivedPayment(e) {
    e.preventDefault();
    const form = document.getElementById('receive-payment-form');
    const sale = transactions.find(t => t.id == form.elements.transactionId.value); 
    if (!sale) return;

    sale.status = 'Pago';
    sale.method = form.elements.paymentMethod.value;
    sale.installments = sale.method === 'Cartão de Crédito' ? parseInt(form.elements.paymentInstallments.value) : 1;
    
    // --- CORREÇÃO APLICADA AQUI ---
    transactions.push({ 
        id: Date.now(), 
        type: 'recebimento', 
        amount: sale.amount, 
        description: `Recebimento da venda #${sale.id}`, 
        date: Date.now(), 
        method: sale.method, 
        installments: sale.installments 
    });

    cashBalance += sale.amount;
    renderUnpaidSales();
    closeModal('modal-receber-pagamento');
    showToast('Pagamento recebido com sucesso!', 'success'); 
    saveData();
}
function handleImportSales(e) {
    e.preventDefault();
    const file = document.getElementById('csv-file-input').files[0]; const logDiv = document.getElementById('import-log');
    if (!file) { showToast('Por favor, selecione um ficheiro.', 'error'); return; }
    const reader = new FileReader();
    reader.onload = function(event) {
        const rows = event.target.result.split('\n').filter(row => row.trim() !== ''); logDiv.innerHTML = '';
        let newTransactions = [];
        rows.forEach((row, index) => {
            const [dateStr, productIdStr, quantityStr, customerIdStr, paymentMethod, status] = row.split(',');
            const product = products.find(p => p.id == productIdStr); const customer = customers.find(c => c.id == customerIdStr);
            if (!dateStr || !product || !customer || !quantityStr || !paymentMethod || !status) { logDiv.innerHTML += `<p class="text-red-500">Linha ${index + 1}: Dados inválidos. (${row})</p>`; return; }
            
            // --- CORREÇÃO DEFINITIVA APLICADA AQUI ---
            // Desmontamos a data do texto para evitar erros de fuso horário na interpretação.
            const dateParts = dateStr.split(/[-T:]/);
            const year = parseInt(dateParts[0], 10);
            const month = parseInt(dateParts[1], 10) - 1; // Mês em JavaScript é de 0 a 11
            const day = parseInt(dateParts[2], 10);
            const hour = parseInt(dateParts[3], 10);
            const minute = parseInt(dateParts[4], 10);
            const localDate = new Date(year, month, day, hour, minute);
            
            newTransactions.push({ id: localDate.getTime() + index, type: 'venda', amount: product.price * parseInt(quantityStr), cost: product.cost * parseInt(quantityStr), description: `Venda importada`, date: localDate.getTime(), items: [{...product, quantity: parseInt(quantityStr)}], customerId: parseInt(customerIdStr), method: paymentMethod.trim(), installments: 1, status: status.trim(), reversed: false, discount: 0 });
        });
        transactions.push(...newTransactions);
        transactions.sort((a, b) => new Date(a.date) - new Date(b.date));
        showToast(`${newTransactions.length} vendas importadas!`, 'success');
        document.getElementById('csv-file-input').value = '';
        saveData();
    };
    reader.readAsText(file);
}

function openSaleDetailsModal(transactionId) {
    const sale = transactions.find(t => t.id === transactionId);
    if (!sale) {
        showToast("Venda não encontrada.", "error");
        return;
    }

    const contentDiv = document.getElementById('sale-details-content');
    if (!contentDiv) {
        console.error("Elemento 'sale-details-content' não foi encontrado no modal.");
        return;
    }

    // --- Monta a tabela de itens ---
    let itemsHtml = `
        <table class="w-full text-sm my-4">
            <thead>
                <tr class="border-b">
                    <th class="text-left p-1">Item</th>
                    <th class="text-center p-1">Qtd.</th>
                    <th class="text-right p-1">Preço Unit.</th>
                    <th class="text-right p-1">Total</th>
                </tr>
            </thead>
            <tbody>
    `;
    sale.items.forEach(item => {
        itemsHtml += `
            <tr>
                <td class="p-1">${item.name}</td>
                <td class="text-center p-1">${item.quantity}</td>
                <td class="text-right p-1">${formatCurrency(item.price)}</td>
                <td class="text-right p-1">${formatCurrency(item.price * item.quantity)}</td>
            </tr>
        `;
    });
    itemsHtml += '</tbody></table>';

    // --- Monta o resumo financeiro ---
    const subtotal = sale.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const profit = sale.amount - sale.cost;
    const discountValue = subtotal - sale.amount;

    // --- Monta o HTML completo para o modal ---
    contentDiv.innerHTML = `
        <div class="space-y-2 text-sm mb-4">
            <p><strong>ID da Venda:</strong> ${sale.id}</p>
            <p><strong>Data:</strong> ${new Date(sale.date).toLocaleString('pt-BR')}</p>
            <p><strong>Cliente:</strong> ${customers.find(c => c.id == sale.customerId)?.name || 'Não identificado'}</p>
        </div>
        
        ${itemsHtml}

        <div class="space-y-1 text-sm border-t pt-2">
            <div class="flex justify-between">
                <span>Subtotal:</span> 
                <span>${formatCurrency(subtotal)}</span>
            </div>
            <div class="flex justify-between text-red-600">
                <span>Descontos:</span> 
                <span>-${formatCurrency(discountValue)}</span>
            </div>
            <div class="flex justify-between font-bold text-lg border-t pt-2 mt-2">
                <span>TOTAL PAGO:</span> 
                <span>${formatCurrency(sale.amount)}</span>
            </div>
            <div class="mt-4 pt-4 border-t border-[var(--border-color)] space-y-1 text-sm">
                <div class="flex justify-between">
                    <span>Custo Total:</span> 
                    <span class="text-red-600">-${formatCurrency(sale.cost)}</span>
                </div>
                <div class="flex justify-between font-bold">
                    <span>Lucro Líquido:</span> 
                    <span class="text-green-600">${formatCurrency(profit)}</span>
                </div>
            </div>
        </div>
    `;
    
    openModal('modal-venda-detalhes');
}
function openCustomerDetailsModal(customerId) {
    const customer = customers.find(c => c.id == customerId);
    if (!customer) { showToast("Cliente não encontrado.", "error"); return; }
    document.getElementById('modal-cliente-detalhes').dataset.customerId = customerId;
    document.getElementById('details-customer-name').textContent = customer.name;
    const customerSales = transactions.filter(t => t.customerId == customerId);
    const listContainer = document.getElementById('details-customer-sales-list');
    renderTransactionList(listContainer, customerSales);
    openModal('modal-cliente-detalhes');
}
function populateMonthYearSelectors() {
    const monthSelect = document.getElementById('report-month-select');
    const yearSelect = document.getElementById('report-year-select');
    const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
    const currentYear = new Date().getFullYear();
    const currentMonth = new Date().getMonth();
    monthSelect.innerHTML = monthNames.map((m, i) => `<option value="${i}" ${i === currentMonth ? 'selected' : ''}>${m}</option>`).join('');
    yearSelect.innerHTML = '';
    for (let y = currentYear; y >= 2020; y--) {
        yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
    }
}
function renderTransactionList(container, transactionList) {
    container.innerHTML = '';
    if (transactionList.length === 0) {
        container.innerHTML = `<p class="text-center text-gray-500 mt-4">Nenhuma transação encontrada para este período.</p>`;
        return;
    }
    [...transactionList].reverse().forEach(t => {
        let color = '', icon = 'fa-question-circle', profitHtml = '', actionsHtml = '', paymentInfo = '', rowClass = '', discountHtml = '';
        if (t.type === 'venda') {
            icon = 'fa-shopping-cart';
            const profit = t.amount - (t.cost || 0);
            profitHtml = `<span class="text-xs ${profit >= 0 ? 'text-green-500' : 'text-red-500'}">Lucro: ${formatCurrency(profit)}</span>`;
            
            if (t.discount > 0) {
                discountHtml = `<div class="text-xs text-red-500">Desconto: ${formatCurrency(t.discount)}</div>`;
            }

            actionsHtml = `<button data-id="${t.id}" class="open-sale-details-btn text-xs text-blue-600 hover:underline mr-2">Detalhes</button>`;
            if (!t.reversed) {
                actionsHtml += `<button data-id="${t.id}" class="cancel-sale-btn text-xs text-yellow-600 hover:underline mr-2">Estornar</button>`;
            } else {
                actionsHtml += `<span class="text-xs text-gray-400 mr-2">Estornada</span>`;
            }
            actionsHtml += `<button data-id="${t.id}" class="edit-sale-btn text-xs text-purple-600 hover:underline">Editar</button>`;
            if (t.status === 'Não Pago') {
                paymentInfo = ` &middot; <span class="font-bold">NÃO PAGO</span>`;
                rowClass = 'bg-red-50 text-red-800';
                color = 'text-red-600';
            } else {
                color = 'text-[var(--secondary-600)]';
                if (t.method) {
                    let badgeClass = '', methodText = t.method;
                    switch (t.method) {
                        case 'Dinheiro': badgeClass = 'badge-dinheiro'; break;
                        case 'Pix': badgeClass = 'badge-pix'; break;
                        case 'Cartão de Crédito': badgeClass = 'badge-credito'; methodText = `CRÉDITO ${t.installments > 1 ? `(${t.installments}x)` : ''}`; break;
                    }
                    paymentInfo = `<span class="payment-badge ${badgeClass}">${methodText}</span>`;
                }
            }
        }
        if (t.type === 'entrada' || t.type === 'recebimento') { color = 'text-blue-600'; icon = 'fa-arrow-down'; }
        if (t.type === 'saida') { color = 'text-red-600'; icon = 'fa-arrow-up'; }
        if (t.type === 'estorno') { color = 'text-yellow-600'; icon = 'fa-undo'; }
        container.innerHTML += `<div class="flex justify-between items-center p-2 border-b border-[var(--border-color)] ${rowClass}"><div class="flex items-center gap-3"><i class="fas ${icon} ${color}"></i><div><p class="font-semibold capitalize">${t.description}</p><p class="text-sm flex items-center">${new Date(t.date).toLocaleString('pt-BR')}${paymentInfo}</p></div></div><div class="text-right"><div><p class="font-bold ${color}">${formatCurrency(t.amount)}</p>${profitHtml}${discountHtml}</div><div class="mt-1">${actionsHtml}</div></div></div>`;
    });
}

// --- FUNÇÕES DE CATEGORIA ---
function renderCategoryFilters() {
    const container = document.getElementById('category-filters');
    container.innerHTML = `<button data-category-id="all" class="category-filter-btn active px-3 py-1 text-sm border rounded-full border-[var(--border-color)]">Todas</button>`;
    categories.forEach(cat => {
        container.innerHTML += `<button data-category-id="${cat.id}" class="category-filter-btn px-3 py-1 text-sm border rounded-full border-[var(--border-color)]">${cat.name}</button>`;
    });
}

function renderCategoriesManagement() {
    const list = document.getElementById('categories-list');
    list.innerHTML = '';
    categories.forEach(cat => {
        const productCount = products.filter(p => p.categoryId === cat.id).length;
        list.innerHTML += `<div class="flex justify-between items-center p-2 border-b border-[var(--border-color)]"><p>${cat.name} <span class="text-sm text-[var(--text-secondary)]">(${productCount} produtos)</span></p><div><button data-id="${cat.id}" class="edit-category-btn text-blue-500 hover:text-blue-700 p-1"><i class="fas fa-edit"></i></button><button data-id="${cat.id}" class="delete-category-btn text-red-500 hover:text-red-700 p-1 ${cat.id === 1 ? 'hidden' : ''}"><i class="fas fa-trash"></i></button></div></div>`;
    });
}

function populateCategoryDropdowns() {
    const addSelect = document.getElementById('add-product-category');
    const editSelect = document.getElementById('edit-product-category');
    addSelect.innerHTML = '';
    editSelect.innerHTML = '';
    categories.forEach(cat => {
        addSelect.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
        editSelect.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
    });
}

function addCategory(name) {
    if (!name.trim()) { showToast('O nome da categoria não pode estar vazio.', 'error'); return; }
    if (categories.some(c => c.name.toLowerCase() === name.toLowerCase())) { showToast('Categoria já existe.', 'error'); return; }
    categories.push({ id: Date.now(), name });
    renderCategoriesManagement();
    renderCategoryFilters();
    showToast('Categoria adicionada!', 'success');
    saveData();
}

function openEditCategoryModal(categoryId) {
    const category = categories.find(c => c.id === categoryId); if (!category) return;
    const form = document.getElementById('edit-category-form');
    form.elements.categoryId.value = category.id;
    form.elements.categoryName.value = category.name;
    openModal('modal-edit-categoria');
}

function handleEditCategory(e) {
    e.preventDefault();
    const form = e.target;
    const categoryId = parseInt(form.elements.categoryId.value);
    const newName = form.elements.categoryName.value;
    const category = categories.find(c => c.id === categoryId);
    if (category) {
        category.name = newName;
        renderCategoriesManagement();
        renderCategoryFilters();
        closeModal('modal-edit-categoria');
        showToast('Categoria atualizada!', 'success');
        saveData();
    }
}

function deleteCategory(categoryId) {
    if (categoryId === 1) { showToast('Não pode excluir a categoria padrão.', 'error'); return; }
    openConfirmationModal('Excluir Categoria?', 'Os produtos nesta categoria serão movidos para "Sem Categoria". Deseja continuar?', () => {
        products.forEach(p => { if (p.categoryId === categoryId) p.categoryId = 1; });
        categories = categories.filter(c => c.id !== categoryId);
        renderCategoriesManagement();
        renderCategoryFilters();
        renderProducts();
        showToast('Categoria excluída.', 'success');
        saveData();
    });
}

// --- FUNÇÕES DE BACKUP E RESTAURAÇÃO ---
function exportAllData() {
    const allData = { products, customers, transactions, cashBalance, rawMaterials, categories, theme: document.documentElement.getAttribute('data-theme'), backupDate: new Date().toISOString() };
    const dataStr = JSON.stringify(allData, null, 2); 
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob); const a = document.createElement('a');
    a.href = url; a.download = `backup-sistema-papelaria-${new Date().toISOString().slice(0, 10)}.json`; 
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url); showToast("Backup exportado com sucesso!", "success");
}
function importAllData(event) {
    const file = event.target.files[0]; if (!file) { showToast("Nenhum ficheiro selecionado.", "error"); return; }
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            if (importedData.products && importedData.transactions && importedData.customers) {
                openConfirmationModal('Restaurar Backup?', 'Isto substituirá TODOS os dados atuais. Esta ação é irreversível. Deseja continuar?', () => {
                    products = importedData.products || []; customers = importedData.customers || []; transactions = importedData.transactions || [];
                    cashBalance = importedData.cashBalance || 0; rawMaterials = importedData.rawMaterials || []; categories = importedData.categories || [{ id: 1, name: 'Sem Categoria' }];
                    if (importedData.theme) applyTheme(importedData.theme);
                    saveData(); initializeAppUI(); 
                    showToast("Backup restaurado com sucesso!", "success"); closeModal('modal-settings');
                });
            } else { showToast("O ficheiro selecionado não parece ser um backup válido.", "error"); }
        } catch (error) { showToast("Erro ao ler o ficheiro de backup.", "error"); } 
        finally { event.target.value = ''; }
    };
    reader.readAsText(file);
}
function saveToGoogleSheets(isAuto = false) {
    if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL === 'COLE_A_URL_DO_SEU_APP_DA_WEB_AQUI') {
        if (!isAuto) showToast("URL do Google Script não configurada.", "error");
        return;
    }
    if (!isAuto) { showToast("A guardar na nuvem... Aguarde.", "success"); toggleLoading(true); }
    
    try {
        const allData = { products, customers, rawMaterials, transactions, cashBalance, categories };
        const cleanDataString = JSON.stringify(allData);

        fetch(GOOGLE_SCRIPT_URL, { 
            method: 'POST', 
            mode: 'no-cors', 
            cache: 'no-cache', 
            headers: { 'Content-Type': 'application/json' }, 
            body: cleanDataString,
            keepalive: true 
        })
        .then(() => {
            if (!isAuto) { showToast("Dados enviados para a nuvem com sucesso!", "success"); }
            console.log("Save to cloud successful at " + new Date().toLocaleTimeString());
        })
        .catch(error => {
            if (!isAuto) { showToast("Falha ao guardar na nuvem. Verifique a sua conexão.", "error"); }
            console.error('Error saving to cloud:', error);
        })
        .finally(() => { if (!isAuto) { toggleLoading(false); } });
    } catch (error) {
        if (!isAuto) {
            toggleLoading(false);
            showToast("Erro ao preparar dados para salvar. Verifique o console (F12).", "error");
        }
        console.error("Erro ao converter dados para JSON antes de salvar:", error);
    }
}
function loadFromGoogleSheets(isAuto = false) {
    if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL === 'COLE_A_URL_DO_SEU_APP_DA_WEB_AQUI') {
        if (isAuto) {
            loadDataFromLocalStorage();
        } else {
            showToast("URL do Google Script não configurada.", "error");
        }
        return;
    }

    const execution = () => {
        if (!isAuto) showToast("A carregar dados da nuvem... Aguarde.", "success");
        toggleLoading(true);
        fetch(GOOGLE_SCRIPT_URL)
            .then(response => {
                if (!response.ok) { throw new Error(`Erro de rede: ${response.statusText} (Status: ${response.status})`) }
                return response.json();
            })
            .then(data => {
                if (data.status === 'error') {
                    throw new Error(`Erro retornado pelo Google Script: ${data.message}`);
                }
                
                if (data && typeof data === 'object' && Array.isArray(data.customers)) {
                    products = data.products || [];
                    customers = data.customers || [];
                    transactions = data.transactions || [];
                    cashBalance = data.cashBalance || 0;
                    rawMaterials = data.rawMaterials || [];
                    categories = data.categories || [{ id: 1, name: 'Sem Categoria' }];
                    
                    transactions.forEach(t => {
                        if (t.customerid !== undefined) {
                            t.customerId = t.customerid;
                            delete t.customerid;
                        }
                    });

                    saveData(); 
                    initializeAppUI();
                    
                    if (!isAuto) closeModal('modal-settings');
                    showToast("Dados carregados da nuvem com sucesso!", "success");
                } else {
                    throw new Error("Dados da nuvem estão em formato inválido ou corrompidos.");
                }
            })
            .catch(error => {
                console.error('Falha detalhada ao carregar do Google Sheets:', error);
                showToast(`Falha ao carregar: ${error.message}. A usar dados locais.`, "error");
                if (isAuto) loadDataFromLocalStorage();
            })
            .finally(() => { toggleLoading(false); });
    };

    if (isAuto) {
        execution();
    } else {
        openConfirmationModal('Carregar Dados da Nuvem?', 'Isto substituirá TODOS os dados atuais...', execution);
    }
}

function manageAutoSaveInterval(enable) {
    const TWO_MINUTES = 120000;
    if (autoSaveInterval) clearInterval(autoSaveInterval);
    autoSaveInterval = null;
    if (enable) {
        isAutoSaveEnabled = true;
        autoSaveInterval = setInterval(() => saveToGoogleSheets(true), TWO_MINUTES);
        console.log("Auto-save started. Saving every 2 minutes.");
    } else {
        isAutoSaveEnabled = false;
        console.log("Auto-save stopped.");
    }
}

function handleAutoSaveToggle(event) {
    const enabled = event.target.checked;
    manageAutoSaveInterval(enabled);
    localStorage.setItem('isAutoSaveEnabled', JSON.stringify(enabled));
    showToast(`Guardar automaticamente ${enabled ? 'ativado' : 'desativado'}.`, "success");
}

function handleAutoLoadToggle(event) {
    isAutoLoadEnabled = event.target.checked;
    localStorage.setItem('isAutoLoadEnabled', JSON.stringify(isAutoLoadEnabled));
    showToast(`Carregamento automático ao iniciar ${isAutoLoadEnabled ? 'ativado' : 'desativado'}.`, "success");
}

// --- LÓGICA DE EDIÇÃO DE VENDA ---
function openEditSaleModal(transactionId) {
    const sale = transactions.find(t => t.id === transactionId);
    if (!sale) {
        showToast("Venda não encontrada.", "error");
        return;
    }

    const form = document.getElementById('edit-sale-form');
    form.elements.transactionId.value = sale.id;
    document.getElementById('edit-sale-total').textContent = formatCurrency(sale.amount);
    form.elements.saleStatus.value = sale.status;
    form.elements.paymentMethod.value = sale.method || 'A Prazo';
    form.elements.paymentInstallments.value = sale.installments || 1;

    const installmentsGroup = document.getElementById('edit-installments-group');
    installmentsGroup.classList.toggle('hidden', form.elements.paymentMethod.value !== 'Cartão de Crédito');

    openModal('modal-edit-venda');
}

function handleEditSale(e) {
    e.preventDefault();
    const form = document.getElementById('edit-sale-form');
    const transactionId = parseInt(form.elements.transactionId.value);
    const sale = transactions.find(t => t.id === transactionId);

    if (!sale) {
        showToast("Erro: Venda não encontrada.", "error");
        closeModal('modal-edit-venda');
        return;
    }

    const oldStatus = sale.status;
    const newStatus = form.elements.saleStatus.value;
    const newMethod = form.elements.paymentMethod.value;
    const newInstallments = parseInt(form.elements.paymentInstallments.value) || 1;

    if (oldStatus === 'Não Pago' && newStatus === 'Pago') {
        cashBalance += sale.amount;
    } else if (oldStatus === 'Pago' && newStatus === 'Não Pago') {
        cashBalance -= sale.amount;
    }

    sale.status = newStatus;
    sale.method = newMethod;
    sale.installments = newInstallments;

    updateCashBalance();
    showToast("Venda atualizada com sucesso!", "success");
    closeModal('modal-edit-venda');
    
    if (!document.getElementById('modal-relatorios').classList.contains('hidden')) {
        renderReports(currentReportPeriod);
    }
    if (!document.getElementById('modal-cliente-detalhes').classList.contains('hidden')) {
        const customerId = document.getElementById('modal-cliente-detalhes').dataset.customerId;
        openCustomerDetailsModal(customerId);
    }
     if (!document.getElementById('modal-contas-receber').classList.contains('hidden')) {
         renderUnpaidSales();
    }

    saveData();
}

function switchView(viewId) {
    document.getElementById('dashboard-view').classList.add('hidden');
    document.getElementById('pos-view').classList.add('hidden');
    document.getElementById(viewId).classList.remove('hidden');
    document.querySelectorAll('.sidebar-item').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.view === viewId) {
            btn.classList.add('active');
        }
    });
    if (viewId === 'dashboard-view') {
        renderDashboard();
    }
    if (viewId === 'pos-view') {
        renderCategoryFilters();
    }
}

function renderDashboard() {
    // Define o início e o fim do dia no fuso horário local
    const startOfToday = new Date();
    startOfToday.setHours(0, 0, 0, 0);
    const endOfToday = new Date();
    endOfToday.setHours(23, 59, 59, 999);

    const todaysTransactions = transactions.filter(t => 
        t.date >= startOfToday.getTime() && 
        t.date <= endOfToday.getTime() &&
        t.type === 'venda' && !t.reversed
    );
    
    const salesToday = todaysTransactions.reduce((sum, t) => sum + t.amount, 0);
    const profitToday = todaysTransactions.reduce((sum, t) => sum + (t.amount - (t.cost || 0)), 0);
    const unpaidAmount = transactions.filter(t => t.status === 'Não Pago' && !t.reversed).reduce((sum, t) => sum + t.amount, 0);

    const salesCountToday = todaysTransactions.length;
    const averageTicket = salesCountToday > 0 ? salesToday / salesCountToday : 0;

    document.getElementById('kpi-sales-today').textContent = formatCurrency(salesToday);
    document.getElementById('kpi-profit-today').textContent = formatCurrency(profitToday);
    document.getElementById('kpi-unpaid').textContent = formatCurrency(unpaidAmount);
    document.getElementById('kpi-avg-ticket').textContent = formatCurrency(averageTicket);

    const recentTransactionsList = document.getElementById('recent-transactions-list');
    renderTransactionList(recentTransactionsList, transactions.slice(-5));
}


function openDiscountModal(itemIndex) {
    const form = document.getElementById('discount-form');
    form.reset();
    const title = document.getElementById('discount-modal-title');
    form.elements.itemIndex.value = itemIndex !== undefined ? itemIndex : '';
    if (itemIndex !== undefined) {
        title.textContent = `Desconto em ${cart.items[itemIndex].name}`;
        const currentDiscount = cart.items[itemIndex].discount;
        form.elements.discountType.value = currentDiscount.type;
        form.elements.discountValue.value = currentDiscount.value > 0 ? currentDiscount.value : '';
    } else {
        title.textContent = 'Desconto Geral na Venda';
        const currentDiscount = cart.generalDiscount;
        form.elements.discountType.value = currentDiscount.type;
        form.elements.discountValue.value = currentDiscount.value > 0 ? currentDiscount.value : '';
    }
    openModal('modal-desconto');
}

function handleDiscountForm(e) {
    e.preventDefault();
    const form = e.target;
    const itemIndex = form.elements.itemIndex.value;
    const type = form.elements.discountType.value;
    const value = parseFloat(form.elements.discountValue.value) || 0;

    if (itemIndex !== '') {
        cart.items[parseInt(itemIndex)].discount = { type, value };
    } else {
        cart.generalDiscount = { type, value };
    }
    renderCart();
    closeModal('modal-desconto');
}

// --- CENTRAL DE EVENT LISTENERS (VERSÃO CORRIGIDA E ROBUSTA) ---
function addEventListeners() {
    // Função auxiliar para adicionar listeners de forma segura
    const safeAddListener = (id, event, handler) => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener(event, handler);
        } else {
            console.warn(`Elemento com ID "${id}" não encontrado para adicionar evento.`);
        }
    };

    // --- Formulários ---

    safeAddListener('customer-select', 'change', (e) => {
        displayCustomerSummary(e.target.value);
    });
    safeAddListener('add-product-form', 'submit', function(e) {
        e.preventDefault();
        addProduct(this.elements.productName.value, this.elements.productPrice.value, this.elements.productCost.value, this.elements.productCategory.value, this.elements.productBarcode.value);
        this.reset();
        closeModal('modal-produto');
    });

    safeAddListener('edit-product-form', 'submit', function(e) {
        e.preventDefault();
        const p = products.find(p => p.id == this.elements.productId.value);
        if (p) {
            const newBarcode = this.elements.productBarcode.value.trim();
            if (newBarcode && products.some(prod => prod.barcode === newBarcode && prod.id != p.id)) {
                showToast('Este código de barras já está associado a outro produto!', 'error');
                return;
            }
            Object.assign(p, { name: this.elements.productName.value, price: parseFloat(this.elements.productPrice.value), cost: parseFloat(this.elements.productCost.value), categoryId: parseInt(this.elements.editProductCategory.value), barcode: newBarcode });
            renderProducts();
            const editProductListModal = document.getElementById('modal-edit-product-list');
            if (editProductListModal && !editProductListModal.classList.contains('hidden')) {
                renderProductEditList();
            }
            closeModal('modal-edit-produto');
            showToast('Produto atualizado!');
            saveData();
        }
    });
    
    safeAddListener('add-category-form', 'submit', function(e) { e.preventDefault(); addCategory(this.elements.categoryName.value); this.reset(); });
    safeAddListener('edit-category-form', 'submit', handleEditCategory);
    safeAddListener('add-raw-material-form', 'submit', function(e) { e.preventDefault(); addRawMaterial(this.elements.rawMaterialName.value, this.elements.rawMaterialStock.value, this.elements.rawMaterialUnit.value, this.elements.rawMaterialTotalCost.value, this.elements.rawMaterialSupplier.value, this.elements.rawMaterialReceiptDate.value); this.reset(); });
    safeAddListener('edit-raw-material-form', 'submit', function(e) { e.preventDefault(); const item = rawMaterials.find(rm => rm.id == this.elements.rawMaterialId.value); if(item) { Object.assign(item, { name: this.elements.rawMaterialName.value, supplier: this.elements.rawMaterialSupplier.value, stock: parseFloat(this.elements.rawMaterialStock.value), unit: this.elements.rawMaterialUnit.value, totalCost: parseFloat(this.elements.rawMaterialTotalCost.value), receiptDate: this.elements.rawMaterialReceiptDate.value }); renderRawMaterials(); closeModal('modal-edit-materiaprima'); showToast('Item de estoque atualizado!'); saveData(); } });
    safeAddListener('add-customer-form', 'submit', function(e) { e.preventDefault(); addCustomer(this.elements.customerName.value, this.elements.customerContact.value); this.reset(); });
    safeAddListener('edit-customer-form', 'submit', function(e) { e.preventDefault(); const c = customers.find(c => c.id == this.elements.customerId.value); if(c) { Object.assign(c, { name: this.elements.customerName.value, contact: this.elements.customerContact.value }); renderCustomers(); closeModal('modal-edit-cliente'); showToast('Cliente atualizado!'); saveData(); } });
    safeAddListener('payment-form', 'submit', processPaidSale);
    safeAddListener('receive-payment-form', 'submit', handleReceivedPayment);
    safeAddListener('edit-sale-form', 'submit', handleEditSale);
    safeAddListener('discount-form', 'submit', handleDiscountForm);
    safeAddListener('import-sales-form', 'submit', handleImportSales);

    // --- Barras de Pesquisa e Botões Principais ---
    safeAddListener('search-barcode', 'change', function(e) {
        const barcode = e.target.value.trim();
        addByBarcode(barcode);
        e.target.value = '';
    });
    safeAddListener('checkout-button', 'click', openPaymentModal);
    safeAddListener('clear-cart-button', 'click', clearCart);
    safeAddListener('search-product', 'input', (e) => {
        const activeCategory = document.querySelector('.category-filter-btn.active');
        renderProducts(e.target.value, activeCategory ? activeCategory.dataset.categoryId : 'all');
    });
    safeAddListener('open-settings-modal-btn', 'click', () => openModal('modal-settings'));
    safeAddListener('kpi-card-unpaid', 'click', () => openModal('modal-contas-receber'));
    safeAddListener('search-edit-product', 'input', function(e) { renderProductEditList(e.target.value); });
    
    // --- Listener da Grelha de Produtos ---
    safeAddListener('product-grid', 'click', function(e) {
        const target = e.target;
        const editButton = target.closest('.edit-product-btn');
        if (editButton) {
            e.stopPropagation();
            const productId = parseInt(editButton.dataset.id);
            if (productId) openEditProductModal(productId);
            return;
        }
        const cardAction = target.closest('[data-action="add-to-cart"]');
        if (cardAction) {
            const productId = parseInt(cardAction.dataset.id);
            if (productId) addToCart(productId);
        }
    });

    // --- Modais e Ações Gerais ---
    document.querySelectorAll('.open-modal-btn').forEach(btn => btn.addEventListener('click', () => openModal(btn.dataset.modalId)));
    document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
        backdrop.addEventListener('click', (e) => {
            if (e.target === backdrop) closeModal(backdrop.id);
        });
    });
    document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', (e) => closeModal(e.target.closest('.modal-backdrop').id)));
    
    // --- Outros Botões e Seletores ---
    safeAddListener('confirm-cancel-btn', 'click', () => closeModal('modal-confirm'));
    safeAddListener('confirm-confirm-btn', 'click', () => { if (typeof confirmCallback === 'function') confirmCallback(); closeModal('modal-confirm'); });
    safeAddListener('reset-system-btn', 'click', resetSystem);
    safeAddListener('theme-selector', 'click', (e) => { const btn = e.target.closest('.theme-button'); if (btn) applyTheme(btn.dataset.theme); });
    safeAddListener('export-data-btn', 'click', exportAllData);
    safeAddListener('import-file-input', 'change', importAllData);
    safeAddListener('save-to-google-sheets-btn', 'click', () => saveToGoogleSheets(false));
    safeAddListener('load-from-google-sheets-btn', 'click', () => loadFromGoogleSheets(false));
    safeAddListener('autosave-toggle', 'change', handleAutoSaveToggle);
    safeAddListener('autoload-toggle', 'change', handleAutoLoadToggle);
    window.addEventListener('beforeunload', () => { if (isAutoSaveEnabled) { saveToGoogleSheets(true); } });
    safeAddListener('payment-method', 'change', function() { document.getElementById('installments-group').classList.toggle('hidden', this.value !== 'Cartão de Crédito'); document.getElementById('amount-paid-group').classList.toggle('hidden', this.value === 'Cartão de Crédito'); });
    safeAddListener('receive-payment-method', 'change', function() { document.getElementById('receive-installments-group').classList.toggle('hidden', this.value !== 'Cartão de Crédito'); });
    safeAddListener('edit-sale-method', 'change', function() { document.getElementById('edit-installments-group').classList.toggle('hidden', this.value !== 'Cartão de Crédito'); });
    safeAddListener('payment-amount-paid', 'input', updateChange);
    safeAddListener('process-unpaid-sale-btn', 'click', processSaleAsUnpaid);
    safeAddListener('apply-general-discount-btn', 'click', () => openDiscountModal());
    safeAddListener('retroactive-sale-toggle', 'change', function() { document.getElementById('retroactive-date-group').classList.toggle('hidden', !this.checked); });
    safeAddListener('print-receipt-btn', 'click', window.print);
    safeAddListener('print-details-btn', 'click', window.print);
    safeAddListener('report-month-select', 'change', () => renderReports('monthly', document.getElementById('report-month-select').value, document.getElementById('report-year-select').value));
    safeAddListener('report-year-select', 'change', () => renderReports('monthly', document.getElementById('report-month-select').value, document.getElementById('report-year-select').value));
    
    // --- Delegação de eventos para botões dinâmicos ---
    document.body.addEventListener('click', e => {
        const target = e.target.closest('button, tr');
        if (!target) return;

        const classList = target.classList;
        const dataset = target.dataset;

        if (classList.contains('edit-product-btn') && !target.closest('.product-card')) {
            openEditProductModal(parseInt(dataset.id));
        } else if (classList.contains('increase-qty-btn')) {
            increaseCartItemQuantity(dataset.index);
        } else if (classList.contains('decrease-qty-btn')) {
            decreaseCartItemQuantity(dataset.index);
        } else if (classList.contains('remove-from-cart-btn')) {
            removeFromCart(dataset.index);
        } else if (target.id === 'delete-product-btn') {
            deleteProduct();
        } else if (classList.contains('edit-category-btn')) {
            openEditCategoryModal(parseInt(dataset.id));
        } else if (classList.contains('delete-category-btn')) {
            deleteCategory(parseInt(dataset.id));
        } else if (classList.contains('edit-stock-item-btn')) {
            openEditRawMaterialModal(parseInt(dataset.id));
        } else if (classList.contains('delete-stock-item-btn')) {
            deleteRawMaterial(parseInt(dataset.id));
        } else if (classList.contains('edit-customer-btn')) {
            openEditCustomerModal(parseInt(dataset.id));
        } else if (classList.contains('delete-customer-btn')) {
            deleteCustomer(parseInt(dataset.id));
        } else if (classList.contains('open-sale-details-btn')) {
            openSaleDetailsModal(parseInt(dataset.id));
        } else if (classList.contains('cancel-sale-btn')) {
            cancelSale(parseInt(dataset.id));
        } else if (classList.contains('delete-sale-btn')) {
            deleteTransaction(parseInt(dataset.id));
        } else if (classList.contains('edit-sale-btn')) {
            openEditSaleModal(parseInt(dataset.id));
        } else if (classList.contains('receive-payment-btn')) {
            openReceivePaymentModal(parseInt(dataset.id));
        } else if (classList.contains('tab-button')) {
            switchTab(dataset.tab);
        } else if (classList.contains('period-button')) {
            setReportPeriod(dataset.period);
        } else if (classList.contains('customer-details-row')) {
            openCustomerDetailsModal(dataset.customerId);
        } else if (classList.contains('sidebar-item') || classList.contains('quick-action-btn')) {
            switchView(dataset.view);
        } else if (classList.contains('apply-item-discount-btn')) {
            openDiscountModal(parseInt(dataset.index));
        } else if (classList.contains('category-filter-btn')) {
            document.querySelectorAll('.category-filter-btn').forEach(btn => btn.classList.remove('active'));
            target.classList.add('active');
            renderProducts(document.getElementById('search-product').value, dataset.categoryId);
        }
    });
    // --- Lógica para o menu hambúrguer responsivo ---
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    
    const openSidebar = () => {
        sidebar.classList.remove('-translate-x-full');
        overlay.classList.remove('hidden');
    };
    
    const closeSidebar = () => {
        sidebar.classList.add('-translate-x-full');
        overlay.classList.add('hidden');
    };

    safeAddListener('hamburger-btn', 'click', openSidebar);
    safeAddListener('sidebar-overlay', 'click', closeSidebar);
    
    // Adiciona um listener para fechar o sidebar ao clicar em um item
    sidebar.addEventListener('click', (e) => {
        if (e.target.closest('.sidebar-item')) {
            // Apenas fecha em telas pequenas onde o overlay está visível
            if (!overlay.classList.contains('hidden')) {
                closeSidebar();
            }
        }
    });
}
</script>
</body>
</html>
